---
title: "ASP.NET Core 模块"
author: tdykstra
description: "介绍 ASP.NET Core 模块 (ANCM)，该模块是一种可使 Kestrel Web 服务器将 IIS 或 IIS Express 用作反向代理服务器的 IIS 模块。"
manager: wpickett
ms.author: tdykstra
ms.custom: H1Hack27Feb2017
ms.date: 08/03/2017
ms.prod: asp.net-core
ms.technology: aspnet
ms.topic: article
uid: fundamentals/servers/aspnet-core-module
ms.openlocfilehash: 4337bc42c5454d6a9634a396d9c89f3518af148b
ms.sourcegitcommit: a510f38930abc84c4b302029d019a34dfe76823b
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 01/30/2018
---
# <a name="introduction-to-aspnet-core-module"></a><span data-ttu-id="4a6c7-103">ASP.NET Core 模块简介</span><span class="sxs-lookup"><span data-stu-id="4a6c7-103">Introduction to ASP.NET Core Module</span></span>

<span data-ttu-id="4a6c7-104">作者：[Tom Dykstra](https://github.com/tdykstra)、[Rick Strahl](https://github.com/RickStrahl) 和 [Chris Ross](https://github.com/Tratcher)</span><span class="sxs-lookup"><span data-stu-id="4a6c7-104">By [Tom Dykstra](https://github.com/tdykstra), [Rick Strahl](https://github.com/RickStrahl), and [Chris Ross](https://github.com/Tratcher)</span></span> 

<span data-ttu-id="4a6c7-105">ASP.NET Core 模块 (ANCM) 允许在 IIS 背后运行 ASP.NET Core 应用程序，将 IIS 用于 IIS 所擅长的领域（安全性、可管理性等），将 [Kestrel](kestrel.md) 用于 Kestrel 所擅长的领域（速度快），让你同时从这两种技术中获益。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-105">ASP.NET Core Module (ANCM) lets you run ASP.NET Core applications behind IIS, using IIS for what it's good at (security, manageability, and lots more) and using [Kestrel](kestrel.md) for what it's good at (being really fast), and getting the benefits from both technologies at once.</span></span> <span data-ttu-id="4a6c7-106">ANCM 仅适用于 Kestrel；它不与 WebListener（ASP.NET Core 1.x 版本）或 HTTP.sys（2.x 版本）兼容。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-106">**ANCM works only with Kestrel; it isn't compatible with WebListener (in ASP.NET Core 1.x) or HTTP.sys (in 2.x).**</span></span> 

<span data-ttu-id="4a6c7-107">受支持的 Windows 版本：</span><span class="sxs-lookup"><span data-stu-id="4a6c7-107">Supported Windows versions:</span></span>

* <span data-ttu-id="4a6c7-108">Windows 7 和 Windows Server 2008 R2 及更高版本</span><span class="sxs-lookup"><span data-stu-id="4a6c7-108">Windows 7 and Windows Server 2008 R2 and later</span></span>

<span data-ttu-id="4a6c7-109">[查看或下载示例代码](https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/servers/aspnet-core-module/sample)（[如何下载](xref:tutorials/index#how-to-download-a-sample)）</span><span class="sxs-lookup"><span data-stu-id="4a6c7-109">[View or download sample code](https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/servers/aspnet-core-module/sample) ([how to download](xref:tutorials/index#how-to-download-a-sample))</span></span>

## <a name="what-aspnet-core-module-does"></a><span data-ttu-id="4a6c7-110">ASP.NET Core 模块的作用</span><span class="sxs-lookup"><span data-stu-id="4a6c7-110">What ASP.NET Core Module does</span></span>

<span data-ttu-id="4a6c7-111">ANCM 是一种挂钩到 IIS 管道并将流量重定向到后端 ASP.NET Core 应用程序的本机 IIS 模块。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-111">ANCM is a native IIS module that hooks into the IIS pipeline and redirects traffic to the backend ASP.NET Core application.</span></span> <span data-ttu-id="4a6c7-112">大多数其他模块（如 Windows 身份验证）仍有机会运行。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-112">Most other modules, such as windows authentication, still get a chance to run.</span></span> <span data-ttu-id="4a6c7-113">仅当为请求选择了处理程序，且处理程序映射在应用程序 web.config 文件中定义时，ANCM 才进行掌控。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-113">ANCM only takes control when a handler is selected for the request, and handler mapping is defined in the application *web.config* file.</span></span>

<span data-ttu-id="4a6c7-114">由于 ASP.NET Core 应用程序在独立于 IIS 工作进程的进程中运行，因此，ANCM 还执行进程管理。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-114">Because ASP.NET Core applications run in a process separate from the IIS worker process, ANCM also does process management.</span></span> <span data-ttu-id="4a6c7-115">当第一个请求传入时，ANCM 启动 ASP.NET Core 应用程序进程，并在进程崩溃时重新启动进程。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-115">ANCM starts the process for the ASP.NET Core application when the first request comes in and restarts it when it crashes.</span></span> <span data-ttu-id="4a6c7-116">这本质上是与在 IIS 中进行进程内运行并由 WAS（Windows 激活服务）托管的经典 ASP.NET 应用程序相同的行为。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-116">This is essentially the same behavior as classic ASP.NET applications that run in-process in IIS and are managed by WAS (Windows Activation Service).</span></span>

<span data-ttu-id="4a6c7-117">下图阐释了 IIS、ANCM 和 ASP.NET Core 应用程序之间的关系。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-117">Here's a diagram that illustrates the relationship between IIS, ANCM, and ASP.NET Core applications.</span></span>

![ASP.NET Core 模块](aspnet-core-module/_static/ancm.png)

<span data-ttu-id="4a6c7-119">请求来自 Web 并命中内核模式 Http.Sys 驱动程序，该驱动程序在主要端口 (80) 或 SSL 端口 (443) 上将请求路由到 IIS。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-119">Requests come in from the Web and hit the kernel mode Http.Sys driver which routes them into IIS on the primary port (80) or SSL port (443).</span></span> <span data-ttu-id="4a6c7-120">ANCM 在针对应用程序配置的 HTTP 端口（不是端口 80/443）上将请求转发到 ASP.NET Core 应用程序。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-120">ANCM forwards the requests to the ASP.NET Core application on the HTTP port configured for the application, which isn't port 80/443.</span></span>

<span data-ttu-id="4a6c7-121">Kestrel 侦听来自 ANCM 的流量。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-121">Kestrel listens for traffic coming from ANCM.</span></span>  <span data-ttu-id="4a6c7-122">ANCM 在启动时通过环境变量指定端口，且 [UseIISIntegration](#call-useiisintegration) 方法将服务器配置来侦听 `http://localhost:{port}`。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-122">ANCM specifies the port via environment variable at startup, and the [UseIISIntegration](#call-useiisintegration) method configures the server to listen on `http://localhost:{port}`.</span></span> <span data-ttu-id="4a6c7-123">存在其他一些检查，拒绝不是来自 ANCM 的请求。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-123">There are additional checks to reject requests not from ANCM.</span></span> <span data-ttu-id="4a6c7-124">（ANCM 不支持 HTTPS 转发，因此即使请求由 IIS 通过 HTTPS 接收，它们还是通过 HTTP 转发。）</span><span class="sxs-lookup"><span data-stu-id="4a6c7-124">(ANCM doesn't support HTTPS forwarding, so requests are forwarded over HTTP even if received by IIS over HTTPS.)</span></span>

<span data-ttu-id="4a6c7-125">Kestrel 从 ANCM 获取请求，并将请求推送到 ASP.NET Core 中间件管道，然后该管道将对请求进行处理，并将其作为 `HttpContext` 实例传递到应用程序逻辑。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-125">Kestrel picks up requests from ANCM and pushes them into the ASP.NET Core middleware pipeline, which then handles them and passes them on as `HttpContext` instances to application logic.</span></span> <span data-ttu-id="4a6c7-126">接着，应用程序的响应被传递回 IIS，IIS 将响应推送回启动请求的 HTTP 客户端。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-126">The application's responses are then passed back to IIS, which pushes them back out to the HTTP client that initiated the requests.</span></span>

<span data-ttu-id="4a6c7-127">ANCM 还具有几项其他功能：</span><span class="sxs-lookup"><span data-stu-id="4a6c7-127">ANCM has a few other functions as well:</span></span>

* <span data-ttu-id="4a6c7-128">设置环境变量。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-128">Sets environment variables.</span></span>
* <span data-ttu-id="4a6c7-129">将 `stdout` 输出记录到文件存储。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-129">Logs `stdout` output to file storage.</span></span>
* <span data-ttu-id="4a6c7-130">转发 Windows 身份验证令牌。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-130">Forwards Windows authentication tokens.</span></span>

## <a name="how-to-use-ancm-in-aspnet-core-apps"></a><span data-ttu-id="4a6c7-131">如何在 ASP.NET Core 应用中使用 ANCM</span><span class="sxs-lookup"><span data-stu-id="4a6c7-131">How to use ANCM in ASP.NET Core apps</span></span>

<span data-ttu-id="4a6c7-132">本部分概述设置 IIS 服务器和 ASP.NET Core 应用程序的过程。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-132">This section provides an overview of the process for setting up an IIS server and ASP.NET Core application.</span></span> <span data-ttu-id="4a6c7-133">有关详细说明，请参阅[使用 IIS 在 Windows 上进行托管](xref:host-and-deploy/iis/index)。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-133">For detailed instructions, see [Host on Windows with IIS](xref:host-and-deploy/iis/index).</span></span>

### <a name="install-ancm"></a><span data-ttu-id="4a6c7-134">安装 ANCM</span><span class="sxs-lookup"><span data-stu-id="4a6c7-134">Install ANCM</span></span>


<span data-ttu-id="4a6c7-135">必须在服务器上的 IIS 中和开发计算机上 IIS Express 中安装 ASP.NET Core 模块。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-135">The ASP.NET Core Module has to be installed in IIS on your servers and in IIS Express on your development machines.</span></span> <span data-ttu-id="4a6c7-136">对于服务器，ANCM 包括在 [.NET Core Windows 服务器主机捆绑包](https://aka.ms/dotnetcore-2-windowshosting)中。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-136">For servers, ANCM is included in the [.NET Core Windows Server Hosting bundle](https://aka.ms/dotnetcore-2-windowshosting).</span></span> <span data-ttu-id="4a6c7-137">对于开发计算机，Visual Studio 在 IIS Express 和 IIS（如果计算机上未安装 IIS Express）中自动安装 ANCM。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-137">For development machines, Visual Studio automatically installs ANCM in IIS Express, and in IIS if it's already installed on the machine.</span></span>

### <a name="install-the-iisintegration-nuget-package"></a><span data-ttu-id="4a6c7-138">安装 IISIntegration NuGet 包</span><span class="sxs-lookup"><span data-stu-id="4a6c7-138">Install the IISIntegration NuGet package</span></span>

# <a name="aspnet-core-2xtabaspnetcore2x"></a>[<span data-ttu-id="4a6c7-139">ASP.NET Core 2.x</span><span class="sxs-lookup"><span data-stu-id="4a6c7-139">ASP.NET Core 2.x</span></span>](#tab/aspnetcore2x)

<span data-ttu-id="4a6c7-140">[Microsoft.AspNetCore.Server.IISIntegration](https://www.nuget.org/packages/Microsoft.AspNetCore.Server.IISIntegration/) 包随附于 ASP.NET Core 元包（[Microsoft.AspNetCore](https://www.nuget.org/packages/Microsoft.AspNetCore/) 和 [Microsoft.AspNetCore.All](xref:fundamentals/metapackage)）中。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-140">The [Microsoft.AspNetCore.Server.IISIntegration](https://www.nuget.org/packages/Microsoft.AspNetCore.Server.IISIntegration/) package is included in the ASP.NET Core metapackages ([Microsoft.AspNetCore](https://www.nuget.org/packages/Microsoft.AspNetCore/) and [Microsoft.AspNetCore.All](xref:fundamentals/metapackage)).</span></span> <span data-ttu-id="4a6c7-141">如果不使用元包，请单独安装 `Microsoft.AspNetCore.Server.IISIntegration`。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-141">If you don't use one of the metapackages, install `Microsoft.AspNetCore.Server.IISIntegration` separately.</span></span> <span data-ttu-id="4a6c7-142">`IISIntegration` 包是互操作性包，它读取 ANCM 广播的环境变量来设置应用。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-142">The `IISIntegration` package is an interoperability pack that reads environment variables broadcast by ANCM to set up your app.</span></span> <span data-ttu-id="4a6c7-143">环境变量提供配置信息，如要侦听的端口。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-143">The environment variables provide configuration information, such as the port to listen on.</span></span> 

# <a name="aspnet-core-1xtabaspnetcore1x"></a>[<span data-ttu-id="4a6c7-144">ASP.NET Core 1.x</span><span class="sxs-lookup"><span data-stu-id="4a6c7-144">ASP.NET Core 1.x</span></span>](#tab/aspnetcore1x)

<span data-ttu-id="4a6c7-145">在应用程序中安装 [Microsoft.AspNetCore.Server.IISIntegration](https://www.nuget.org/packages/Microsoft.AspNetCore.Server.IISIntegration/)。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-145">In your application, install [Microsoft.AspNetCore.Server.IISIntegration](https://www.nuget.org/packages/Microsoft.AspNetCore.Server.IISIntegration/).</span></span> <span data-ttu-id="4a6c7-146">`IISIntegration` 包是互操作性包，它读取 ANCM 广播的环境变量来设置应用。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-146">The `IISIntegration` package  is an interoperability pack that reads environment variables broadcast by ANCM to set up your app.</span></span> <span data-ttu-id="4a6c7-147">环境变量提供配置信息，如要侦听的端口。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-147">The environment variables provide configuration information, such as the port to listen on.</span></span> 

---

### <a name="call-useiisintegration"></a><span data-ttu-id="4a6c7-148">调用 UseIISIntegration</span><span class="sxs-lookup"><span data-stu-id="4a6c7-148">Call UseIISIntegration</span></span>

# <a name="aspnet-core-2xtabaspnetcore2x"></a>[<span data-ttu-id="4a6c7-149">ASP.NET Core 2.x</span><span class="sxs-lookup"><span data-stu-id="4a6c7-149">ASP.NET Core 2.x</span></span>](#tab/aspnetcore2x)

<span data-ttu-id="4a6c7-150">通过 IIS 运行 [`WebHostBuilder`](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.webhostbuilder) 上的 `UseIISIntegration` 扩展方法时，将自动调用此方法。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-150">The `UseIISIntegration` extension method on [`WebHostBuilder`](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.webhostbuilder) is called automatically when you run with IIS.</span></span>

<span data-ttu-id="4a6c7-151">如果未使用 ASP.NET Core 元包，且未安装 `Microsoft.AspNetCore.Server.IISIntegration` 包，则将收到运行时错误。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-151">If you aren't using one of the ASP.NET Core metapackages and haven't installed the  `Microsoft.AspNetCore.Server.IISIntegration` package, you get a runtime error.</span></span> <span data-ttu-id="4a6c7-152">如果显式调用 `UseIISIntegration`，则在未安装此包的情况下将收到编译时错误。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-152">If you call `UseIISIntegration` explicitly, you get a compile time error if the package isn't installed.</span></span>

# <a name="aspnet-core-1xtabaspnetcore1x"></a>[<span data-ttu-id="4a6c7-153">ASP.NET Core 1.x</span><span class="sxs-lookup"><span data-stu-id="4a6c7-153">ASP.NET Core 1.x</span></span>](#tab/aspnetcore1x)

<span data-ttu-id="4a6c7-154">在应用程序的 `Main` 方法中，调用 [`WebHostBuilder`](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.webhostbuilder) 上的 `UseIISIntegration` 扩展方法。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-154">In your application's `Main` method, call the `UseIISIntegration` extension method on [`WebHostBuilder`](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.webhostbuilder).</span></span> 

[!code-csharp[](aspnet-core-module/sample/Program.cs?name=snippet_Main&highlight=12)]

---

<span data-ttu-id="4a6c7-155">`UseIISIntegration` 方法将查找 ANCM 设置的环境变量，如果未找到环境变量，则不进行任何操作。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-155">The `UseIISIntegration` method looks for environment variables that ANCM sets, and it no-ops if they aren't found.</span></span> <span data-ttu-id="4a6c7-156">此行为有助于在 macOS 或 Linux 上进行开发和测试，以及部署到运行 IIS 的服务器等方案。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-156">This behavior facilitates scenarios like developing and testing on macOS or Linux and deploying to a server that runs IIS.</span></span> <span data-ttu-id="4a6c7-157">当在 macOS 或 Linux 上运行时，Kestrel 充当 Web 服务器；但当应用部署到 IIS 环境中时，它将自动使用 ANCM 和 IIS。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-157">While running on macOS or Linux, Kestrel acts as the web server; but when the app is deployed to the IIS environment, it automatically uses ANCM and IIS.</span></span>

### <a name="ancm-port-binding-overrides-other-port-bindings"></a><span data-ttu-id="4a6c7-158">ANCM 端口绑定替代其他端口绑定</span><span class="sxs-lookup"><span data-stu-id="4a6c7-158">ANCM port binding overrides other port bindings</span></span>

# <a name="aspnet-core-2xtabaspnetcore2x"></a>[<span data-ttu-id="4a6c7-159">ASP.NET Core 2.x</span><span class="sxs-lookup"><span data-stu-id="4a6c7-159">ASP.NET Core 2.x</span></span>](#tab/aspnetcore2x)

<span data-ttu-id="4a6c7-160">ANCM 生成动态端口，以分配给后端进程。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-160">ANCM generates a dynamic port to assign to the back-end process.</span></span> <span data-ttu-id="4a6c7-161">`UseIISIntegration` 方法获取此动态端口，并将 Kestrel 配置为侦听 `http://locahost:{dynamicPort}/`。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-161">The `UseIISIntegration` method picks up this dynamic port and configures Kestrel to listen on `http://locahost:{dynamicPort}/`.</span></span> <span data-ttu-id="4a6c7-162">这将替代其他 URL 配置，如对 `UseUrls` 或 [Kestrel 的侦听 API](xref:fundamentals/servers/kestrel?tabs=aspnetcore2x#endpoint-configuration) 的调用。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-162">This overrides other URL configurations, such as calls to `UseUrls` or [Kestrel's Listen API](xref:fundamentals/servers/kestrel?tabs=aspnetcore2x#endpoint-configuration).</span></span> <span data-ttu-id="4a6c7-163">因此，在使用 ANCM 时，无需调用 `UseUrls` 或 Kestrel 的 `Listen` API。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-163">Therefore, you don't need to call `UseUrls` or Kestrel's `Listen` API when you use ANCM.</span></span> <span data-ttu-id="4a6c7-164">如果调用 `UseUrls` 或 `Listen`，则在不使用 IIS 情况下运行应用时，Kestrel 将侦听指定的端口。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-164">If you do call `UseUrls` or `Listen`, Kestrel listens on the port you specify when you run the app without IIS.</span></span>

# <a name="aspnet-core-1xtabaspnetcore1x"></a>[<span data-ttu-id="4a6c7-165">ASP.NET Core 1.x</span><span class="sxs-lookup"><span data-stu-id="4a6c7-165">ASP.NET Core 1.x</span></span>](#tab/aspnetcore1x)

<span data-ttu-id="4a6c7-166">ANCM 生成动态端口，以分配给后端进程。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-166">ANCM generates a dynamic port to assign to the back-end process.</span></span> <span data-ttu-id="4a6c7-167">`UseIISIntegration` 方法获取此动态端口，并将 Kestrel 配置为侦听 `http://locahost:{dynamicPort}/`。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-167">The `UseIISIntegration` method picks up this dynamic port and configures Kestrel to listen on `http://locahost:{dynamicPort}/`.</span></span> <span data-ttu-id="4a6c7-168">这将替代其他 URL 配置，如对 `UseUrls` 的调用。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-168">This overrides other URL configurations, such as calls to `UseUrls`.</span></span> <span data-ttu-id="4a6c7-169">因此，在使用 ANCM 时，无需调用 `UseUrls`。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-169">Therefore, you don't need to call `UseUrls` when you use ANCM.</span></span> <span data-ttu-id="4a6c7-170">如果调用 `UseUrls`，则在不使用 IIS 情况下运行应用时，Kestrel 将侦听指定的端口。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-170">If you do call `UseUrls`, Kestrel listens on the port you specify when you run the app without IIS.</span></span>

<span data-ttu-id="4a6c7-171">在 ASP.NET Core 1.0 中，如果调用 `UseUrls`，请在调用 `UseIISIntegration` 之前对其进行调用，以便不覆盖 ANCM 配置的端口。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-171">In ASP.NET Core 1.0, if you call `UseUrls`, call it **before** you call `UseIISIntegration` so that the ANCM-configured port doesn't get overwritten.</span></span> <span data-ttu-id="4a6c7-172">ASP.NET Core 1.1 中不需要此调用顺序，因为 ANCM 设置将重写 `UseUrls`。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-172">This calling order isn't required in ASP.NET Core 1.1, because the ANCM setting overrides `UseUrls`.</span></span>

---

### <a name="configure-ancm-options-in-webconfig"></a><span data-ttu-id="4a6c7-173">在 Web.config 中配置 ANCM 选项</span><span class="sxs-lookup"><span data-stu-id="4a6c7-173">Configure ANCM options in Web.config</span></span>

<span data-ttu-id="4a6c7-174">针对 ASP.NET Core 模块的配置存储在位于应用程序的根文件夹中的 web.config 文件中。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-174">Configuration for the ASP.NET Core Module is stored in the *web.config* file that's located in the application's root folder.</span></span> <span data-ttu-id="4a6c7-175">此文件中的设置指向启动命令和启动 ASP.NET Core 应用的参数。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-175">Settings in this file point to the startup command and arguments that start your ASP.NET Core app.</span></span> <span data-ttu-id="4a6c7-176">有关 web.config 代码的示例和配置选项指南，请参阅 [ASP.NET Core 模块配置参考](xref:host-and-deploy/aspnet-core-module)。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-176">For sample *web.config* code and guidance on configuration options, see [ASP.NET Core Module Configuration Reference](xref:host-and-deploy/aspnet-core-module).</span></span>

### <a name="run-with-iis-express-in-development"></a><span data-ttu-id="4a6c7-177">在开发过程中通过 IIS Express 运行</span><span class="sxs-lookup"><span data-stu-id="4a6c7-177">Run with IIS Express in development</span></span>

<span data-ttu-id="4a6c7-178">Visual Studio 可使用 ASP.NET Core 模板定义的默认配置文件启动 IIS Express。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-178">IIS Express can be launched by Visual Studio using the default profile defined by the ASP.NET Core templates.</span></span>

## <a name="proxy-configuration-uses-http-protocol-and-a-pairing-token"></a><span data-ttu-id="4a6c7-179">代理配置使用 HTTP 协议和配对令牌</span><span class="sxs-lookup"><span data-stu-id="4a6c7-179">Proxy configuration uses HTTP protocol and a pairing token</span></span>

<span data-ttu-id="4a6c7-180">在 ANCM 和 Kestrel 之间创建的代理使用 HTTP 协议。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-180">The proxy created between the ANCM and Kestrel uses the HTTP protocol.</span></span> <span data-ttu-id="4a6c7-181">使用 HTTP 是一种性能优化，其中 ANCM 和 Kestrel 之间的流量发生于脱离网络接口的环回地址。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-181">Using HTTP is a performance optimization where the traffic between the ANCM and Kestrel takes place on a loopback address off of the network interface.</span></span> <span data-ttu-id="4a6c7-182">因此，不存在从脱离服务器的位置窃取 ANCM 和 Kestrel 之间的流量的风险。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-182">There's no risk of eavesdropping the traffic between the ANCM and Kestrel from a location off of the server.</span></span>

<span data-ttu-id="4a6c7-183">配对令牌用于保证 Kestrel 收到的请求已由 IIS 代理且不来自某些其他源。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-183">A pairing token is used to guarantee that the requests received by Kestrel were proxied by IIS and didn't come from some other source.</span></span> <span data-ttu-id="4a6c7-184">ANCM 已创建配对令牌并将其设置到环境变量 (`ASPNETCORE_TOKEN`)。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-184">The pairing token is created and set into an environment variable (`ASPNETCORE_TOKEN`) by the ANCM.</span></span> <span data-ttu-id="4a6c7-185">此外，配对令牌还设置到每个代理请求的标头 (`MSAspNetCoreToken`)。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-185">The pairing token is also set into a header (`MSAspNetCoreToken`) on every proxied request.</span></span> <span data-ttu-id="4a6c7-186">IIS 中间件检查它所接收的每个请求，以确认配对令牌标头值与环境变量值相匹配。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-186">IIS Middleware checks each request it receives to confirm that the pairing token header value matches the environment variable value.</span></span> <span data-ttu-id="4a6c7-187">如果令牌值不匹配，则将记录请求并拒绝该请求。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-187">If the token values are mismatched, the request is logged and rejected.</span></span> <span data-ttu-id="4a6c7-188">无法从脱离服务器的位置访问配对令牌环境变量及 ANCM 和 Kestrel 之间的流量。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-188">The pairing token environment variable and the traffic between the ANCM and Kestrel aren't accessible from a location off of the server.</span></span> <span data-ttu-id="4a6c7-189">如果不知道配对令牌值，攻击者就无法提交绕过 IIS 中间件中的检查的请求。</span><span class="sxs-lookup"><span data-stu-id="4a6c7-189">Without knowing the pairing token value, an attacker can't submit requests that bypass the check in the IIS Middleware.</span></span>

## <a name="next-steps"></a><span data-ttu-id="4a6c7-190">后续步骤</span><span class="sxs-lookup"><span data-stu-id="4a6c7-190">Next steps</span></span>

<span data-ttu-id="4a6c7-191">有关更多信息，请参见以下资源：</span><span class="sxs-lookup"><span data-stu-id="4a6c7-191">For more information, see the following resources:</span></span>

* [<span data-ttu-id="4a6c7-192">本文的示例应用</span><span class="sxs-lookup"><span data-stu-id="4a6c7-192">Sample app for this article</span></span>](https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/servers/aspnet-core-module/sample)
* [<span data-ttu-id="4a6c7-193">ASP.NET Core 模块源代码</span><span class="sxs-lookup"><span data-stu-id="4a6c7-193">ASP.NET Core Module source code</span></span>](https://github.com/aspnet/AspNetCoreModule)
* [<span data-ttu-id="4a6c7-194">ASP.NET Core 模块配置参考</span><span class="sxs-lookup"><span data-stu-id="4a6c7-194">ASP.NET Core Module Configuration Reference</span></span>](xref:host-and-deploy/aspnet-core-module)
* [<span data-ttu-id="4a6c7-195">使用 IIS 在 Windows 上进行托管</span><span class="sxs-lookup"><span data-stu-id="4a6c7-195">Host on Windows with IIS</span></span>](xref:host-and-deploy/iis/index)
