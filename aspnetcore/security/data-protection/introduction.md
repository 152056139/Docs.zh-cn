---
title: ASP.NET Core 数据保护
author: rick-anderson
description: 了解有关数据保护的概念和 ASP.NET Core 数据保护 Api 的设计原则。
ms.author: riande
ms.date: 10/14/2016
uid: security/data-protection/introduction
ms.openlocfilehash: 29a2bbef6f2fd9b61541173af143926ca82bfad7
ms.sourcegitcommit: 3ca527f27c88cfc9d04688db5499e372fbc2c775
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/17/2018
ms.locfileid: "39095690"
---
# <a name="aspnet-core-data-protection"></a><span data-ttu-id="913f0-103">ASP.NET Core 数据保护</span><span class="sxs-lookup"><span data-stu-id="913f0-103">ASP.NET Core Data Protection</span></span>

<span data-ttu-id="913f0-104">Web 应用程序通常需要将安全敏感数据存储。</span><span class="sxs-lookup"><span data-stu-id="913f0-104">Web applications often need to store security-sensitive data.</span></span> <span data-ttu-id="913f0-105">Windows 桌面应用程序提供 DPAPI，但这并不适合 web 应用程序。</span><span class="sxs-lookup"><span data-stu-id="913f0-105">Windows provides DPAPI for desktop applications but this is unsuitable for web applications.</span></span> <span data-ttu-id="913f0-106">ASP.NET Core 数据保护堆栈提供一个简单、 易于使用的加密 API，开发人员可以使用来保护数据，包括密钥管理和旋转。</span><span class="sxs-lookup"><span data-stu-id="913f0-106">The ASP.NET Core data protection stack provide a simple, easy to use cryptographic API a developer can use to protect data, including key management and rotation.</span></span>

<span data-ttu-id="913f0-107">ASP.NET Core 数据保护堆栈旨在用作的长期替代&lt;machineKey&gt;在 ASP.NET 中的元素 1.x-4.x。</span><span class="sxs-lookup"><span data-stu-id="913f0-107">The ASP.NET Core data protection stack is designed to serve as the long-term replacement for the &lt;machineKey&gt; element in ASP.NET 1.x - 4.x.</span></span> <span data-ttu-id="913f0-108">它旨在解决许多旧加密堆栈的不足之处同时为大多数现代应用程序可能会遇到的使用情况下提供开箱解决方案。</span><span class="sxs-lookup"><span data-stu-id="913f0-108">It was designed to address many of the shortcomings of the old cryptographic stack while providing an out-of-the-box solution for the majority of use cases modern applications are likely to encounter.</span></span>

## <a name="problem-statement"></a><span data-ttu-id="913f0-109">问题陈述</span><span class="sxs-lookup"><span data-stu-id="913f0-109">Problem statement</span></span>

<span data-ttu-id="913f0-110">总体问题语句可以简洁地表示中的单个句子： 我需要保留以供将来检索受信任的信息，但我不信任持久性机制。</span><span class="sxs-lookup"><span data-stu-id="913f0-110">The overall problem statement can be succinctly stated in a single sentence: I need to persist trusted information for later retrieval, but I don't trust the persistence mechanism.</span></span> <span data-ttu-id="913f0-111">在 web 术语中，这可能会根据写入"我需要为往返通过不受信任的客户端的受信任状态。"</span><span class="sxs-lookup"><span data-stu-id="913f0-111">In web terms, this might be written as "I need to round-trip trusted state via an untrusted client."</span></span>

<span data-ttu-id="913f0-112">此规范的示例是身份验证 cookie 或持有者令牌。</span><span class="sxs-lookup"><span data-stu-id="913f0-112">The canonical example of this is an authentication cookie or bearer token.</span></span> <span data-ttu-id="913f0-113">服务器会生成"我是 Groot，具有 xyz 的权限"令牌并将它传递到客户端。</span><span class="sxs-lookup"><span data-stu-id="913f0-113">The server generates an "I am Groot and have xyz permissions" token and hands it to the client.</span></span> <span data-ttu-id="913f0-114">在将来某天的客户端将显示该令牌发送回服务器，但该服务器需要某种类型的客户端尚未伪造令牌的保障。</span><span class="sxs-lookup"><span data-stu-id="913f0-114">At some future date the client will present that token back to the server, but the server needs some kind of assurance that the client hasn't forged the token.</span></span> <span data-ttu-id="913f0-115">因此第一个要求： 真实性 （也称为</span><span class="sxs-lookup"><span data-stu-id="913f0-115">Thus the first requirement: authenticity (a.k.a.</span></span> <span data-ttu-id="913f0-116">完整性、 防篡改攻击）。</span><span class="sxs-lookup"><span data-stu-id="913f0-116">integrity, tamper-proofing).</span></span>

<span data-ttu-id="913f0-117">持久化的状态由服务器信任的因为我们预计这种状态可能包含特定于操作环境的信息。</span><span class="sxs-lookup"><span data-stu-id="913f0-117">Since the persisted state is trusted by the server, we anticipate that this state might contain information that's specific to the operating environment.</span></span> <span data-ttu-id="913f0-118">这可能是在文件路径、 权限、 句柄或其他间接引用的窗体或其他一些特定于服务器的数据。</span><span class="sxs-lookup"><span data-stu-id="913f0-118">This could be in the form of a file path, a permission, a handle or other indirect reference, or some other piece of server-specific data.</span></span> <span data-ttu-id="913f0-119">此类信息通常不应公开到不受信任的客户端。</span><span class="sxs-lookup"><span data-stu-id="913f0-119">Such information should generally not be disclosed to an untrusted client.</span></span> <span data-ttu-id="913f0-120">因此第二个要求： 保密性。</span><span class="sxs-lookup"><span data-stu-id="913f0-120">Thus the second requirement: confidentiality.</span></span>

<span data-ttu-id="913f0-121">最后，现代应用程序的组件化，因为我们已了解是各个组件将想要充分利用此系统而不考虑其他组件的系统中。</span><span class="sxs-lookup"><span data-stu-id="913f0-121">Finally, since modern applications are componentized, what we've seen is that individual components will want to take advantage of this system without regard to other components in the system.</span></span> <span data-ttu-id="913f0-122">例如，如果持有者令牌组件使用的此堆栈，它应运行不受干扰地从一种反 CSRF 机制，也可能使用相同的堆栈。</span><span class="sxs-lookup"><span data-stu-id="913f0-122">For instance, if a bearer token component is using this stack, it should operate without interference from an anti-CSRF mechanism that might also be using the same stack.</span></span> <span data-ttu-id="913f0-123">因此最后一项要求： 隔离。</span><span class="sxs-lookup"><span data-stu-id="913f0-123">Thus the final requirement: isolation.</span></span>

<span data-ttu-id="913f0-124">我们可以进一步约束以缩小我们的要求的范围。</span><span class="sxs-lookup"><span data-stu-id="913f0-124">We can provide further constraints in order to narrow the scope of our requirements.</span></span> <span data-ttu-id="913f0-125">我们假定加密系统内的所有服务都是同等信任和数据无需生成或在我们的直接控制服务外部使用。</span><span class="sxs-lookup"><span data-stu-id="913f0-125">We assume that all services operating within the cryptosystem are equally trusted and that the data doesn't need to be generated or consumed outside of the services under our direct control.</span></span> <span data-ttu-id="913f0-126">此外，我们需要的操作是尽可能快，因为 web 服务的每个请求可能会经过加密系统的一个或多个时间。</span><span class="sxs-lookup"><span data-stu-id="913f0-126">Furthermore, we require that operations are as fast as possible since each request to the web service might go through the cryptosystem one or more times.</span></span> <span data-ttu-id="913f0-127">这使得对称加密非常适合用于我们的方案，和我们可以折扣此类具有所需的时间之前的非对称加密。</span><span class="sxs-lookup"><span data-stu-id="913f0-127">This makes symmetric cryptography ideal for our scenario, and we can discount asymmetric cryptography until such a time that it's needed.</span></span>

## <a name="design-philosophy"></a><span data-ttu-id="913f0-128">设计理念</span><span class="sxs-lookup"><span data-stu-id="913f0-128">Design philosophy</span></span>

<span data-ttu-id="913f0-129">我们首先使用现有的堆栈识别问题。</span><span class="sxs-lookup"><span data-stu-id="913f0-129">We started by identifying problems with the existing stack.</span></span> <span data-ttu-id="913f0-130">一旦我们有的我们的调查了现有解决方案布局而得出的结论是，没有现有的解决方案没有我们查找的功能。</span><span class="sxs-lookup"><span data-stu-id="913f0-130">Once we had that, we surveyed the landscape of existing solutions and concluded that no existing solution quite had the capabilities we sought.</span></span> <span data-ttu-id="913f0-131">然后，我们设计基于多个指导原则的解决方案。</span><span class="sxs-lookup"><span data-stu-id="913f0-131">We then engineered a solution based on several guiding principles.</span></span>

* <span data-ttu-id="913f0-132">系统应提供简单的配置。</span><span class="sxs-lookup"><span data-stu-id="913f0-132">The system should offer simplicity of configuration.</span></span> <span data-ttu-id="913f0-133">理想情况下系统将为零配置，并且开发人员可以快速开始使用。</span><span class="sxs-lookup"><span data-stu-id="913f0-133">Ideally the system would be zero-configuration and developers could hit the ground running.</span></span> <span data-ttu-id="913f0-134">在开发人员需要配置一个特定方面 （如密钥存储库） 的情况下，应考虑到使这些特定的配置更简单。</span><span class="sxs-lookup"><span data-stu-id="913f0-134">In situations where developers need to configure a specific aspect (such as the key repository), consideration should be given to making those specific configurations simple.</span></span>

* <span data-ttu-id="913f0-135">提供一个简单的面向消费者的 API。</span><span class="sxs-lookup"><span data-stu-id="913f0-135">Offer a simple consumer-facing API.</span></span> <span data-ttu-id="913f0-136">Api 应易于正确使用且难以使用不正确。</span><span class="sxs-lookup"><span data-stu-id="913f0-136">The APIs should be easy to use correctly and difficult to use incorrectly.</span></span>

* <span data-ttu-id="913f0-137">开发人员不应了解密钥管理原则。</span><span class="sxs-lookup"><span data-stu-id="913f0-137">Developers shouldn't learn key management principles.</span></span> <span data-ttu-id="913f0-138">系统应处理算法选择和开发人员的代表的密钥生存期。</span><span class="sxs-lookup"><span data-stu-id="913f0-138">The system should handle algorithm selection and key lifetime on the developer's behalf.</span></span> <span data-ttu-id="913f0-139">理想情况下，开发人员甚至不应具有访问原始密钥材料。</span><span class="sxs-lookup"><span data-stu-id="913f0-139">Ideally the developer should never even have access to the raw key material.</span></span>

* <span data-ttu-id="913f0-140">应尽可能的静态保护密钥。</span><span class="sxs-lookup"><span data-stu-id="913f0-140">Keys should be protected at rest when possible.</span></span> <span data-ttu-id="913f0-141">系统应找出相应的默认保护机制，并将其自动应用。</span><span class="sxs-lookup"><span data-stu-id="913f0-141">The system should figure out an appropriate default protection mechanism and apply it automatically.</span></span>

<span data-ttu-id="913f0-142">记住这些原则与我们开发了一个简单[易于使用](xref:security/data-protection/using-data-protection)数据保护堆栈。</span><span class="sxs-lookup"><span data-stu-id="913f0-142">With these principles in mind we developed a simple, [easy to use](xref:security/data-protection/using-data-protection) data protection stack.</span></span>

<span data-ttu-id="913f0-143">ASP.NET Core 数据保护 Api 主要不用于机密负载的无限期持久性。</span><span class="sxs-lookup"><span data-stu-id="913f0-143">The ASP.NET Core data protection APIs are not primarily intended for indefinite persistence of confidential payloads.</span></span> <span data-ttu-id="913f0-144">等其他技术[Windows CNG DPAPI](https://msdn.microsoft.com/library/windows/desktop/hh706794%28v=vs.85%29.aspx)并[Azure Rights Management](https://docs.microsoft.com/rights-management/)更适合的无限期存储方案，并且必须相应地强密钥管理功能。</span><span class="sxs-lookup"><span data-stu-id="913f0-144">Other technologies like [Windows CNG DPAPI](https://msdn.microsoft.com/library/windows/desktop/hh706794%28v=vs.85%29.aspx) and [Azure Rights Management](https://docs.microsoft.com/rights-management/) are more suited to the scenario of indefinite storage, and they have correspondingly strong key management capabilities.</span></span> <span data-ttu-id="913f0-145">也就是说，无需进行任何开发人员禁止使用 ASP.NET Core 数据保护 Api 进行长期保护的机密数据。</span><span class="sxs-lookup"><span data-stu-id="913f0-145">That said, there's nothing prohibiting a developer from using the ASP.NET Core data protection APIs for long-term protection of confidential data.</span></span>

## <a name="audience"></a><span data-ttu-id="913f0-146">读者</span><span class="sxs-lookup"><span data-stu-id="913f0-146">Audience</span></span>

<span data-ttu-id="913f0-147">数据保护系统分为五个主要的软件包。</span><span class="sxs-lookup"><span data-stu-id="913f0-147">The data protection system is divided into five main packages.</span></span> <span data-ttu-id="913f0-148">这些 Api 的各个方面定位三个主要受众;</span><span class="sxs-lookup"><span data-stu-id="913f0-148">Various aspects of these APIs target three main audiences;</span></span>

1. <span data-ttu-id="913f0-149">[使用者 Api 概述](xref:security/data-protection/consumer-apis/overview)目标应用程序和框架开发人员。</span><span class="sxs-lookup"><span data-stu-id="913f0-149">The [Consumer APIs Overview](xref:security/data-protection/consumer-apis/overview) target application and framework developers.</span></span>

   <span data-ttu-id="913f0-150">"我不想要了解有关在堆栈的运行方式或配置方式。</span><span class="sxs-lookup"><span data-stu-id="913f0-150">"I don't want to learn about how the stack operates or about how it's configured.</span></span> <span data-ttu-id="913f0-151">我只是想要执行某项操作中的最简单的方式尽可能高概率为成功使用 Api。"</span><span class="sxs-lookup"><span data-stu-id="913f0-151">I simply want to perform some operation in as simple a manner as possible with high probability of using the APIs successfully."</span></span>

2. <span data-ttu-id="913f0-152">[配置 Api](xref:security/data-protection/configuration/overview)目标应用程序开发人员和系统管理员。</span><span class="sxs-lookup"><span data-stu-id="913f0-152">The [configuration APIs](xref:security/data-protection/configuration/overview) target application developers and system administrators.</span></span>

   <span data-ttu-id="913f0-153">"我需要告诉我的环境需要非默认路径或设置数据保护系统。"</span><span class="sxs-lookup"><span data-stu-id="913f0-153">"I need to tell the data protection system that my environment requires non-default paths or settings."</span></span>

3. <span data-ttu-id="913f0-154">扩展性 Api 目标，开发人员负责实现自定义策略。</span><span class="sxs-lookup"><span data-stu-id="913f0-154">The extensibility APIs target developers in charge of implementing custom policy.</span></span> <span data-ttu-id="913f0-155">这些 Api 的使用情况将限于极少数情况下并遇到安全注意开发人员。</span><span class="sxs-lookup"><span data-stu-id="913f0-155">Usage of these APIs would be limited to rare situations and experienced, security aware developers.</span></span>

   <span data-ttu-id="913f0-156">"我需要替换的整个系统内组件，因为我有真正独特的行为要求。</span><span class="sxs-lookup"><span data-stu-id="913f0-156">"I need to replace an entire component within the system because I have truly unique behavioral requirements.</span></span> <span data-ttu-id="913f0-157">我愿意以了解不常见使用的 API 图面部分，若要生成可满足我的要求的插件。"</span><span class="sxs-lookup"><span data-stu-id="913f0-157">I am willing to learn uncommonly-used parts of the API surface in order to build a plugin that fulfills my requirements."</span></span>

## <a name="package-layout"></a><span data-ttu-id="913f0-158">包布局</span><span class="sxs-lookup"><span data-stu-id="913f0-158">Package Layout</span></span>

<span data-ttu-id="913f0-159">数据保护堆栈包含五个包。</span><span class="sxs-lookup"><span data-stu-id="913f0-159">The data protection stack consists of five packages.</span></span>

* <span data-ttu-id="913f0-160">Microsoft.AspNetCore.DataProtection.Abstractions 包含基本的 IDataProtectionProvider 和 IDataProtector 接口。</span><span class="sxs-lookup"><span data-stu-id="913f0-160">Microsoft.AspNetCore.DataProtection.Abstractions contains the basic IDataProtectionProvider and IDataProtector interfaces.</span></span> <span data-ttu-id="913f0-161">它还包含有用的扩展方法可以帮助你使用这些类型 （例如，重载的 IDataProtector.Protect）。</span><span class="sxs-lookup"><span data-stu-id="913f0-161">It also contains useful extension methods that can assist working with these types (e.g., overloads of IDataProtector.Protect).</span></span> <span data-ttu-id="913f0-162">请参阅有关详细信息使用者接口部分。</span><span class="sxs-lookup"><span data-stu-id="913f0-162">See the consumer interfaces section for more information.</span></span> <span data-ttu-id="913f0-163">如果其他人负责实例化的数据保护系统，您只需占用 Api，则需为引用 Microsoft.AspNetCore.DataProtection.Abstractions。</span><span class="sxs-lookup"><span data-stu-id="913f0-163">If somebody else is responsible for instantiating the data protection system and you are simply consuming the APIs, you'll want to reference Microsoft.AspNetCore.DataProtection.Abstractions.</span></span>

* <span data-ttu-id="913f0-164">Microsoft.AspNetCore.DataProtection 包含数据保护系统，包括核心加密操作、 密钥管理、 配置和可扩展性的核心实现。</span><span class="sxs-lookup"><span data-stu-id="913f0-164">Microsoft.AspNetCore.DataProtection contains the core implementation of the data protection system, including the core cryptographic operations, key management, configuration, and extensibility.</span></span> <span data-ttu-id="913f0-165">如果你要负责实例化的数据保护系统 （例如，将其添加到 IServiceCollection） 或修改或扩展其行为，您将希望引用 Microsoft.AspNetCore.DataProtection。</span><span class="sxs-lookup"><span data-stu-id="913f0-165">If you're responsible for instantiating the data protection system (e.g., adding it to an IServiceCollection) or modifying or extending its behavior, you'll want to reference Microsoft.AspNetCore.DataProtection.</span></span>

* <span data-ttu-id="913f0-166">Microsoft.AspNetCore.DataProtection.Extensions 包含其他一些 Api，开发人员可能会发现很有用，但这不属于核心包中。</span><span class="sxs-lookup"><span data-stu-id="913f0-166">Microsoft.AspNetCore.DataProtection.Extensions contains additional APIs which developers might find useful but which don't belong in the core package.</span></span> <span data-ttu-id="913f0-167">例如，此包包含一个简单的"实例化指向一个特定的密钥存储目录，而无需依赖关系注入设置系统"API （详细信息）。</span><span class="sxs-lookup"><span data-stu-id="913f0-167">For instance, this package contains a simple "instantiate the system pointing at a specific key storage directory with no dependency injection setup" API (more info).</span></span> <span data-ttu-id="913f0-168">它还包含用于限制受保护负载 （详细信息） 的生存期的扩展方法。</span><span class="sxs-lookup"><span data-stu-id="913f0-168">It also contains extension methods for limiting the lifetime of protected payloads (more info).</span></span>

* <span data-ttu-id="913f0-169">Microsoft.AspNetCore.DataProtection.SystemWeb 可安装到现有 ASP.NET 4.x 应用程序重定向其&lt;machineKey&gt;操作，而是使用新的数据保护堆栈。</span><span class="sxs-lookup"><span data-stu-id="913f0-169">Microsoft.AspNetCore.DataProtection.SystemWeb can be installed into an existing ASP.NET 4.x application to redirect its &lt;machineKey&gt; operations to instead use the new data protection stack.</span></span> <span data-ttu-id="913f0-170">请参阅[兼容性](xref:security/data-protection/compatibility/replacing-machinekey#compatibility-replacing-machinekey)有关详细信息。</span><span class="sxs-lookup"><span data-stu-id="913f0-170">See [compatibility](xref:security/data-protection/compatibility/replacing-machinekey#compatibility-replacing-machinekey) for more information.</span></span>

* <span data-ttu-id="913f0-171">Microsoft.AspNetCore.Cryptography.KeyDerivation 提供 PBKDF2 密码哈希例程的实现，并可由系统需要安全地处理用户密码。</span><span class="sxs-lookup"><span data-stu-id="913f0-171">Microsoft.AspNetCore.Cryptography.KeyDerivation provides an implementation of the PBKDF2 password hashing routine and can be used by systems which need to handle user passwords securely.</span></span> <span data-ttu-id="913f0-172">请参阅[哈希密码](xref:security/data-protection/consumer-apis/password-hashing)有关详细信息。</span><span class="sxs-lookup"><span data-stu-id="913f0-172">See [Hash passwords](xref:security/data-protection/consumer-apis/password-hashing) for more information.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="913f0-173">其他资源</span><span class="sxs-lookup"><span data-stu-id="913f0-173">Additional resources</span></span>

<xref:host-and-deploy/web-farm>
