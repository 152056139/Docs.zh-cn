---
uid: identity/overview/getting-started/developing-aspnet-apps-with-windows-azure-active-directory
title: 开发使用 Azure Active Directory 的 ASP.NET 应用程序 |Microsoft 文档
author: Rick-Anderson
description: Microsoft ASP.NET tools for Azure Active Directory 可以方便地为在 Azure 上托管的 web 应用程序启用身份验证。 你也可以使用 Azure 身份验证...
ms.author: aspnetcontent
manager: wpickett
ms.date: 08/14/2014
ms.topic: article
ms.assetid: 457d7eaf-ee76-4ceb-9082-c7c1721435ad
ms.technology: ''
ms.prod: .net-framework
msc.legacyurl: /identity/overview/getting-started/developing-aspnet-apps-with-windows-azure-active-directory
msc.type: authoredcontent
ms.openlocfilehash: 44bf29e099583bf9d49f2715d3ff4f748728ad8b
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/06/2018
---
<a name="developing-aspnet-apps-with-azure-active-directory"></a><span data-ttu-id="47597-104">开发使用 Azure Active Directory 的 ASP.NET 应用程序</span><span class="sxs-lookup"><span data-stu-id="47597-104">Developing ASP.NET Apps with Azure Active Directory</span></span>
====================
<span data-ttu-id="47597-105">通过[Rick Anderson](https://github.com/Rick-Anderson)</span><span class="sxs-lookup"><span data-stu-id="47597-105">by [Rick Anderson](https://github.com/Rick-Anderson)</span></span>

> <span data-ttu-id="47597-106">Microsoft ASP.NET tools 为 Azure Active Directory 可以很容易地为上托管的 web 应用程序启用身份验证[Azure](https://www.windowsazure.com/home/features/web-sites/)。</span><span class="sxs-lookup"><span data-stu-id="47597-106">Microsoft ASP.NET tools for Azure Active Directory makes it simple to enable authentication for web applications hosted on [Azure](https://www.windowsazure.com/home/features/web-sites/).</span></span> <span data-ttu-id="47597-107">可以使用 Azure 身份验证从组织、 从本地 Active Directory 同步的公司帐户或用户在你自己的自定义 Azure Active Directory 域中创建的 Office 365 用户进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="47597-107">You can use Azure Authentication to authenticate Office 365 users from your organization, corporate accounts synced from your on-premise Active Directory or users created in your own custom Azure Active Directory domain.</span></span> <span data-ttu-id="47597-108">启用 Windows Azure 身份验证配置你的应用程序使用单个的用户进行身份验证[Azure Active Directory](https://docs.microsoft.com/azure/active-directory/)租户。</span><span class="sxs-lookup"><span data-stu-id="47597-108">Enabling Windows Azure Authentication configures your application to authenticate users using a single [Azure Active Directory](https://docs.microsoft.com/azure/active-directory/) tenant.</span></span>
> 
>  <span data-ttu-id="47597-109">本教程编写由 Rick Anderson [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="47597-109">This tutorial was written by Rick Anderson [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)</span></span>


<span data-ttu-id="47597-110">本教程将演示如何创建的 ASP.NET 应用程序配置为使用登录[Azure Active Directory](https://msdn.microsoft.com/library/azure/mt168838.aspx) (Azure AD)。</span><span class="sxs-lookup"><span data-stu-id="47597-110">This tutorial will show you how to create an ASP.NET application that is configured for sign-on with [Azure Active Directory](https://msdn.microsoft.com/library/azure/mt168838.aspx) (Azure AD).</span></span> <span data-ttu-id="47597-111">你还将了解如何调用 Graph API，以获取有关当前登录的用户的信息以及如何部署应用程序到 Azure。</span><span class="sxs-lookup"><span data-stu-id="47597-111">You will also learn how to call the Graph API to get information about the currently signed-in user and how to deploy the application to Azure.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="47597-112">系统必备</span><span class="sxs-lookup"><span data-stu-id="47597-112">Prerequisites</span></span>

1. <span data-ttu-id="47597-113">[Visual Studio Express 2013 for Web](https://www.microsoft.com/visualstudio/eng/2013-downloads#d-2013-express)或[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/2013-downloads)。</span><span class="sxs-lookup"><span data-stu-id="47597-113">[Visual Studio Express 2013 for Web](https://www.microsoft.com/visualstudio/eng/2013-downloads#d-2013-express) or [Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/2013-downloads).</span></span>
2. <span data-ttu-id="47597-114">[Visual Studio 2013 Update 4](https://www.microsoft.com/download/details.aspx?id=44921) -3 或更高版本的更新是必需的。</span><span class="sxs-lookup"><span data-stu-id="47597-114">[Visual Studio 2013 Update 4](https://www.microsoft.com/download/details.aspx?id=44921) - Update 3 or higher is required.</span></span>
3. <span data-ttu-id="47597-115">一个 Azure 帐户。</span><span class="sxs-lookup"><span data-stu-id="47597-115">An Azure account.</span></span> <span data-ttu-id="47597-116">[单击此处](https://azure.microsoft.com/pricing/free-trial/)免费试用版，如果你还没有帐户。</span><span class="sxs-lookup"><span data-stu-id="47597-116">[Click here](https://azure.microsoft.com/pricing/free-trial/) for a free trial if you do not already have an account.</span></span>

## <a name="add-a-global-administrator-to-your-active-directory"></a><span data-ttu-id="47597-117">将全局管理员添加到你的 Active Directory</span><span class="sxs-lookup"><span data-stu-id="47597-117">Add a Global Administrator to your Active Directory</span></span>

1. <span data-ttu-id="47597-118">登录到[Azure 管理门户](https://manage.windowsazure.com/)。</span><span class="sxs-lookup"><span data-stu-id="47597-118">Sign in to the [Azure Management Portal](https://manage.windowsazure.com/).</span></span>
2. <span data-ttu-id="47597-119">所有 Azure 帐户包含**默认目录**-单击它，然后单击**用户**页顶部的选项卡 （请参阅下图所示）。</span><span class="sxs-lookup"><span data-stu-id="47597-119">All Azure accounts contain a **Default Directory** -- click on it, then click the **Users** tab at the top of the page (see image below).</span></span>
3. <span data-ttu-id="47597-120">单击添加用户。</span><span class="sxs-lookup"><span data-stu-id="47597-120">Click Add User.</span></span>  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image1.png)
4. <span data-ttu-id="47597-121">创建的新用户**全局管理员**角色。</span><span class="sxs-lookup"><span data-stu-id="47597-121">Create a new user with the **Global Administrator** role.</span></span> <span data-ttu-id="47597-122">单击**用户**从顶部菜单中，然后单击**添加用户**命令栏上的按钮。</span><span class="sxs-lookup"><span data-stu-id="47597-122">Click **Users** from the top menu, and then click the **Add User** button on the command bar.</span></span>
5. <span data-ttu-id="47597-123">在**添加用户**对话框中，输入新用户的名称，然后单击右箭头。</span><span class="sxs-lookup"><span data-stu-id="47597-123">In the **Add User** dialog, enter a name for the new user and then click the right arrow.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image2.png)
6. <span data-ttu-id="47597-124">输入的用户名和角色设置为**全局管理员**。</span><span class="sxs-lookup"><span data-stu-id="47597-124">Enter the user name and set the role to **Global Administrator**.</span></span> <span data-ttu-id="47597-125">全局管理员的密码恢复目的需要备用电子邮件地址。</span><span class="sxs-lookup"><span data-stu-id="47597-125">Global administrators require an alternate email address for password recovery purposes.</span></span> <span data-ttu-id="47597-126">完成后后，单击右箭头。</span><span class="sxs-lookup"><span data-stu-id="47597-126">After you're finished, click the right arrow.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image3.png)
7. <span data-ttu-id="47597-127">在对话框的下一页上，单击**创建**。</span><span class="sxs-lookup"><span data-stu-id="47597-127">On the next page of the dialog, click **Create**.</span></span> <span data-ttu-id="47597-128">将为新用户创建和对话框中显示临时密码。</span><span class="sxs-lookup"><span data-stu-id="47597-128">A temporary password will be created for the new user and displayed in the dialog.</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image4.png)  
  
   <span data-ttu-id="47597-129">保存密码，你将需要在首次登录后更改的密码。</span><span class="sxs-lookup"><span data-stu-id="47597-129">Save the password, you will be required to change the password after the first log in.</span></span> <span data-ttu-id="47597-130">下图显示了新的管理员帐户。</span><span class="sxs-lookup"><span data-stu-id="47597-130">The following image shows the new admin account.</span></span> <span data-ttu-id="47597-131">你必须使用 Azure Active Directory 登录到你的应用程序，不也显示此页上的 Microsoft 帐户。</span><span class="sxs-lookup"><span data-stu-id="47597-131">You must use the Azure Active Directory to log into your app, not the Microsoft account also shown on this page.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image5.png)

## <a name="create-an-aspnet-application"></a><span data-ttu-id="47597-132">创建 ASP.NET 应用程序</span><span class="sxs-lookup"><span data-stu-id="47597-132">Create an ASP.NET Application</span></span>

<span data-ttu-id="47597-133">以下步骤使用[Visual Studio Express 2013 for Web](https://www.microsoft.com/download/details.aspx?id=40747)，并且需要[Visual Studio 2013 Update 3](https://www.microsoft.com/download/details.aspx?id=43721)。</span><span class="sxs-lookup"><span data-stu-id="47597-133">The following steps use [Visual Studio Express 2013 for Web](https://www.microsoft.com/download/details.aspx?id=40747), and requires [Visual Studio 2013 Update 3](https://www.microsoft.com/download/details.aspx?id=43721).</span></span>

1. <span data-ttu-id="47597-134">在 Visual Studio 中，单击**文件**然后**新项目**。</span><span class="sxs-lookup"><span data-stu-id="47597-134">In Visual Studio, click **File** and then **New Project**.</span></span> <span data-ttu-id="47597-135">上**新项目**对话框中，选择 Visual C# Web 项目从左侧菜单，然后单击**确定**。</span><span class="sxs-lookup"><span data-stu-id="47597-135">On the **New Project** dialog, select the Visual C# Web project from the left menu and click **OK**.</span></span> <span data-ttu-id="47597-136">你可能还想取消选中**向项目添加 Application Insights**如果你不希望你的应用程序的功能。</span><span class="sxs-lookup"><span data-stu-id="47597-136">You may also want to uncheck the **Add Application Insights to Project** if you don't want the functionality for your application.</span></span>
2. <span data-ttu-id="47597-137">在**新建 ASP.NET 项目**对话框中，选择**MVC**，然后单击**更改身份验证**。</span><span class="sxs-lookup"><span data-stu-id="47597-137">In the **New ASP.NET Project** dialog, select **MVC**, and then click **Change Authentication**.</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image6.png)
3. <span data-ttu-id="47597-138">上**更改身份验证**对话框中，选择**组织帐户**。</span><span class="sxs-lookup"><span data-stu-id="47597-138">On the **Change Authentication** dialog, select **Organizational Accounts**.</span></span> <span data-ttu-id="47597-139">这些选项可以用于自动向 Azure AD 中注册你的应用程序，以及自动配置你的应用程序与 Azure AD 集成。</span><span class="sxs-lookup"><span data-stu-id="47597-139">These options can be used to automatically register your application with Azure AD as well as automatically configure your application to integrate with Azure AD.</span></span> <span data-ttu-id="47597-140">无需使用**更改身份验证**对话框来注册和配置你的应用程序，但它可以更轻松。</span><span class="sxs-lookup"><span data-stu-id="47597-140">You don't have to use the **Change Authentication** dialog to register and configure your application, but it makes it much easier.</span></span> <span data-ttu-id="47597-141">如果正在使用 Visual Studio 2012，例如所示，可以仍手动在 Azure 管理门户中注册应用程序和更新其配置以与 Azure AD 集成。</span><span class="sxs-lookup"><span data-stu-id="47597-141">If you are using Visual Studio 2012 for example, you can still manually register the application in the Azure Management Portal and update its configuration to integrate with Azure AD.</span></span>  
   <span data-ttu-id="47597-142">在下拉列表菜单中，选择**云-单个组织**和**单一登录，读取目录数据**。</span><span class="sxs-lookup"><span data-stu-id="47597-142">In the drop-down menus, select **Cloud - Single Organization** and **Single Sign On, Read directory data**.</span></span> <span data-ttu-id="47597-143">输入你的 Azure AD 目录，例如 （在下面的映像） 的域*aricka0yahoo.onmicrosoft.com*，然后单击**确定**。</span><span class="sxs-lookup"><span data-stu-id="47597-143">Enter the domain for your Azure AD directory, for example (in the images below) *aricka0yahoo.onmicrosoft.com*, and then click **OK**.</span></span> <span data-ttu-id="47597-144">可以在 azure 门户的默认目录从域选项卡中获取的域名 （向下，请参阅下一步的映像）。</span><span class="sxs-lookup"><span data-stu-id="47597-144">You can get the domain name from the Domains tab for the Default Directory on the azure portal (see the next image down).</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image7.png)  
  
   <span data-ttu-id="47597-145">下图显示在 Azure 门户中的域名。</span><span class="sxs-lookup"><span data-stu-id="47597-145">The following image shows the domain name from the Azure portal.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image8.png)  

    > [!NOTE]
    > <span data-ttu-id="47597-146">你可以选择配置通过单击将在 Azure AD 中注册应用程序 ID URI**更多选项**。</span><span class="sxs-lookup"><span data-stu-id="47597-146">You can optionally configure the Application ID URI that will be registered in Azure AD by clicking **More Options**.</span></span> <span data-ttu-id="47597-147">应用程序 ID URI 是应用程序，这是在 Azure AD 中注册并且应用程序用于与 Azure AD 通信时自身标识的唯一标识符。</span><span class="sxs-lookup"><span data-stu-id="47597-147">The App ID URI is the unique identifier for an application, which is registered in Azure AD and used by the application to identify itself when communicating with Azure AD.</span></span> <span data-ttu-id="47597-148">有关应用程序 ID URI 和已注册应用程序的其他属性的详细信息，请参阅[本主题](https://msdn.microsoft.com/library/azure/dn499820.aspx#BKMK_Registering)。</span><span class="sxs-lookup"><span data-stu-id="47597-148">For more information about the App ID URI and other properties of registered applications, see [this topic](https://msdn.microsoft.com/library/azure/dn499820.aspx#BKMK_Registering).</span></span> <span data-ttu-id="47597-149">通过单击应用程序 ID URI 字段的下方的复选框，你还可以选择在使用相同的应用程序 ID URI 的 Azure AD 中覆盖现有注册。</span><span class="sxs-lookup"><span data-stu-id="47597-149">By clicking the checkbox below the App ID URI field, you can also choose to overwrite an existing registration in Azure AD that uses the same App ID URI.</span></span>
4. <span data-ttu-id="47597-150">单击后**确定**，将显示一个登录对话框，并且将需要使用全局管理员帐户 （不与你的订阅关联的 Microsoft 帐户） 登录。</span><span class="sxs-lookup"><span data-stu-id="47597-150">After clicking **OK**, a sign-in dialog will appear, and you'll need to sign in using a Global Administrator account (not the Microsoft account associated with your subscription).</span></span> <span data-ttu-id="47597-151">如果你之前创建新的管理员帐户，你将需要更改密码并再次使用新密码，然后登录。</span><span class="sxs-lookup"><span data-stu-id="47597-151">If you created a new Administrator account earlier, you'll be required to change the password and then sign in again using the new password.</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image9.png)
5. <span data-ttu-id="47597-152">你已成功通过身份验证后，**新建 ASP.NET 项目**对话框将显示你的身份验证选择 (**组织**) 和新的应用程序将在其中的目录注册 (*aricka0yahoo.onmicrosoft.com*图所示)。</span><span class="sxs-lookup"><span data-stu-id="47597-152">After you've successfully authenticated, the **New ASP.NET Project** dialog will show your authentication choice (**Organizational** ) and the directory where the new application will be registered (*aricka0yahoo.onmicrosoft.com* in the image below).</span></span> <span data-ttu-id="47597-153">此信息，下面选择标记为复选框**在云中托管**。</span><span class="sxs-lookup"><span data-stu-id="47597-153">Below this information, select the checkbox labeled **Host in the cloud**.</span></span> <span data-ttu-id="47597-154">如果选择此复选框，则项目将设置为 Azure web 应用和将启用用于轻松发布更高版本。</span><span class="sxs-lookup"><span data-stu-id="47597-154">If this checkbox is selected, the project will be provisioned as an Azure web app and will be enabled for easy publishing later.</span></span> <span data-ttu-id="47597-155">单击 **“确定”**。</span><span class="sxs-lookup"><span data-stu-id="47597-155">Click **OK**.</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image10.png)
6. <span data-ttu-id="47597-156">**配置 Azure 网站**对话框将出现，并使用自动生成站点名称和区域。</span><span class="sxs-lookup"><span data-stu-id="47597-156">The **Configure Azure Website** dialog will appear, using an auto-generated site name and region.</span></span> <span data-ttu-id="47597-157">另请注意你当前登录对话框中的帐户。</span><span class="sxs-lookup"><span data-stu-id="47597-157">Also note the account you're currently signed into in the dialog.</span></span> <span data-ttu-id="47597-158">你想要确保此帐户是一个你的 Azure 订阅连接到，通常的 Microsoft 帐户。</span><span class="sxs-lookup"><span data-stu-id="47597-158">You want to make sure that this account is the one that your Azure subscription is attached to, typically a Microsoft account.</span></span>

    > [!NOTE]
    > <span data-ttu-id="47597-159">此项目需要一个数据库。</span><span class="sxs-lookup"><span data-stu-id="47597-159">This project requires a database.</span></span> <span data-ttu-id="47597-160">你需要选择一个现有的数据库，或创建一个新。</span><span class="sxs-lookup"><span data-stu-id="47597-160">You need to select one of your existing databases, or create a new one.</span></span> <span data-ttu-id="47597-161">数据库是必需的因为该项目已使用本地数据库文件存储少量的身份验证配置数据。</span><span class="sxs-lookup"><span data-stu-id="47597-161">A database is required because the project already uses a local database file to store a small amount of authentication configuration data.</span></span> <span data-ttu-id="47597-162">在部署到 Azure 网站应用程序时，此数据库未附带部署，因此你需要选择一个可访问位于云中。</span><span class="sxs-lookup"><span data-stu-id="47597-162">When you deploy the application to an Azure Website, this database isn't packaged with the deployment, so you need to choose one that's accessible in the cloud.</span></span> <span data-ttu-id="47597-163">单击 **“确定”**。</span><span class="sxs-lookup"><span data-stu-id="47597-163">Click **OK**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image11.png)
7. <span data-ttu-id="47597-164">将创建该项目，并且你的身份验证选项和 web 应用程序选项将自动配置与项目。</span><span class="sxs-lookup"><span data-stu-id="47597-164">The project will be created, and your authentication options and web app options will be automatically configured with the project.</span></span> <span data-ttu-id="47597-165">此过程完成后，通过按以本地方式运行该项目**^ F5**。</span><span class="sxs-lookup"><span data-stu-id="47597-165">Once this process has completed, run the project locally by pressing **^F5**.</span></span> <span data-ttu-id="47597-166">你将需要使用你的组织帐户进行登录。</span><span class="sxs-lookup"><span data-stu-id="47597-166">You will be required to sign in using your organizational account.</span></span> <span data-ttu-id="47597-167">为前面创建的帐户提供的用户名和密码，单击**登录**。</span><span class="sxs-lookup"><span data-stu-id="47597-167">Provide the username and password for the account you created earlier and click **Sign in**.</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image12.png)
8. <span data-ttu-id="47597-168">在成功登录之后, 将显示 ASP.NET 站点，您已通过在页面右上角中显示用户名身份验证。</span><span class="sxs-lookup"><span data-stu-id="47597-168">After successful sign in, the ASP.NET site will show that you've authenticated by displaying the username in the top right corner of the page.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image13.png)  
  
   <span data-ttu-id="47597-169">如果收到错误：</span><span class="sxs-lookup"><span data-stu-id="47597-169">If you get the error:</span></span>  
   <span data-ttu-id="47597-170">值不能为 null 或为空。</span><span class="sxs-lookup"><span data-stu-id="47597-170">Value cannot be null or empty.</span></span> <span data-ttu-id="47597-171">参数名称： linkText</span><span class="sxs-lookup"><span data-stu-id="47597-171">Parameter name: linkText</span></span>   
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image14.png)  
  
   <span data-ttu-id="47597-172">请参阅[调试](#dbg)在本教程末尾的部分。</span><span class="sxs-lookup"><span data-stu-id="47597-172">see the [debug](#dbg) section at the end of the tutorial.</span></span>

## <a name="basics-of-the-graph-api"></a><span data-ttu-id="47597-173">Graph API 基础知识</span><span class="sxs-lookup"><span data-stu-id="47597-173">Basics of the Graph API</span></span>

<span data-ttu-id="47597-174">[Graph API](https://msdn.microsoft.com/library/azure/hh974476.aspx)是用于在你的 Azure AD 目录中执行 CRUD 和其他操作在对象上的编程接口。</span><span class="sxs-lookup"><span data-stu-id="47597-174">[The Graph API](https://msdn.microsoft.com/library/azure/hh974476.aspx) is the programmatic interface used to perform CRUD and other operations on objects in your Azure AD directory.</span></span> <span data-ttu-id="47597-175">如果你选择用于身份验证的组织帐户选项，在 Visual Studio 2013 中创建新项目时，已将配置应用程序以调用 Graph API。</span><span class="sxs-lookup"><span data-stu-id="47597-175">If you select an Organizational Account option for authentication when creating a new project in Visual Studio 2013, your application will already be configured to call the Graph API.</span></span> <span data-ttu-id="47597-176">本部分简要说明 Graph API 的工作原理。</span><span class="sxs-lookup"><span data-stu-id="47597-176">This section briefly shows you how the Graph API works.</span></span>

1. <span data-ttu-id="47597-177">在你运行的应用程序，单击顶部的登录用户名称页面右上角。</span><span class="sxs-lookup"><span data-stu-id="47597-177">In your running application, click on the name of the signed-in user at the top right of the page.</span></span> <span data-ttu-id="47597-178">这将转到用户配置文件页上，这是在主页控制器上的操作。</span><span class="sxs-lookup"><span data-stu-id="47597-178">This will take you to the User Profile page, which is an action on the Home Controller.</span></span> <span data-ttu-id="47597-179">你会注意到表中包含你前面创建的管理员帐户有关的用户信息。</span><span class="sxs-lookup"><span data-stu-id="47597-179">You'll notice that the table contains user information about the administrator account you created earlier.</span></span> <span data-ttu-id="47597-180">此信息存储在你的目录，并调用图形 API 来加载页面时检索此信息。</span><span class="sxs-lookup"><span data-stu-id="47597-180">This information is stored in your directory, and the Graph API is called to retrieve this information when the page loads.</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image15.png)
2. <span data-ttu-id="47597-181">返回到 Visual Studio 并展开**控制器**文件夹，然后打开**HomeController.cs**文件。</span><span class="sxs-lookup"><span data-stu-id="47597-181">Go back to Visual Studio and expand the **Controllers** folder and then open the **HomeController.cs** file.</span></span> <span data-ttu-id="47597-182">你将看到**UserProfile()**包含代码，以检索令牌，然后调用 Graph API 的操作。</span><span class="sxs-lookup"><span data-stu-id="47597-182">You'll see a **UserProfile()** action that contains code to retrieve a token and then call the Graph API.</span></span> <span data-ttu-id="47597-183">下面被复制此代码：</span><span class="sxs-lookup"><span data-stu-id="47597-183">This code is duplicated below:</span></span> 

    [!code-csharp[Main](developing-aspnet-apps-with-windows-azure-active-directory/samples/sample1.cs?highlight=22)]

    <span data-ttu-id="47597-184">若要调用 Graph API，首先需要检索令牌。</span><span class="sxs-lookup"><span data-stu-id="47597-184">To call the Graph API, you first need to retrieve a token.</span></span> <span data-ttu-id="47597-185">检索令牌时，必须在对 Graph API 的所有后续请求的 Authorization 标头中附加其字符串值。</span><span class="sxs-lookup"><span data-stu-id="47597-185">When the token is retrieved, its string value must be appended in the Authorization header for all subsequent requests to the Graph API.</span></span> <span data-ttu-id="47597-186">大部分上面的代码处理对 Azure AD，以获取令牌进行身份验证，使用令牌调用 Graph API，以及然后转换响应，以便它可以出现在视图中的详细信息。</span><span class="sxs-lookup"><span data-stu-id="47597-186">Most of the code above handles the details of authenticating to Azure AD to get a token, using the token to make a call to the Graph API, and then transforming the response so that it can be presented in the View.</span></span>

    <span data-ttu-id="47597-187">有关讨论最相关的部分是以下突出显示的行将： `UserProfile profile = JsonConvert.DeserializeObject<UserProfile>(responseString);`。</span><span class="sxs-lookup"><span data-stu-id="47597-187">The most relevant portion for discussion is the following highlighted line: `UserProfile profile = JsonConvert.DeserializeObject<UserProfile>(responseString);`.</span></span> <span data-ttu-id="47597-188">这条线表示的用户，这就已反序列化 JSON 响应中，会显示在视图中的名称。</span><span class="sxs-lookup"><span data-stu-id="47597-188">This line represents the name of the user, which has been deserialized from the JSON response and is presented in the View.</span></span>

    <span data-ttu-id="47597-189">您可以调用 Graph API 使用 HttpClient 自己并处理原始数据，但更简单的方法是使用[Graph 客户端库，该库可通过 NuGet](http://www.nuget.org/packages/Microsoft.Azure.ActiveDirectory.GraphClient/)。</span><span class="sxs-lookup"><span data-stu-id="47597-189">You can call the Graph API using HttpClient and handle the raw data yourself, but an easier way is to use the [Graph Client Library which is available via NuGet](http://www.nuget.org/packages/Microsoft.Azure.ActiveDirectory.GraphClient/).</span></span> <span data-ttu-id="47597-190">客户端库处理原始 HTTP 请求和返回的数据为你的转换，并使其可以更轻松地使用 Graph API 在.NET 环境中工作。</span><span class="sxs-lookup"><span data-stu-id="47597-190">The Client Library handles the raw HTTP requests and the transformation of the returned data for you, and makes it much easier to work with the Graph API in a .NET environment.</span></span> <span data-ttu-id="47597-191">请参阅上相关的 Graph API 代码示例[GitHub。](https://github.com/AzureADSamples)</span><span class="sxs-lookup"><span data-stu-id="47597-191">See the related Graph API code samples on [GitHub.](https://github.com/AzureADSamples)</span></span>

## <a name="deploy-the-application-to-azure"></a><span data-ttu-id="47597-192">部署到 Azure 应用程序</span><span class="sxs-lookup"><span data-stu-id="47597-192">Deploy the Application to Azure</span></span>

<span data-ttu-id="47597-193">以下步骤将演示如何部署到 Azure 应用程序。</span><span class="sxs-lookup"><span data-stu-id="47597-193">The following steps will show you how to deploy the application to Azure.</span></span> <span data-ttu-id="47597-194">在前面的步骤中，你将新项目连接与 web 应用程序在 Azure 上，以便随时可在几个步骤中发布。</span><span class="sxs-lookup"><span data-stu-id="47597-194">In the earlier steps, you connected your new project with a web app on Azure, so it's ready to be published in just a few steps.</span></span>

1. <span data-ttu-id="47597-195">在 Visual Studio 中，右键单击项目并选择**发布**。</span><span class="sxs-lookup"><span data-stu-id="47597-195">In Visual Studio, right-click on the project and select **Publish**.</span></span> <span data-ttu-id="47597-196">**发布 Web**对话框将显示与每个已配置的设置。</span><span class="sxs-lookup"><span data-stu-id="47597-196">The **Publish Web** dialog will appear with each setting already configured.</span></span> <span data-ttu-id="47597-197">单击**下一步**按钮转到**设置**页。</span><span class="sxs-lookup"><span data-stu-id="47597-197">Click on the **Next** button to go to the **Settings** page.</span></span> <span data-ttu-id="47597-198">可能会提示你进行身份验证;请确保你进行身份验证使用你的 Azure 订阅帐户 （通常是 Microsoft 帐户） 而不是前面创建的组织帐户。</span><span class="sxs-lookup"><span data-stu-id="47597-198">You may be prompted to authenticate; make sure you authenticate using your Azure subscription account (typically a Microsoft account) and not the organizational account you created earlier.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image16.png)
2. <span data-ttu-id="47597-199">检查**启用组织身份验证**选项。</span><span class="sxs-lookup"><span data-stu-id="47597-199">Check the **Enable Organizational Authentication** option.</span></span> <span data-ttu-id="47597-200">在**域**字段中，输入你的目录的域。</span><span class="sxs-lookup"><span data-stu-id="47597-200">In the **Domain** field, enter the domain for your directory.</span></span> <span data-ttu-id="47597-201">从**访问级别**下拉列表中，选择**单一登录，读取目录数据**。</span><span class="sxs-lookup"><span data-stu-id="47597-201">From the **Access Level** drop-down, select **Single Sign On, Read directory data**.</span></span> <span data-ttu-id="47597-202">你会注意到你使用的上一个数据库在已填充**数据库**部分。</span><span class="sxs-lookup"><span data-stu-id="47597-202">You'll notice that the previous database you used is already populated in the **Databases** section.</span></span> <span data-ttu-id="47597-203">单击“发布” 。</span><span class="sxs-lookup"><span data-stu-id="47597-203">Click **Publish**.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image17.png)
3. <span data-ttu-id="47597-204">Visual Studio 将会开始部署你的网站，，然后将出现一个新的浏览器窗口。</span><span class="sxs-lookup"><span data-stu-id="47597-204">Visual Studio will begin deploying your website, and then a new browser window will appear.</span></span> <span data-ttu-id="47597-205">你可能会提示重新进行身份验证对你的目录一次。</span><span class="sxs-lookup"><span data-stu-id="47597-205">You may be prompted to authenticate to your directory once again.</span></span> <span data-ttu-id="47597-206">一旦你已通过身份验证，你将重定向到新发布的网站在 Azure 上。</span><span class="sxs-lookup"><span data-stu-id="47597-206">Once you've authenticated, you'll be redirected to your newly published website on Azure.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image18.png)

<a id="dbg"></a>
## <a name="debugging-the-app"></a><span data-ttu-id="47597-207">调试应用程序</span><span class="sxs-lookup"><span data-stu-id="47597-207">Debugging the app</span></span>

<span data-ttu-id="47597-208">如果你收到以下错误：</span><span class="sxs-lookup"><span data-stu-id="47597-208">If you get the following error:</span></span>   
 <span data-ttu-id="47597-209">值不能为 null 或为空。</span><span class="sxs-lookup"><span data-stu-id="47597-209">Value cannot be null or empty.</span></span> <span data-ttu-id="47597-210">参数名称： linkText</span><span class="sxs-lookup"><span data-stu-id="47597-210">Parameter name: linkText</span></span>   
   
![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image19.png)  
  

<span data-ttu-id="47597-211">中的代码替换*views/shared\\_LoginPartial.cshtml*替换为以下文件：</span><span class="sxs-lookup"><span data-stu-id="47597-211">Replace the code in the *Views\Shared\\_LoginPartial.cshtml* file with the following:</span></span>

[!code-cshtml[Main](developing-aspnet-apps-with-windows-azure-active-directory/samples/sample2.cshtml?highlight=1-8,15-16)]

<span data-ttu-id="47597-212">后运行该应用程序，如果在已登录的用户显示"Null 用户"，请注销，然后重新登录之前创建的 Active Directory 帐户。</span><span class="sxs-lookup"><span data-stu-id="47597-212">After running the app, if the logged in user shows "Null User", sign out, and sign back in with the Active Directory account you created earlier.</span></span>

<span data-ttu-id="47597-213">要遵循的绝佳教程是 Rick Rainey[深入了解： Azure 网站和组织使用 Azure AD 的身份验证](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/)。</span><span class="sxs-lookup"><span data-stu-id="47597-213">An excellent tutorial to follow is Rick Rainey's [Deep Dive: Azure Websites and Organizational Authentication using Azure AD](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/).</span></span>

## <a name="more-information"></a><span data-ttu-id="47597-214">详细信息</span><span class="sxs-lookup"><span data-stu-id="47597-214">More Information</span></span>

- [<span data-ttu-id="47597-215">深入探讨： 在 Azure 网站和组织使用 Azure AD 的身份验证</span><span class="sxs-lookup"><span data-stu-id="47597-215">Deep Dive: Azure Websites and Organizational Authentication using Azure AD</span></span>](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/)
- [<span data-ttu-id="47597-216">Azure AD Graph API 概述</span><span class="sxs-lookup"><span data-stu-id="47597-216">Azure AD Graph API Overview</span></span>](https://msdn.microsoft.com/library/azure/hh974476.aspx)
- [<span data-ttu-id="47597-217">Azure AD 中的身份验证方案</span><span class="sxs-lookup"><span data-stu-id="47597-217">Authentication Scenarios in Azure AD</span></span>](https://msdn.microsoft.com/library/azure/dn499820.aspx)
- [<span data-ttu-id="47597-218">GitHub 上的 azure AD 代码示例</span><span class="sxs-lookup"><span data-stu-id="47597-218">Azure AD Code Samples on GitHub</span></span>](https://github.com/AzureADSamples)
