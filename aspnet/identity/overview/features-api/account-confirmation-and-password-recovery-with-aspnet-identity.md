---
uid: identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
title: 帐户确认和密码恢复具有 ASP.NET 标识 (C#) |Microsoft 文档
author: HaoK
description: 在进行你应首先完成本教程之前具有登录、 电子邮件确认及密码重置创建安全的 ASP.NET MVC 5 web 应用程序。 本教程中...
ms.author: aspnetcontent
manager: wpickett
ms.date: 03/26/2015
ms.topic: article
ms.assetid: 8d54180d-f826-4df7-b503-7debf5ed9fb3
ms.technology: ''
ms.prod: .net-framework
msc.legacyurl: /identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 0167388cf6b488b72ca36f583a7794690dbf9900
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/06/2018
---
<a name="account-confirmation-and-password-recovery-with-aspnet-identity-c"></a><span data-ttu-id="9f177-104">帐户确认和密码恢复 ASP.NET 标识 (C#)</span><span class="sxs-lookup"><span data-stu-id="9f177-104">Account Confirmation and Password Recovery with ASP.NET Identity (C#)</span></span>
====================
<span data-ttu-id="9f177-105">通过[Hao 永远](https://github.com/HaoK)， [Pranav Rastogi](https://github.com/rustd)， [Rick Anderson](https://github.com/Rick-Anderson)， [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="9f177-105">by [Hao Kung](https://github.com/HaoK), [Pranav Rastogi](https://github.com/rustd), [Rick Anderson](https://github.com/Rick-Anderson), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="9f177-106">在学习本教程之前你应首先完成[创建安全的 ASP.NET MVC 5 web 应用程序具有登录、 电子邮件确认及密码重置](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md)。</span><span class="sxs-lookup"><span data-stu-id="9f177-106">Before doing this tutorial you should first complete [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span></span> <span data-ttu-id="9f177-107">本教程包含更多详细信息，并将向你演示如何设置本地帐户确认的电子邮件，并允许用户在 ASP.NET Identity 中的忘记了的密码重置。</span><span class="sxs-lookup"><span data-stu-id="9f177-107">This tutorial contains more details and will show you how to set up email for local account confirmation and allow users to reset their forgotten password in ASP.NET Identity.</span></span> <span data-ttu-id="9f177-108">由 Rick Anderson 撰写本文时 ([@RickAndMSFT](https://twitter.com/#!/RickAndMSFT))，Pranav Rastogi ([@rustd](https://twitter.com/rustd))，Hao 永远和 Suhas Joshi。</span><span class="sxs-lookup"><span data-stu-id="9f177-108">This article was written by Rick Anderson ([@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)), Pranav Rastogi ([@rustd](https://twitter.com/rustd)), Hao Kung, and Suhas Joshi.</span></span> <span data-ttu-id="9f177-109">NuGet 示例主要由 Hao 永远编写。</span><span class="sxs-lookup"><span data-stu-id="9f177-109">The NuGet sample was written primarily by Hao Kung.</span></span>


<span data-ttu-id="9f177-110">本地用户帐户要求用户创建的帐户密码，该密码 （安全） 存储在 web 应用。</span><span class="sxs-lookup"><span data-stu-id="9f177-110">A local user account requires the user to create a password for the account, and that password is stored (securely) in the web app.</span></span> <span data-ttu-id="9f177-111">ASP.NET 标识还支持社交帐户，不需要用户创建应用程序的密码。</span><span class="sxs-lookup"><span data-stu-id="9f177-111">ASP.NET Identity also supports social accounts, which don't require the user to create a password for the app.</span></span> <span data-ttu-id="9f177-112">[社交帐户](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)使用第三方 （如 Google、 Twitter、 Facebook 或 Microsoft） 用户进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="9f177-112">[Social accounts](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) use a third party (such as Google, Twitter, Facebook or Microsoft) to authenticate users.</span></span> <span data-ttu-id="9f177-113">本主题涵盖以下方面：</span><span class="sxs-lookup"><span data-stu-id="9f177-113">This topic covers the following:</span></span>

- <span data-ttu-id="9f177-114">[创建的 ASP.NET MVC 应用](#createMvc)和浏览 ASP.NET 标识功能。</span><span class="sxs-lookup"><span data-stu-id="9f177-114">[Create an ASP.NET MVC app](#createMvc) and explore ASP.NET Identity features.</span></span>
- [<span data-ttu-id="9f177-115">生成标识示例</span><span class="sxs-lookup"><span data-stu-id="9f177-115">Building the Identity sample</span></span>](#build)
- [<span data-ttu-id="9f177-116">设置电子邮件确认</span><span class="sxs-lookup"><span data-stu-id="9f177-116">Set up email confirmation</span></span>](#email)

<span data-ttu-id="9f177-117">新用户注册其电子邮件别名，这将创建本地帐户。</span><span class="sxs-lookup"><span data-stu-id="9f177-117">New users register their email alias, which creates a local account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image1.png)

<span data-ttu-id="9f177-118">单击注册按钮会将发送确认电子邮件包含到其电子邮件地址的验证令牌。</span><span class="sxs-lookup"><span data-stu-id="9f177-118">Clicking the Register button sends a confirmation email containing a validation token to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image2.png)

<span data-ttu-id="9f177-119">向用户发送包含其帐户的确认令牌的电子邮件。</span><span class="sxs-lookup"><span data-stu-id="9f177-119">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image3.png)

<span data-ttu-id="9f177-120">单击链接确认该帐户。</span><span class="sxs-lookup"><span data-stu-id="9f177-120">Clicking the link confirms the account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image4.png)

<a id="passwordReset"></a>

## <a name="password-recoveryreset"></a><span data-ttu-id="9f177-121">密码恢复/重置</span><span class="sxs-lookup"><span data-stu-id="9f177-121">Password recovery/reset</span></span>

<span data-ttu-id="9f177-122">本地用户忘记其密码时都可以具有安全令牌发送到其电子邮件帐户，使他们能够重置其密码。</span><span class="sxs-lookup"><span data-stu-id="9f177-122">Local users who forget their password can have a security token sent to their email account, enabling them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image5.png)  
  
<span data-ttu-id="9f177-123">允许在它们重置其密码的链接，则用户很快将收到一封电子邮件。</span><span class="sxs-lookup"><span data-stu-id="9f177-123">The user will soon get an email with a link allowing them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image6.png)  
<span data-ttu-id="9f177-124">单击该链接会将他们重置页。</span><span class="sxs-lookup"><span data-stu-id="9f177-124">Clicking the link will take them to the Reset page.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image7.png)  
  
<span data-ttu-id="9f177-125">单击**重置**按钮将确认重置密码。</span><span class="sxs-lookup"><span data-stu-id="9f177-125">Clicking the **Reset** button will confirm the password has been reset.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image8.png)

<a id="createMvc"></a>

## <a name="create-an-aspnet-web-app"></a><span data-ttu-id="9f177-126">创建 ASP.NET Web 应用</span><span class="sxs-lookup"><span data-stu-id="9f177-126">Create an ASP.NET Web app</span></span>

<span data-ttu-id="9f177-127">首先，安装并运行[Visual Studio Express 2013 for Web](https://go.microsoft.com/fwlink/?LinkId=299058)或[Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566)。</span><span class="sxs-lookup"><span data-stu-id="9f177-127">Start by installing and running [Visual Studio Express 2013 for Web](https://go.microsoft.com/fwlink/?LinkId=299058) or [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566).</span></span> <span data-ttu-id="9f177-128">安装 Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521)或更高版本。</span><span class="sxs-lookup"><span data-stu-id="9f177-128">Install Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) or higher.</span></span>

> [!NOTE]
> <span data-ttu-id="9f177-129">警告： 你必须安装 Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521)来完成本教程。</span><span class="sxs-lookup"><span data-stu-id="9f177-129">Warning: You must install Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) to complete this tutorial.</span></span>


1. <span data-ttu-id="9f177-130">创建一个新的 ASP.NET Web 项目，然后选择 MVC 模板中。</span><span class="sxs-lookup"><span data-stu-id="9f177-130">Create a new ASP.NET Web project and select the MVC template.</span></span> <span data-ttu-id="9f177-131">Web 窗体还支持 ASP.NET 标识，因此无法执行类似的步骤，在 web 窗体应用程序中。</span><span class="sxs-lookup"><span data-stu-id="9f177-131">Web Forms also supports ASP.NET Identity, so you could follow similar steps in a web forms app.</span></span>
2. <span data-ttu-id="9f177-132">保留默认的身份验证作为**单个用户帐户**。</span><span class="sxs-lookup"><span data-stu-id="9f177-132">Leave the default authentication as **Individual User Accounts**.</span></span>
3. <span data-ttu-id="9f177-133">运行应用程序，请单击**注册**链接并注册用户。</span><span class="sxs-lookup"><span data-stu-id="9f177-133">Run the app, click the **Register** link and register a user.</span></span> <span data-ttu-id="9f177-134">此时，电子邮件的唯一验证是使用[[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx)属性。</span><span class="sxs-lookup"><span data-stu-id="9f177-134">At this point, the only validation on the email is with the [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) attribute.</span></span>
4. <span data-ttu-id="9f177-135">在服务器资源管理器，导航到**数据 Connections\DefaultConnection\Tables\AspNetUsers**，右键单击并选择**打开表定义**。</span><span class="sxs-lookup"><span data-stu-id="9f177-135">In Server Explorer, navigate to **Data Connections\DefaultConnection\Tables\AspNetUsers**, right click and select **Open table definition**.</span></span>

    <span data-ttu-id="9f177-136">下图显示`AspNetUsers`架构：</span><span class="sxs-lookup"><span data-stu-id="9f177-136">The following image shows the `AspNetUsers` schema:</span></span>

    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image9.png)
5. <span data-ttu-id="9f177-137">右键单击**AspNetUsers**表，然后选择**显示表数据**。</span><span class="sxs-lookup"><span data-stu-id="9f177-137">Right click on the **AspNetUsers** table and select **Show Table Data**.</span></span>  
  
    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image10.png)  
  
   <span data-ttu-id="9f177-138">此时不已确认电子邮件。</span><span class="sxs-lookup"><span data-stu-id="9f177-138">At this point the email has not been confirmed.</span></span>

<span data-ttu-id="9f177-139">ASP.NET 标识的默认数据存储是实体框架，但你可以配置为使用其他数据存储，以及添加其他字段。</span><span class="sxs-lookup"><span data-stu-id="9f177-139">The default data store for ASP.NET Identity is Entity Framework, but you can configure it to use other data stores and to add additional fields.</span></span> <span data-ttu-id="9f177-140">请参阅[其他资源](#addRes)在本教程末尾的部分。</span><span class="sxs-lookup"><span data-stu-id="9f177-140">See [Additional Resources](#addRes) section at the end of this tutorial.</span></span>

<span data-ttu-id="9f177-141">[OWIN startup 类](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md)( *Startup.cs* ) 时应用程序启动并调用调用`ConfigureAuth`中的方法*应用\_Start\Startup.Auth.cs*，用于配置 OWIN 管道，并初始化 ASP.NET 标识。</span><span class="sxs-lookup"><span data-stu-id="9f177-141">The [OWIN startup class](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) is called when the app starts and invokes the `ConfigureAuth` method in *App\_Start\Startup.Auth.cs*, which configures the OWIN pipeline and initializes ASP.NET Identity.</span></span> <span data-ttu-id="9f177-142">检查`ConfigureAuth`方法。</span><span class="sxs-lookup"><span data-stu-id="9f177-142">Examine the `ConfigureAuth` method.</span></span> <span data-ttu-id="9f177-143">每个`CreatePerOwinContext`调用注册的回调 (保存在`OwinContext`)，将调用一次每个请求来创建指定类型的实例。</span><span class="sxs-lookup"><span data-stu-id="9f177-143">Each `CreatePerOwinContext` call registers a callback (saved in the `OwinContext`) that will be called once per request to create an instance of the specified type.</span></span> <span data-ttu-id="9f177-144">你可以构造函数中设置一个断点和`Create`的每种类型的方法 (`ApplicationDbContext, ApplicationUserManager`) 并验证它们在每个请求上调用。</span><span class="sxs-lookup"><span data-stu-id="9f177-144">You can set a break point in the constructor and `Create` method of each type (`ApplicationDbContext, ApplicationUserManager`) and verify they are called on each request.</span></span> <span data-ttu-id="9f177-145">实例`ApplicationDbContext`和`ApplicationUserManager`存储在 OWIN 上下文中，可以在整个应用程序中访问。</span><span class="sxs-lookup"><span data-stu-id="9f177-145">A instance of `ApplicationDbContext` and `ApplicationUserManager` is stored in the OWIN context, which can be accessed throughout the application.</span></span> <span data-ttu-id="9f177-146">ASP.NET 标识挂钩到 OWIN 管道通过 cookie 中间件。</span><span class="sxs-lookup"><span data-stu-id="9f177-146">ASP.NET Identity hooks into the OWIN pipeline through cookie middleware.</span></span> <span data-ttu-id="9f177-147">有关详细信息，请参阅[每个请求 UserManager 在 ASP.NET Identity 中的类的生存期管理](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx)。</span><span class="sxs-lookup"><span data-stu-id="9f177-147">For more information, see [Per request lifetime management for UserManager class in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span></span>

<span data-ttu-id="9f177-148">当你更改你的安全配置文件时，请生成并存储在新的安全戳`SecurityStamp`字段*AspNetUsers*表。</span><span class="sxs-lookup"><span data-stu-id="9f177-148">When you change your security profile, a new security stamp is generated and stored in the `SecurityStamp` field of the *AspNetUsers* table.</span></span> <span data-ttu-id="9f177-149">请注意，`SecurityStamp`字段是不同的安全 cookie。</span><span class="sxs-lookup"><span data-stu-id="9f177-149">Note, the `SecurityStamp` field is different from the security cookie.</span></span> <span data-ttu-id="9f177-150">安全 cookie 不存储在`AspNetUsers`表 （或在标识数据库中的其他任何位置）。</span><span class="sxs-lookup"><span data-stu-id="9f177-150">The security cookie is not stored in the `AspNetUsers` table (or anywhere else in the Identity DB).</span></span> <span data-ttu-id="9f177-151">使用自签名安全 cookie 令牌[DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx)并使用创建`UserId, SecurityStamp`和过期时间信息。</span><span class="sxs-lookup"><span data-stu-id="9f177-151">The security cookie token is self-signed using [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) and is created with the `UserId, SecurityStamp` and expiration time information.</span></span>

<span data-ttu-id="9f177-152">Cookie 中间件检查每个请求上的 cookie。</span><span class="sxs-lookup"><span data-stu-id="9f177-152">The cookie middleware checks the cookie on each request.</span></span> <span data-ttu-id="9f177-153">`SecurityStampValidator`中的方法`Startup`类的命中率数据库和我们会定期检查安全戳指定与`validateInterval`。</span><span class="sxs-lookup"><span data-stu-id="9f177-153">The `SecurityStampValidator` method in the `Startup` class hits the DB and checks security stamp periodically, as specified with the `validateInterval`.</span></span> <span data-ttu-id="9f177-154">除非您更改安全配置文件，这仅发生 （在我们的示例） 每隔 30 分钟。</span><span class="sxs-lookup"><span data-stu-id="9f177-154">This only happens every 30 minutes (in our sample) unless you change your security profile.</span></span> <span data-ttu-id="9f177-155">30 分钟时间间隔内已选择最大程度减少对数据库的访问。</span><span class="sxs-lookup"><span data-stu-id="9f177-155">The 30 minute interval was chosen to minimize trips to the database.</span></span> <span data-ttu-id="9f177-156">请参阅我[双因素身份验证教程](index.md)有关详细信息。</span><span class="sxs-lookup"><span data-stu-id="9f177-156">See my [two-factor authentication tutorial](index.md) for more details.</span></span>

<span data-ttu-id="9f177-157">在代码中，注释每`UseCookieAuthentication`方法支持 cookie 身份验证。</span><span class="sxs-lookup"><span data-stu-id="9f177-157">Per the comments in the code, the `UseCookieAuthentication` method supports cookie authentication.</span></span> <span data-ttu-id="9f177-158">`SecurityStamp`字段和关联的代码提供了一层额外的向应用程序的安全性，如果你更改密码，你将记录超出您登录所用的浏览器。</span><span class="sxs-lookup"><span data-stu-id="9f177-158">The `SecurityStamp` field and associated code provides an extra layer of security to your app, when you change your password, you will be logged out of the browser you logged in with.</span></span> <span data-ttu-id="9f177-159">`SecurityStampValidator.OnValidateIdentity`方法使应用程序来验证安全令牌，当用户登录时更改密码或使用外部登录名时使用。</span><span class="sxs-lookup"><span data-stu-id="9f177-159">The `SecurityStampValidator.OnValidateIdentity` method enables the app to validate the security token when the user logs in, which is used when you change a password or use the external login.</span></span> <span data-ttu-id="9f177-160">需要这些信息来确保使用旧密码生成任何标记 (cookie) 将会失效。</span><span class="sxs-lookup"><span data-stu-id="9f177-160">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="9f177-161">在示例项目中，如果更改为用户生成的用户密码然后新的令牌，任何以前的令牌失效和`SecurityStamp`更新字段。</span><span class="sxs-lookup"><span data-stu-id="9f177-161">In the sample project, if you change the users password then a new token is generated for the user, any previous tokens are invalidated and the `SecurityStamp` field is updated.</span></span>

<span data-ttu-id="9f177-162">标识系统，可以配置你的应用，用户的安全配置文件更改时 (例如，当用户更改其密码或更改关联的登录名 (如 Facebook、 Google、 Microsoft 帐户，等等)，从所有注销用户浏览器实例。</span><span class="sxs-lookup"><span data-stu-id="9f177-162">The Identity system allow you to configure your app so when the users security profile changes (for example, when the user changes their password or changes associated login (such as from Facebook, Google, Microsoft account, etc.), the user is logged out of all browser instances.</span></span> <span data-ttu-id="9f177-163">例如，下面的图像显示[单点注销示例](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt)应用，这样用户就可以通过单击一个按钮注销 （在此情况下，IE、 Firefox 和 Chrome） 的所有浏览器实例。</span><span class="sxs-lookup"><span data-stu-id="9f177-163">For example, the image below shows the [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app, which allows the user to sign out of all browser instances (in this case, IE, Firefox and Chrome) by clicking one button.</span></span> <span data-ttu-id="9f177-164">或者，该示例可以仅注销的特定浏览器实例。</span><span class="sxs-lookup"><span data-stu-id="9f177-164">Alternatively, the sample allows you to only log out of a specific browser instance.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image11.png)

<span data-ttu-id="9f177-165">[单点注销示例](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt)应用演示如何 ASP.NET 标识允许你重新生成安全令牌。</span><span class="sxs-lookup"><span data-stu-id="9f177-165">The [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app shows how ASP.NET Identity allows you to regenerate the security token.</span></span> <span data-ttu-id="9f177-166">需要这些信息来确保使用旧密码生成任何标记 (cookie) 将会失效。</span><span class="sxs-lookup"><span data-stu-id="9f177-166">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="9f177-167">此功能提供一层额外的安全到你的应用程序;如果你更改密码，你将记录出其中您已登录到此应用程序。</span><span class="sxs-lookup"><span data-stu-id="9f177-167">This feature provides an extra layer of security to your application; when you change your password, you will be logged out where you have logged into this application.</span></span>

<span data-ttu-id="9f177-168">*应用\_Start\IdentityConfig.cs*文件包含`ApplicationUserManager`，`EmailService`和`SmsService`类。</span><span class="sxs-lookup"><span data-stu-id="9f177-168">The *App\_Start\IdentityConfig.cs* file contains the `ApplicationUserManager`, `EmailService` and `SmsService` classes.</span></span> <span data-ttu-id="9f177-169">`EmailService`和`SmsService`的类，每个实现`IIdentityMessageService`接口，因此你必须在每个类以配置电子邮件和短信的公共方法。</span><span class="sxs-lookup"><span data-stu-id="9f177-169">The `EmailService` and `SmsService` classes each implement the `IIdentityMessageService` interface, so you have common methods in each class to configure email and SMS.</span></span> <span data-ttu-id="9f177-170">虽然本教程只显示如何添加通过电子邮件通知[SendGrid](http://sendgrid.com/)，你可以发送电子邮件使用 SMTP 和其他机制。</span><span class="sxs-lookup"><span data-stu-id="9f177-170">Although this tutorial only shows how to add email notification through [SendGrid](http://sendgrid.com/), you can send email using SMTP and other mechanisms.</span></span>

<span data-ttu-id="9f177-171">`Startup`类还包含样板添加社交登录名 （Facebook、 Twitter 等），请参阅我的教程[MVC 5 应用程序使用 Facebook、 Twitter、 LinkedIn 和 Google OAuth2 登录](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)有关详细信息。</span><span class="sxs-lookup"><span data-stu-id="9f177-171">The `Startup` class also contains boiler plate to add social logins (Facebook, Twitter, etc.), see my tutorial [MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) for more info.</span></span>

<span data-ttu-id="9f177-172">检查`ApplicationUserManager`类，该类包含的用户标识信息并配置以下功能：</span><span class="sxs-lookup"><span data-stu-id="9f177-172">Examine the `ApplicationUserManager` class, which contains the users identity information and configures the following features:</span></span>

- <span data-ttu-id="9f177-173">密码强度要求。</span><span class="sxs-lookup"><span data-stu-id="9f177-173">Password strength requirements.</span></span>
- <span data-ttu-id="9f177-174">用户在锁住 （尝试次数和时间）。</span><span class="sxs-lookup"><span data-stu-id="9f177-174">User lock out (attempts and time).</span></span>
- <span data-ttu-id="9f177-175">双因素身份验证 (2FA)。</span><span class="sxs-lookup"><span data-stu-id="9f177-175">Two-factor authentication (2FA).</span></span> <span data-ttu-id="9f177-176">将另一个教程中介绍 2FA 和短信。</span><span class="sxs-lookup"><span data-stu-id="9f177-176">I'll cover 2FA and SMS in another tutorial.</span></span>
- <span data-ttu-id="9f177-177">挂接电子邮件和 SMS 服务。</span><span class="sxs-lookup"><span data-stu-id="9f177-177">Hooking up the email and SMS services.</span></span> <span data-ttu-id="9f177-178">（我将介绍 SMS 另一个教程中）。</span><span class="sxs-lookup"><span data-stu-id="9f177-178">(I'll cover SMS in another tutorial).</span></span>

<span data-ttu-id="9f177-179">`ApplicationUserManager`类派生自泛型`UserManager<ApplicationUser>`类。</span><span class="sxs-lookup"><span data-stu-id="9f177-179">The `ApplicationUserManager` class derives from the generic `UserManager<ApplicationUser>` class.</span></span> <span data-ttu-id="9f177-180">`ApplicationUser` 派生自[IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx)。</span><span class="sxs-lookup"><span data-stu-id="9f177-180">`ApplicationUser` derives from [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span></span> <span data-ttu-id="9f177-181">`IdentityUser` 派生自泛型`IdentityUser`类：</span><span class="sxs-lookup"><span data-stu-id="9f177-181">`IdentityUser` derives from the generic `IdentityUser` class:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample1.cs)]

<span data-ttu-id="9f177-182">上面的属性中的属性与同时发生`AspNetUsers`表，如上所示。</span><span class="sxs-lookup"><span data-stu-id="9f177-182">The properties above coincide with the properties in the `AspNetUsers` table, shown above.</span></span>

<span data-ttu-id="9f177-183">上的泛型参数`IUser`使你能够为主键使用不同类型的类。</span><span class="sxs-lookup"><span data-stu-id="9f177-183">Generic arguments on `IUser` enable you to derive a class using different types for the primary key.</span></span> <span data-ttu-id="9f177-184">请参阅[ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt)示例演示如何将为主键从字符串更改为 int 或 GUID。</span><span class="sxs-lookup"><span data-stu-id="9f177-184">See the [ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt) sample which shows how to change the primary key from string to int or GUID.</span></span>

### <a name="applicationuser"></a><span data-ttu-id="9f177-185">ApplicationUser</span><span class="sxs-lookup"><span data-stu-id="9f177-185">ApplicationUser</span></span>

<span data-ttu-id="9f177-186">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) 中定义*Models\IdentityModels.cs*作为：</span><span class="sxs-lookup"><span data-stu-id="9f177-186">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) is defined in *Models\IdentityModels.cs* as:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample2.cs?highlight=8-9)]

<span data-ttu-id="9f177-187">上面的突出显示的代码生成[ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx)。</span><span class="sxs-lookup"><span data-stu-id="9f177-187">The highlighted code above generates a [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span></span> <span data-ttu-id="9f177-188">ASP.NET 标识和 OWIN Cookie 身份验证都是基于声明的因此，框架需要应用程序以生成`ClaimsIdentity`用户。</span><span class="sxs-lookup"><span data-stu-id="9f177-188">ASP.NET Identity and OWIN Cookie Authentication are claims-based, therefore the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="9f177-189">`ClaimsIdentity` 具有信息有关的用户，如用户名、 的所有声明 age 和用户属于哪些角色。</span><span class="sxs-lookup"><span data-stu-id="9f177-189">`ClaimsIdentity` has information about all the claims for the user, such as the user's name, age and what roles the user belongs to.</span></span> <span data-ttu-id="9f177-190">在此阶段，你还可以添加用户的多个的声明。</span><span class="sxs-lookup"><span data-stu-id="9f177-190">You can also add more claims for the user at this stage.</span></span>

<span data-ttu-id="9f177-191">OWIN`AuthenticationManager.SignIn`方法通过中`ClaimsIdentity`并对用户进行签名：</span><span class="sxs-lookup"><span data-stu-id="9f177-191">The OWIN `AuthenticationManager.SignIn` method passes in the `ClaimsIdentity` and signs in the user:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample3.cs?highlight=4-6)]

<span data-ttu-id="9f177-192">[使用 Facebook、 Twitter、 LinkedIn 和 Google OAuth2 登录的 MVC 5 应用程序](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)演示如何将添加到的其他属性`ApplicationUser`类。</span><span class="sxs-lookup"><span data-stu-id="9f177-192">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) shows how you can add additional properties to the `ApplicationUser` class.</span></span>

## <a name="email-confirmation"></a><span data-ttu-id="9f177-193">电子邮件确认</span><span class="sxs-lookup"><span data-stu-id="9f177-193">Email confirmation</span></span>

<span data-ttu-id="9f177-194">它是一个好办法确认新用户注册以验证它们不模拟其他人的电子邮件 （即，它们尚未注册与其他人的电子邮件）。</span><span class="sxs-lookup"><span data-stu-id="9f177-194">It's a good idea to confirm the email a new user register with to verify they are not impersonating someone else (that is, they haven't registered with someone else's email).</span></span> <span data-ttu-id="9f177-195">假设你有论坛，你想要防止`"bob@example.com"`从将注册为`"joe@contoso.com"`。</span><span class="sxs-lookup"><span data-stu-id="9f177-195">Suppose you had a discussion forum, you would want to prevent `"bob@example.com"` from registering as `"joe@contoso.com"`.</span></span> <span data-ttu-id="9f177-196">而无需电子邮件确认`"joe@contoso.com"`无法从您的应用程序获取不需要的电子邮件。</span><span class="sxs-lookup"><span data-stu-id="9f177-196">Without email confirmation, `"joe@contoso.com"` could get unwanted email from your app.</span></span> <span data-ttu-id="9f177-197">假设 Bob 意外注册为`"bib@example.com"`和未注意到，他将无法使用密码恢复，因为此应用程序没有他正确的电子邮件。</span><span class="sxs-lookup"><span data-stu-id="9f177-197">Suppose Bob accidently registered as `"bib@example.com"` and hadn't noticed it, he wouldn't be able to use password recover because the app doesn't have his correct email.</span></span> <span data-ttu-id="9f177-198">电子邮件确认从机器人提供有限的保护，并从确定垃圾邮件发送者不对提供保护，它们具有许多可用于注册的工作电子邮件别名。在下面的示例中，用户将无法更改其密码，直到已确认其帐户 (由它们在它们注册的电子邮件帐户上确认链接上单击收到。)你可以应用此工作流到其他方案中，例如发送链接以确认并重置由管理员，向用户发送一封电子邮件，当它们等更改其配置文件创建的新帐户的密码。</span><span class="sxs-lookup"><span data-stu-id="9f177-198">Email confirmation provides only limited protection from bots and doesn't provide protection from determined spammers, they have many working email aliases they can use to register.In the sample below, the user won't be able to change their password until their account has been confirmed (by them clicking on a confirmation link received on the email account they registered with.) You can apply this work flow to other scenarios, for example sending a link to confirm and reset the password on new accounts created by the administrator, sending the user an email when they have changed their profile and so on.</span></span> <span data-ttu-id="9f177-199">你通常想要使新用户不能发布到网站的任何数据之前已通过电子邮件，SMS 文本消息或其他机制对它们已确认。</span><span class="sxs-lookup"><span data-stu-id="9f177-199">You generally want to prevent new users from posting any data to your web site before they have been confirmed by email, a SMS text message or another mechanism.</span></span> <a id="build"></a>

## <a name="building-a-more-complete-sample"></a><span data-ttu-id="9f177-200">生成更完整示例</span><span class="sxs-lookup"><span data-stu-id="9f177-200">Building a more complete sample</span></span>

<span data-ttu-id="9f177-201">在本部分中，你将使用 NuGet 下载的更完整示例，我们会使用。</span><span class="sxs-lookup"><span data-stu-id="9f177-201">In this section, you'll use NuGet to download a more complete sample we will work with.</span></span>

1. <span data-ttu-id="9f177-202">创建一个新***空***ASP.NET Web 项目。</span><span class="sxs-lookup"><span data-stu-id="9f177-202">Create a new ***empty*** ASP.NET Web project.</span></span>
2. <span data-ttu-id="9f177-203">在程序包管理器控制台中，输入以下以下命令：</span><span class="sxs-lookup"><span data-stu-id="9f177-203">In the Package Manager Console, enter the following the following commands:</span></span> 

    [!code-console[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample4.cmd)]

   <span data-ttu-id="9f177-204">在本教程中，我们将使用[SendGrid](http://sendgrid.com/)发送电子邮件。</span><span class="sxs-lookup"><span data-stu-id="9f177-204">In this tutorial, we'll use [SendGrid](http://sendgrid.com/) to send email.</span></span> <span data-ttu-id="9f177-205">`Identity.Samples`程序包将安装我们将使用的代码。</span><span class="sxs-lookup"><span data-stu-id="9f177-205">The `Identity.Samples` package installs the code we will be working with.</span></span>
3. <span data-ttu-id="9f177-206">设置[项目以使用 SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)。</span><span class="sxs-lookup"><span data-stu-id="9f177-206">Set the [project to use SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span></span>
4. <span data-ttu-id="9f177-207">通过运行应用程序中，单击测试本地帐户创建**注册**链接，然后发布注册表单。</span><span class="sxs-lookup"><span data-stu-id="9f177-207">Test local account creation by running the app, clicking on the **Register** link, and posting the registration form.</span></span>
5. <span data-ttu-id="9f177-208">单击演示电子邮件链接，这将模拟电子邮件确认。</span><span class="sxs-lookup"><span data-stu-id="9f177-208">Click the demo email link, which simulates email confirmation.</span></span>
6. <span data-ttu-id="9f177-209">删除的示例演示电子邮件链接确认代码 (`ViewBag.Link`帐户控制器中的代码。</span><span class="sxs-lookup"><span data-stu-id="9f177-209">Remove the demo email link confirmation code from the sample (The `ViewBag.Link` code in the account controller.</span></span> <span data-ttu-id="9f177-210">请参阅`DisplayEmail`和`ForgotPasswordConfirmation`操作方法和 razor 视图)。</span><span class="sxs-lookup"><span data-stu-id="9f177-210">See the `DisplayEmail` and `ForgotPasswordConfirmation` action methods and razor views ).</span></span>

> [!NOTE]
> <span data-ttu-id="9f177-211">警告： 如果你更改任何在此示例中的安全设置，生产应用将需要接受安全性审核，其中明确所做的更改。</span><span class="sxs-lookup"><span data-stu-id="9f177-211">Warning: If you change any of the security settings in this sample, productions apps will need to undergo a security audit that explicitly calls the changes made.</span></span>


## <a name="examine-the-code-in-appstartidentityconfigcs"></a><span data-ttu-id="9f177-212">检查应用中的代码\_Start\IdentityConfig.cs</span><span class="sxs-lookup"><span data-stu-id="9f177-212">Examine the code in App\_Start\IdentityConfig.cs</span></span>

<span data-ttu-id="9f177-213">此示例演示如何创建一个帐户并将其添加到*管理员*角色。</span><span class="sxs-lookup"><span data-stu-id="9f177-213">The sample shows how to create an account and add it to the *Admin* role.</span></span> <span data-ttu-id="9f177-214">应将替换为你将使用管理帐户的电子邮件的示例中的电子邮件。</span><span class="sxs-lookup"><span data-stu-id="9f177-214">You should replace the email in the sample with the email you will be using for the admin account.</span></span> <span data-ttu-id="9f177-215">现在创建管理员帐户的最简单方法是以编程方式在`Seed`方法。</span><span class="sxs-lookup"><span data-stu-id="9f177-215">The easiest way right now to create an administrator account is programmatically in the `Seed` method.</span></span> <span data-ttu-id="9f177-216">我们希望能够在将来将允许你用于创建和管理用户和角色的工具。</span><span class="sxs-lookup"><span data-stu-id="9f177-216">We hope to have a tool in the future that will allow you to create and administer users and roles.</span></span> <span data-ttu-id="9f177-217">示例代码确实允许您创建和管理用户和角色，但你必须首先具有管理员帐户以运行的角色和用户管理页面。</span><span class="sxs-lookup"><span data-stu-id="9f177-217">The sample code does let you create and manage users and roles, but you must first have an administrators account to run the roles and user admin pages.</span></span> <span data-ttu-id="9f177-218">在此示例中，在数据库设置种子值时创建的管理员帐户。</span><span class="sxs-lookup"><span data-stu-id="9f177-218">In this sample, the admin account is created when the DB is seeded.</span></span>

<span data-ttu-id="9f177-219">更改密码，将名称更改为可以收到电子邮件通知的位置的帐户。</span><span class="sxs-lookup"><span data-stu-id="9f177-219">Change the password and change the name to an account where you can receive email notifications.</span></span>

> [!WARNING]
> <span data-ttu-id="9f177-220">安全-永远不会存储在源代码中敏感数据。</span><span class="sxs-lookup"><span data-stu-id="9f177-220">Security - Never store sensitive data in your source code.</span></span>

<span data-ttu-id="9f177-221">如前所述， `app.CreatePerOwinContext` startup 类中的调用添加到的回调`Create`应用 DB 内容，用户管理器和角色管理器类的方法。</span><span class="sxs-lookup"><span data-stu-id="9f177-221">As mentioned previously, the `app.CreatePerOwinContext` call in the startup class adds callbacks to the `Create` method of the app DB content, user manager and role manger classes.</span></span> <span data-ttu-id="9f177-222">OWIN 管道调用`Create`方法这些类为每个请求，并将存储每个类的上下文。</span><span class="sxs-lookup"><span data-stu-id="9f177-222">The OWIN pipeline calls the `Create` method on these classes for each request and stores the context for each class.</span></span> <span data-ttu-id="9f177-223">在 account 控制器公开从 HTTP 上下文 （其中包含 OWIN 上下文） 的用户管理器：</span><span class="sxs-lookup"><span data-stu-id="9f177-223">The account controller exposes the user manager from the HTTP context (which contains the OWIN context):</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample5.cs)]

<span data-ttu-id="9f177-224">当用户注册一个本地帐户，`HTTP Post Register`调用方法：</span><span class="sxs-lookup"><span data-stu-id="9f177-224">When a user registers a local account, the `HTTP Post Register` method is called:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample6.cs)]

<span data-ttu-id="9f177-225">上面的代码中使用模型数据创建新的用户帐户使用的电子邮件和输入的密码。</span><span class="sxs-lookup"><span data-stu-id="9f177-225">The code above uses the model data to create a new user account using the email and password entered.</span></span> <span data-ttu-id="9f177-226">如果的电子邮件别名是数据存储区，帐户创建失败，并再次显示窗体。</span><span class="sxs-lookup"><span data-stu-id="9f177-226">If the email alias is in the data store, account creation fails and the form is displayed again.</span></span> <span data-ttu-id="9f177-227">`GenerateEmailConfirmationTokenAsync`方法创建一个安全确认令牌并将其存储在 ASP.NET Identity 数据存储区。</span><span class="sxs-lookup"><span data-stu-id="9f177-227">The `GenerateEmailConfirmationTokenAsync` method creates a secure confirmation token and stores it in the ASP.NET Identity data store.</span></span> <span data-ttu-id="9f177-228">[Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx)方法创建一个链接，其中包含`UserId`和确认令牌。</span><span class="sxs-lookup"><span data-stu-id="9f177-228">The [Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) method creates a link containing the `UserId` and confirmation token.</span></span> <span data-ttu-id="9f177-229">然后向用户电子邮件发送此链接，用户可以单击其电子邮件应用以确认其帐户中的链接。</span><span class="sxs-lookup"><span data-stu-id="9f177-229">This link is then emailed to the user, the user can click on the link in their email app to confirm their account.</span></span>

<a id="email"></a>

## <a name="set-up-email-confirmation"></a><span data-ttu-id="9f177-230">设置电子邮件确认</span><span class="sxs-lookup"><span data-stu-id="9f177-230">Set up email confirmation</span></span>

<span data-ttu-id="9f177-231">转到[Azure SendGrid 注册页面](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/)并注册免费帐户。</span><span class="sxs-lookup"><span data-stu-id="9f177-231">Go to the [Azure SendGrid sign up page](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) and register for free account.</span></span> <span data-ttu-id="9f177-232">添加类似于以下内容来配置 SendGrid 的代码：</span><span class="sxs-lookup"><span data-stu-id="9f177-232">Add code similar to the following to configure SendGrid:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample7.cs?highlight=5)]

> [!NOTE]
> <span data-ttu-id="9f177-233">电子邮件客户端频繁地只接受文本消息 (无 HTML)。</span><span class="sxs-lookup"><span data-stu-id="9f177-233">Email clients frequently accept only text messages (no HTML).</span></span> <span data-ttu-id="9f177-234">应提供文本和 HTML 中的消息。</span><span class="sxs-lookup"><span data-stu-id="9f177-234">You should provide the message in text and HTML.</span></span> <span data-ttu-id="9f177-235">在上面的 SendGrid 示例中，这完成与`myMessage.Text`和`myMessage.Html`上面所示的代码。</span><span class="sxs-lookup"><span data-stu-id="9f177-235">In the SendGrid sample above, this is done with the `myMessage.Text` and `myMessage.Html` code shown above.</span></span>


<span data-ttu-id="9f177-236">下面的代码演示如何发送电子邮件使用[MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx)类 where`message.Body`返回仅的链接。</span><span class="sxs-lookup"><span data-stu-id="9f177-236">The following code shows how to send email using the [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) class where `message.Body` returns only the link.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample8.cs)]

> [!WARNING]
> <span data-ttu-id="9f177-237">安全-永远不会存储在源代码中敏感数据。</span><span class="sxs-lookup"><span data-stu-id="9f177-237">Security - Never store sensitive data in your source code.</span></span> <span data-ttu-id="9f177-238">帐户和凭据存储在 appSetting。</span><span class="sxs-lookup"><span data-stu-id="9f177-238">The account and credentials are stored in the appSetting.</span></span> <span data-ttu-id="9f177-239">在 Azure 上，你可以安全地存储这些值在**[配置](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)**在 Azure 门户中的选项卡。</span><span class="sxs-lookup"><span data-stu-id="9f177-239">On Azure, you can securely store these values on the **[Configure](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** tab in the Azure portal.</span></span> <span data-ttu-id="9f177-240">请参阅[用于密码和其他敏感数据部署到 ASP.NET 和 Azure 的最佳做法](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md)。</span><span class="sxs-lookup"><span data-stu-id="9f177-240">See [Best practices for deploying passwords and other sensitive data to ASP.NET and Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span></span>


<span data-ttu-id="9f177-241">输入你的 SendGrid 凭据、 运行应用，注册的电子邮件别名可以单击你的电子邮件中的确认链接。</span><span class="sxs-lookup"><span data-stu-id="9f177-241">Enter your SendGrid credentials, run the app, register with an email alias can click the confirm link in your email.</span></span> <span data-ttu-id="9f177-242">若要了解如何执行此操作与你[Outlook.com](http://outlook.com)电子邮件帐户，请参阅 John 输入[的 Outlook.Com SMTP 主机的 C# SMTP 配置](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx)和他[ASP.NET 标识 2.0： 设置帐户验证和双因素授权](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx)文章。</span><span class="sxs-lookup"><span data-stu-id="9f177-242">To see how to do this with your [Outlook.com](http://outlook.com) email account, see John Atten's [C# SMTP Configuration for Outlook.Com SMTP Host](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) and his[ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) posts.</span></span>

<span data-ttu-id="9f177-243">用户单击后**注册**确认电子邮件包含的验证令牌发送到其电子邮件地址的按钮。</span><span class="sxs-lookup"><span data-stu-id="9f177-243">Once a user clicks the **Register** button a confirmation email containing a validation token is sent to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image12.png)

<span data-ttu-id="9f177-244">向用户发送包含其帐户的确认令牌的电子邮件。</span><span class="sxs-lookup"><span data-stu-id="9f177-244">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image13.png)

## <a name="examine-the-code"></a><span data-ttu-id="9f177-245">检查代码</span><span class="sxs-lookup"><span data-stu-id="9f177-245">Examine the code</span></span>

<span data-ttu-id="9f177-246">以下代码演示了 `POST ForgotPassword` 方法。</span><span class="sxs-lookup"><span data-stu-id="9f177-246">The following code shows the `POST ForgotPassword` method.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="9f177-247">如果尚未确认的用户电子邮件，该方法将以静默方式失败。</span><span class="sxs-lookup"><span data-stu-id="9f177-247">The method fails silently if the user email has not been confirmed.</span></span> <span data-ttu-id="9f177-248">如果错误已发布的无效电子邮件地址，恶意用户无法使用该信息来查找有效 userId （电子邮件别名） 攻击。</span><span class="sxs-lookup"><span data-stu-id="9f177-248">If an error was posted for an invalid email address, malicious users could use that information to find valid userId (email aliases) to attack.</span></span>

<span data-ttu-id="9f177-249">下面的代码演示`ConfirmEmail`当用户单击电子邮件发送到它们中的确认链接时调用的帐户控制器中的方法：</span><span class="sxs-lookup"><span data-stu-id="9f177-249">The following code shows the `ConfirmEmail` method in the account controller that is called when the user clicks the confirmation link in the email sent to them:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample10.cs)]

<span data-ttu-id="9f177-250">一旦已使用忘记了的密码令牌，它会失效。</span><span class="sxs-lookup"><span data-stu-id="9f177-250">Once a forgotten password token has been used, it's invalidated.</span></span> <span data-ttu-id="9f177-251">在下面的代码更改`Create`方法 (在*应用\_Start\IdentityConfig.cs*文件) 设置为 3 小时内过期的令牌。</span><span class="sxs-lookup"><span data-stu-id="9f177-251">The following code change in the `Create` method (in the *App\_Start\IdentityConfig.cs* file) sets the tokens to expire in 3 hours.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample11.cs?highlight=6-8)]

<span data-ttu-id="9f177-252">使用上面的代码中，忘记了的密码和电子邮件确认令牌将在过期 3 小时。</span><span class="sxs-lookup"><span data-stu-id="9f177-252">With the code above, the forgotten password and the email confirmation tokens will expire in 3 hours.</span></span> <span data-ttu-id="9f177-253">默认值`TokenLifespan`为一天。</span><span class="sxs-lookup"><span data-stu-id="9f177-253">The default `TokenLifespan` is one day.</span></span>

<span data-ttu-id="9f177-254">下面的代码演示了电子邮件确认方法：</span><span class="sxs-lookup"><span data-stu-id="9f177-254">The following code shows the email confirmation method:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample12.cs)]

 <span data-ttu-id="9f177-255">若要使你的应用程序更安全的情况下，ASP.NET 标识支持双因素身份验证 (2FA)。</span><span class="sxs-lookup"><span data-stu-id="9f177-255">To make your app more secure, ASP.NET Identity supports Two-Factor authentication (2FA).</span></span> <span data-ttu-id="9f177-256">请参阅[ASP.NET 标识 2.0： 设置帐户验证和双因素授权](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx)通过 John 输入。</span><span class="sxs-lookup"><span data-stu-id="9f177-256">See [ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) by John Atten.</span></span> <span data-ttu-id="9f177-257">虽然可以在登录密码尝试失败次数中设置帐户锁定，这种方法使你的登录名容易遭受[DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack)锁定。</span><span class="sxs-lookup"><span data-stu-id="9f177-257">Although you can set account lockout on login password attempt failures, that approach makes your login susceptible to [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) lockouts.</span></span> <span data-ttu-id="9f177-258">我们建议只适用于 2FA 使用帐户锁定。</span><span class="sxs-lookup"><span data-stu-id="9f177-258">We recommend you use account lockout only with 2FA.</span></span>  
<a id="addRes"></a>

## <a name="additional-resources"></a><span data-ttu-id="9f177-259">其他资源</span><span class="sxs-lookup"><span data-stu-id="9f177-259">Additional Resources</span></span>

- [<span data-ttu-id="9f177-260">ASP.NET 标识的自定义存储提供程序概述</span><span class="sxs-lookup"><span data-stu-id="9f177-260">Overview of Custom Storage Providers for ASP.NET Identity</span></span>](../extensibility/overview-of-custom-storage-providers-for-aspnet-identity.md)
- <span data-ttu-id="9f177-261">[使用 Facebook、 Twitter、 LinkedIn 和 Google OAuth2 登录的 MVC 5 应用程序](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)还演示如何将配置文件信息添加到用户表。</span><span class="sxs-lookup"><span data-stu-id="9f177-261">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) also shows how to add profile information to the users table.</span></span>
- <span data-ttu-id="9f177-262">[ASP.NET MVC 和标识 2.0： 了解基础知识](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx)通过 John 输入。</span><span class="sxs-lookup"><span data-stu-id="9f177-262">[ASP.NET MVC and Identity 2.0: Understanding the Basics](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) by John Atten.</span></span>
- [<span data-ttu-id="9f177-263">ASP.NET 标识简介</span><span class="sxs-lookup"><span data-stu-id="9f177-263">Introduction to ASP.NET Identity</span></span>](../getting-started/introduction-to-aspnet-identity.md)
- <span data-ttu-id="9f177-264">[宣布推出适用的 ASP.NET 标识 2.0.0 RTM](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) Pranav Rastogi 通过。</span><span class="sxs-lookup"><span data-stu-id="9f177-264">[Announcing RTM of ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) by Pranav Rastogi.</span></span>
