---
uid: web-forms/overview/older-versions-security/membership/validating-user-credentials-against-the-membership-user-store-cs
title: "正在验证用户凭据对成员资格用户存储区 (C#) |Microsoft 文档"
author: rick-anderson
description: "在本教程中我们将了解如何验证成员资格用户存储区使用的编程方法和登录控制针对用户的凭据..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 01/18/2008
ms.topic: article
ms.assetid: 61aa4e08-aa81-4aeb-8ebe-19ba7a65e04c
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/older-versions-security/membership/validating-user-credentials-against-the-membership-user-store-cs
msc.type: authoredcontent
ms.openlocfilehash: 8f8f4db63ba8c1f1c1df7c1c5c1f92184bf6841d
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 01/24/2018
---
<a name="validating-user-credentials-against-the-membership-user-store-c"></a><span data-ttu-id="f9ecf-103">正在验证用户凭据对成员资格用户存储区 (C#)</span><span class="sxs-lookup"><span data-stu-id="f9ecf-103">Validating User Credentials Against the Membership User Store (C#)</span></span>
====================
<span data-ttu-id="f9ecf-104">通过[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="f9ecf-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="f9ecf-105">[下载代码](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_06_CS.zip)或[下载 PDF](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial06_LoggingIn_cs.pdf)</span><span class="sxs-lookup"><span data-stu-id="f9ecf-105">[Download Code](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_06_CS.zip) or [Download PDF](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial06_LoggingIn_cs.pdf)</span></span>

> <span data-ttu-id="f9ecf-106">在本教程中我们将查看如何验证针对使用的编程方法和登录控件成员资格用户存储区的用户的凭据。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-106">In this tutorial we will examine how to validate a user's credentials against the Membership user store using both programmatic means and the Login control.</span></span> <span data-ttu-id="f9ecf-107">我们还将了解如何自定义登录控件的外观和行为。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-107">We will also look at how to customize the login control's appearance and behavior.</span></span>


## <a name="introduction"></a><span data-ttu-id="f9ecf-108">介绍</span><span class="sxs-lookup"><span data-stu-id="f9ecf-108">Introduction</span></span>

<span data-ttu-id="f9ecf-109">在<a id="Tutorial05"> </a>[前面教程](creating-user-accounts-cs.md)我们介绍了如何在成员资格框架中创建新的用户帐户。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-109">In the <a id="Tutorial05"></a>[preceding tutorial](creating-user-accounts-cs.md) we looked at how to create a new user account in the Membership framework.</span></span> <span data-ttu-id="f9ecf-110">我们首先看以编程方式创建用户帐户通过`Membership`类的`CreateUser`方法，然后使用和检查 CreateUserWizard Web 控件。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-110">We first looked at programmatically creating user accounts via the `Membership` class's `CreateUser` method, and then examined using the CreateUserWizard Web control.</span></span> <span data-ttu-id="f9ecf-111">但是，登录页当前验证根据硬编码的用户名和密码对的列表提供的凭据。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-111">However, the login page currently validates the supplied credentials against a hard-coded list of username and password pairs.</span></span> <span data-ttu-id="f9ecf-112">我们需要更新登录页的逻辑，以便它验证针对成员资格框架的用户存储的凭据。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-112">We need to update the login page's logic so that it validates credentials against the Membership framework's user store.</span></span>

<span data-ttu-id="f9ecf-113">更像与创建用户帐户，可以验证凭据以编程方式或以声明方式。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-113">Much like with creating user accounts, credentials can be validated programmatically or declaratively.</span></span> <span data-ttu-id="f9ecf-114">成员资格 API 包含用于以编程方式验证对用户存储的用户的凭据的方法。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-114">The Membership API includes a method for programmatically validating a user's credentials against the user store.</span></span> <span data-ttu-id="f9ecf-115">和 ASP.NET 附带登录 Web 控件，来呈现使用文本框中输入用户名和密码和一个按钮以登录的用户界面。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-115">And ASP.NET ships with the Login Web control, which renders a user interface with textboxes for the username and password and a button to log in.</span></span>

<span data-ttu-id="f9ecf-116">在本教程中我们将查看如何验证针对使用的编程方法和登录控件成员资格用户存储区的用户的凭据。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-116">In this tutorial we will examine how to validate a user's credentials against the Membership user store using both programmatic means and the Login control.</span></span> <span data-ttu-id="f9ecf-117">我们还将了解如何自定义登录控件的外观和行为。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-117">We will also look at how to customize the login control's appearance and behavior.</span></span> <span data-ttu-id="f9ecf-118">让我们进入正题！</span><span class="sxs-lookup"><span data-stu-id="f9ecf-118">Let's get started!</span></span>

## <a name="step-1-validating-credentials-against-the-membership-user-store"></a><span data-ttu-id="f9ecf-119">步骤 1： 验证针对成员资格用户存储凭据</span><span class="sxs-lookup"><span data-stu-id="f9ecf-119">Step 1: Validating Credentials Against the Membership User Store</span></span>

<span data-ttu-id="f9ecf-120">对于使用 forms 身份验证的网站，用户登录到网站访问登录页并输入其凭据。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-120">For web sites that use forms authentication, a user logs on to the website by visiting a login page and entering their credentials.</span></span> <span data-ttu-id="f9ecf-121">然后，针对用户存储比较这些凭据。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-121">These credentials are then compared against the user store.</span></span> <span data-ttu-id="f9ecf-122">如果它们有效，然后将向用户授予窗体身份验证票证，这是安全令牌，该值指示的标识和访问者的真实性。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-122">If they are valid, then the user is granted a forms authentication ticket, which is a security token that indicates the identity and authenticity of the visitor.</span></span>

<span data-ttu-id="f9ecf-123">若要验证对成员资格 framework 用户，使用`Membership`类的[`ValidateUser`方法](https://msdn.microsoft.com/library/system.web.security.membership.validateuser.aspx)。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-123">To validate a user against the Membership framework, use the `Membership` class's [`ValidateUser` method](https://msdn.microsoft.com/library/system.web.security.membership.validateuser.aspx).</span></span> <span data-ttu-id="f9ecf-124">`ValidateUser`方法采用两个输入参数-中 *`username`* 和 *`password`*  -并返回一个布尔值，该值指示凭据是否有效。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-124">The `ValidateUser` method takes in two input parameters - *`username`* and *`password`* - and returns a Boolean value indicating whether the credentials were valid.</span></span> <span data-ttu-id="f9ecf-125">与类似`CreateUser`方法，在前面的教程，我们探讨`ValidateUser`方法会委托给配置成员资格提供程序实际的验证。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-125">Like with the `CreateUser` method we examined in the previous tutorial, the `ValidateUser` method delegates the actual validation to the configured Membership provider.</span></span>

<span data-ttu-id="f9ecf-126">`SqlMembershipProvider`验证提供的凭据通过获取指定的用户的密码通过`aspnet_Membership_GetPasswordWithFormat`存储过程。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-126">The `SqlMembershipProvider` validates the supplied credentials by obtaining the specified user's password via the `aspnet_Membership_GetPasswordWithFormat` stored procedure.</span></span> <span data-ttu-id="f9ecf-127">回想一下，`SqlMembershipProvider`存储使用三种格式之一的用户的密码： 清除，加密，或哈希处理。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-127">Recall that the `SqlMembershipProvider` stores users' passwords using one of three formats: clear, encrypted, or hashed.</span></span> <span data-ttu-id="f9ecf-128">`aspnet_Membership_GetPasswordWithFormat`存储的过程返回其原始格式的密码。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-128">The `aspnet_Membership_GetPasswordWithFormat` stored procedure returns the password in its raw format.</span></span> <span data-ttu-id="f9ecf-129">加密或经过哈希处理密码，`SqlMembershipProvider`转换 *`password`* 值传递给`ValidateUser`方法划分为它的等效项加密或哈希状态，然后将它与什么返回从进行比较数据库。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-129">For encrypted or hashed passwords, the `SqlMembershipProvider` transforms the *`password`* value passed into the `ValidateUser` method into its equivalent encrypted or hashed state and then compares it with what was returned from the database.</span></span> <span data-ttu-id="f9ecf-130">如果存储在数据库中的密码与用户输入的格式化的密码匹配，则凭据有效。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-130">If the password stored in the database matches the formatted password entered by the user, the credentials are valid.</span></span>

<span data-ttu-id="f9ecf-131">让我们更新我们的登录页 (~ /`Login.aspx`)，以便它会验证对成员资格 framework 用户存储区提供的凭据。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-131">Let's update our login page (~/`Login.aspx`) so that it validates the supplied credentials against the Membership framework user store.</span></span> <span data-ttu-id="f9ecf-132">我们创建了此登录页进来<a id="Tutorial02"> </a> [*概述窗体身份验证的*](../introduction/an-overview-of-forms-authentication-cs.md)教程中，使用两个文本框中输入用户名和密码，创建一个接口记住我复选框，和登录按钮 （请参见图 1）。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-132">We created this login page back in the <a id="Tutorial02"></a>[*An Overview of Forms Authentication*](../introduction/an-overview-of-forms-authentication-cs.md) tutorial, creating an interface with two TextBoxes for the username and password, a Remember Me checkbox, and a Login button (see Figure 1).</span></span> <span data-ttu-id="f9ecf-133">代码验证输入的凭据与硬编码的用户名和密码对 （Scott/密码、 Jisun/密码和 Sam/密码） 列表。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-133">The code validates the entered credentials against a hard-coded list of username and password pairs (Scott/password, Jisun/password, and Sam/password).</span></span> <span data-ttu-id="f9ecf-134">在<a id="Tutorial03"> </a> [*窗体身份验证配置和高级主题*](../introduction/forms-authentication-configuration-and-advanced-topics-cs.md)我们更新了登录页的代码，以在窗体存储附加信息的教程身份验证票证`UserData`属性。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-134">In the <a id="Tutorial03"></a>[*Forms Authentication Configuration and Advanced Topics*](../introduction/forms-authentication-configuration-and-advanced-topics-cs.md) tutorial we updated the login page's code to store additional information in the forms authentication ticket's `UserData` property.</span></span>


<span data-ttu-id="f9ecf-135">[![登录页的接口包含两个文本框中，按和一个按钮](validating-user-credentials-against-the-membership-user-store-cs/_static/image2.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="f9ecf-135">[![The Login Page's Interface Includes Two TextBoxes, a CheckBoxList, and a Button](validating-user-credentials-against-the-membership-user-store-cs/_static/image2.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image1.png)</span></span>

<span data-ttu-id="f9ecf-136">**图 1**: 登录页接口包括两个文本框中，按和一个按钮 ([单击以查看实际尺寸的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="f9ecf-136">**Figure 1**: The Login Page's Interface Includes Two TextBoxes, a CheckBoxList, and a Button  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image3.png))</span></span>


<span data-ttu-id="f9ecf-137">登录页的用户界面可以保持不变，但我们需要将登录按钮`Click`事件处理程序替换验证成员资格 framework 用户存储区对用户的代码。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-137">The login page's user interface can remain unchanged, but we need to replace the Login button's `Click` event handler with code that validates the user against the Membership framework user store.</span></span> <span data-ttu-id="f9ecf-138">更新事件处理程序，以便其代码如下所示：</span><span class="sxs-lookup"><span data-stu-id="f9ecf-138">Update the event handler so that its code appears as follows:</span></span>

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample1.cs)]

<span data-ttu-id="f9ecf-139">此代码是非常简单。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-139">This code is remarkably simple.</span></span> <span data-ttu-id="f9ecf-140">我们首先调用`Membership.ValidateUser`方法，并传递中提供的用户名和密码。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-140">We start by calling the `Membership.ValidateUser` method, passing in the supplied username and password.</span></span> <span data-ttu-id="f9ecf-141">如果该方法返回 true，则用户登录到站点中，通过`FormsAuthentication`类的 RedirectFromLoginPage 方法。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-141">If that method returns true, then the user is signed into the site via the `FormsAuthentication` class's RedirectFromLoginPage method.</span></span> <span data-ttu-id="f9ecf-142">(如我们所述<a id="Tutorial2"> </a> [*概述窗体身份验证的*](../introduction/an-overview-of-forms-authentication-cs.md)教程中，`FormsAuthentication.RedirectFromLoginPage`创建窗体身份验证票证，然后将用户重定向适当的页。）凭据无效，但是，如果`InvalidCredentialsMessage`标签会显示，从而告知用户其用户名或密码不正确。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-142">(As we discussed in the <a id="Tutorial2"></a>[*An Overview of Forms Authentication*](../introduction/an-overview-of-forms-authentication-cs.md) tutorial, the `FormsAuthentication.RedirectFromLoginPage` creates the forms authentication ticket and then redirects the user to the appropriate page.) If the credentials are invalid, however, the `InvalidCredentialsMessage` Label is displayed, informing the user that their username or password was incorrect.</span></span>

<span data-ttu-id="f9ecf-143">这就是所有到它 ！</span><span class="sxs-lookup"><span data-stu-id="f9ecf-143">That's all there is to it!</span></span>

<span data-ttu-id="f9ecf-144">若要测试的登录页按预期方式工作，请尝试使用在前面的教程创建的用户帐户之一进行登录。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-144">To test that the login page works as expected, attempt to login with one of the user accounts you created in the preceding tutorial.</span></span> <span data-ttu-id="f9ecf-145">或者，如果尚未创建一个帐户，请继续并创建一个从`~/Membership/CreatingUserAccounts.aspx`页。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-145">Or, if you have not yet created an account, go ahead and create one from the `~/Membership/CreatingUserAccounts.aspx` page.</span></span>

> [!NOTE]
> <span data-ttu-id="f9ecf-146">当用户输入其凭据，并提交在登录页表单时，通过 Internet 建立到中的 web 服务器传输凭据，包括她的密码，*纯文本*。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-146">When the user enters her credentials and submits the login page form, the credentials, including her password, are transmitted over the Internet to the web server in *plain text*.</span></span> <span data-ttu-id="f9ecf-147">这意味着探查的网络流量任何黑客可以查看的用户名和密码。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-147">That means any hacker sniffing the network traffic can see the username and password.</span></span> <span data-ttu-id="f9ecf-148">若要防止此情况，请务必使用加密的网络流量[安全套接字层 (SSL)](http://en.wikipedia.org/wiki/Secure_Sockets_Layer)。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-148">To prevent this, it is essential to encrypt the network traffic by using [Secure Socket Layers (SSL)](http://en.wikipedia.org/wiki/Secure_Sockets_Layer).</span></span> <span data-ttu-id="f9ecf-149">这将确保凭据 （以及整个页面的 HTML 标记） 进行加密的那一刻他们离开浏览器，直到其被接收由 web 服务器。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-149">This will ensure that the credentials (as well as the entire page's HTML markup) are encrypted from the moment they leave the browser until they are received by the web server.</span></span>


### <a name="how-the-membership-framework-handles-invalid-login-attempts"></a><span data-ttu-id="f9ecf-150">成员资格 Framework 如何处理无效的登录尝试次数</span><span class="sxs-lookup"><span data-stu-id="f9ecf-150">How the Membership Framework Handles Invalid Login Attempts</span></span>

<span data-ttu-id="f9ecf-151">当访问者达到登录页，并提交其凭据时，其浏览器将发出到登录页的 HTTP 请求。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-151">When a visitor reaches the login page and submits their credentials, their browser makes an HTTP request to the login page.</span></span> <span data-ttu-id="f9ecf-152">凭据有效，则 HTTP 响应包括身份验证票证的 cookie 中。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-152">If the credentials are valid, the HTTP response includes the authentication ticket in a cookie.</span></span> <span data-ttu-id="f9ecf-153">因此，黑客尝试中断到你的站点无法创建彻底将 HTTP 请求发送到登录页，其中一个有效的用户名以及在密码猜测的程序。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-153">Therefore, a hacker attempting to break into your site could create a program that exhaustively sends HTTP requests to the login page with a valid username and a guess at the password.</span></span> <span data-ttu-id="f9ecf-154">如果密码猜测值正确，登录页将返回身份验证票证 cookie，此时该程序知道它已偶然发现有效的用户名/密码对。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-154">If the password guess is correct, the login page will return the authentication ticket cookie, at which point the program knows it has stumbled upon a valid username/password pair.</span></span> <span data-ttu-id="f9ecf-155">通过暴力破解，这样的程序可能能够在用户的密码时碰到，尤其是如果密码是弱。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-155">Through brute force, such a program might be able to stumble upon a user's password, especially if the password is weak.</span></span>

<span data-ttu-id="f9ecf-156">若要防止此类暴力破解攻击，成员身份 framework 将锁定用户是否存在一定数量的一段时间内的失败登录尝试次数。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-156">To prevent such brute force attacks, the Membership framework locks out a user if there are a certain number of unsuccessful login attempts within a certain period of time.</span></span> <span data-ttu-id="f9ecf-157">确切参数均可通过进行以下两个成员资格提供程序配置设置：</span><span class="sxs-lookup"><span data-stu-id="f9ecf-157">The exact parameters are configurable through the following two Membership provider configuration settings:</span></span>

- <span data-ttu-id="f9ecf-158">`maxInvalidPasswordAttempts`-指定多少无效密码前的帐户已被锁定的时间段内的用户允许使用尝试。默认值为 5。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-158">`maxInvalidPasswordAttempts` - specifies how many invalid password attempts are allowed for the user within the time period before the account is locked out. The default value is 5.</span></span>
- <span data-ttu-id="f9ecf-159">`passwordAttemptWindow`-指示在此期间指定的无效的登录尝试次数可导致用户帐户被锁定的分钟的时间段。默认值为 10。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-159">`passwordAttemptWindow` - indicates the time period in minutes during which the specified number of invalid login attempts will cause the account to be locked out. The default value is 10.</span></span>

<span data-ttu-id="f9ecf-160">如果用户已被锁定，她无法登录直到管理员将解锁其帐户。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-160">If a user has been locked out, she cannot login until an administrator unlocks her account.</span></span> <span data-ttu-id="f9ecf-161">当用户已被锁定时，`ValidateUser`方法将*始终*返回`false`，即使在提供有效凭据。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-161">When a user is locked out, the `ValidateUser` method will *always* return `false`, even if valid credentials are supplied.</span></span> <span data-ttu-id="f9ecf-162">虽然此行为可以减小黑客通过暴力破解方法将到你的站点中断的可能性越小，它可以得到锁定只需忘记其密码或意外具有了 Caps Lock 或者是具有错误键入每天的有效用户。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-162">While this behavior lessens the likelihood that a hacker will break into your site through brute force methods, it can end up locking out a valid user who has simply forgotten her password or accidentally has the Caps Lock on or is having a bad typing day.</span></span>

<span data-ttu-id="f9ecf-163">遗憾的是，没有内置工具用于解锁的用户帐户。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-163">Unfortunately, there is no built-in tool for unlocking a user account.</span></span> <span data-ttu-id="f9ecf-164">若要解锁帐户，你可以修改数据库直接-更改`IsLockedOut`字段中`aspnet_Membership`表相应的用户帐户或创建基于 web 的界面，其中列出了与选项才可解锁其帐户已锁定。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-164">In order to unlock an account, you can modify the database directly - change the `IsLockedOut` field in the `aspnet_Membership` table for the appropriate user account - or create a web-based interface that lists locked out accounts with options to unlock them.</span></span> <span data-ttu-id="f9ecf-165">我们将检查创建的管理接口，用于在将来的教程中实现常见用户帐户和角色相关任务。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-165">We will examine creating administrative interfaces for accomplishing common user account- and role-related tasks in a future tutorial.</span></span>

> [!NOTE]
> <span data-ttu-id="f9ecf-166">一个缺点`ValidateUser`方法是，提供的凭据无效时，它不提供任何原因的说明，解释。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-166">One downside of the `ValidateUser` method is that when the supplied credentials are invalid, it does not provide any explanation as to why.</span></span> <span data-ttu-id="f9ecf-167">凭据可能无效，因为没有任何匹配的用户名/密码对用户存储中，或因为用户尚未经过批准，或者用户已锁定。在步骤 4 中，我们将了解如何向用户显示更详细的消息，其登录尝试失败时。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-167">The credentials may be invalid because there is no matching username/password pair in the user store, or because the user has not yet been approved, or because the user has been locked out. In Step 4 we will see how to show a more detailed message to the user when their login attempt fails.</span></span>


## <a name="step-2-collecting-credentials-through-the-login-web-control"></a><span data-ttu-id="f9ecf-168">步骤 2： 收集通过登录 Web 控件的凭据</span><span class="sxs-lookup"><span data-stu-id="f9ecf-168">Step 2: Collecting Credentials through the Login Web Control</span></span>

<span data-ttu-id="f9ecf-169">[登录 Web 控件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.aspx)呈现默认用户界面非常类似于我们创建返回<a id="SKM5"> </a> [*概述窗体身份验证的*](../introduction/an-overview-of-forms-authentication-cs.md)教程。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-169">The [Login Web control](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.aspx) renders a default user interface very similar to the one we created back in the <a id="SKM5"></a>[*An Overview of Forms Authentication*](../introduction/an-overview-of-forms-authentication-cs.md) tutorial.</span></span> <span data-ttu-id="f9ecf-170">使用 Login 控件可节省我们无需创建要收集的访问者的凭据的接口的工作。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-170">Using the Login control saves us the work of having to create the interface to collect the visitor�s credentials.</span></span> <span data-ttu-id="f9ecf-171">此外，Login 控件自动签名中用户 （假设已提交的凭据有效），从而保存我们无需编写任何代码。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-171">Moreover, the Login control automatically signs in the user (assuming the submitted credentials are valid), thereby saving us from having to write any code.</span></span>

<span data-ttu-id="f9ecf-172">让我们更新`Login.aspx`、 替换手动创建的接口和代码与登录控件。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-172">Let's update `Login.aspx`, replacing the manually created interface and code with a Login control.</span></span> <span data-ttu-id="f9ecf-173">先删除现有的标记和代码中`Login.aspx`。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-173">Start by removing the existing markup and code in `Login.aspx`.</span></span> <span data-ttu-id="f9ecf-174">你可能会删除迫切地，或只需注释掉。注释掉声明性的标记，请在它与`<%--`和`--%>`分隔符。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-174">You may delete it outright, or simply comment it out. To comment out declarative markup, surround it with the `<%--` and `--%>` delimiters.</span></span> <span data-ttu-id="f9ecf-175">你可以手动输入这些分隔符，或如图 2 所示，你可以选择要注释掉，然后单击工具栏中的选定的行图标出注释的文本。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-175">You can enter these delimiters manually, or, as Figure 2 shows, you may select the text to comment out and then click the Comment out the selected lines icon in the Toolbar.</span></span> <span data-ttu-id="f9ecf-176">同样，你可以使用注释掉的选定的行图标来注释掉的代码隐藏类中的所选代码。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-176">Similarly, you can use the Comment out the selected lines icon to comment out the selected code in the code-behind class.</span></span>


<span data-ttu-id="f9ecf-177">[![注释掉现有声明性标记和在 Login.aspx 的源代码](validating-user-credentials-against-the-membership-user-store-cs/_static/image5.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="f9ecf-177">[![Comment Out the Existing Declarative Markup and Source Code in Login.aspx](validating-user-credentials-against-the-membership-user-store-cs/_static/image5.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image4.png)</span></span>

<span data-ttu-id="f9ecf-178">**图 2**： 注释掉现有声明性标记和中的源代码`Login.aspx`([单击以查看实际尺寸的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="f9ecf-178">**Figure 2**: Comment Out the Existing Declarative Markup and Source Code in `Login.aspx` ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image6.png))</span></span>


> [!NOTE]
> <span data-ttu-id="f9ecf-179">在 Visual Studio 2005 中查看的声明性的标记时，注释掉的选定的行图标不可用。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-179">The Comment out the selected lines icon is not available when viewing the declarative markup in Visual Studio 2005.</span></span> <span data-ttu-id="f9ecf-180">如果你不使用 Visual Studio 2008 你将需要手动添加`<%--`和`--%>`分隔符。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-180">If you are not using Visual Studio 2008 you will need to manually add the `<%--` and `--%>` delimiters.</span></span>


<span data-ttu-id="f9ecf-181">接下来，将从工具箱拖到页上的登录控件并设置其`ID`属性`myLogin`。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-181">Next, drag a Login control from the Toolbox on to the page and set its `ID` property to `myLogin`.</span></span> <span data-ttu-id="f9ecf-182">此时你的屏幕应类似于图 3。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-182">At this point your screen should look similar to Figure 3.</span></span> <span data-ttu-id="f9ecf-183">请注意登录控件的默认接口，包括用户名和密码，记住我的 TextBox 控件下次复选框和一个按钮日志。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-183">Note that the Login control's default interface includes TextBox controls for the username and password, a Remember me next time CheckBox, and a Log In Button.</span></span> <span data-ttu-id="f9ecf-184">也有`RequiredFieldValidator`两个文本框中的控件。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-184">There are also `RequiredFieldValidator` controls for the two TextBoxes.</span></span>


<span data-ttu-id="f9ecf-185">[![将登录控件添加到页](validating-user-credentials-against-the-membership-user-store-cs/_static/image8.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="f9ecf-185">[![Add a Login Control to the Page](validating-user-credentials-against-the-membership-user-store-cs/_static/image8.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image7.png)</span></span>

<span data-ttu-id="f9ecf-186">**图 3**： 将登录控件添加到页 ([单击以查看实际尺寸的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="f9ecf-186">**Figure 3**: Add a Login Control to the Page  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image9.png))</span></span>


<span data-ttu-id="f9ecf-187">大功告成 ！</span><span class="sxs-lookup"><span data-stu-id="f9ecf-187">And we're done!</span></span> <span data-ttu-id="f9ecf-188">单击登录控件的登录按钮，将发生回发，并且登录控件将调用`Membership.ValidateUser`方法，同时传入的输入的用户名和密码。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-188">When the Login control's Log In button is clicked, a postback will occur and the Login control will call the `Membership.ValidateUser` method, passing in the entered username and password.</span></span> <span data-ttu-id="f9ecf-189">如果凭据无效，Login 控件将显示一条指明此类消息。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-189">If the credentials are invalid, the Login control displays a message stating such.</span></span> <span data-ttu-id="f9ecf-190">但是，如果凭据有效，然后登录控件创建窗体身份验证票证，并将用户重定向到相应的页面。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-190">If, however, the credentials are valid, then the Login control creates the forms authentication ticket and redirects the user to the appropriate page.</span></span>

<span data-ttu-id="f9ecf-191">登录控件使用四个因素来确定合适的页面，一旦成功登录到将用户重定向：</span><span class="sxs-lookup"><span data-stu-id="f9ecf-191">The Login control uses four factors to determine the appropriate page to redirect the user to upon a successful login:</span></span>

- <span data-ttu-id="f9ecf-192">登录控件是否的登录页上定义`loginUrl`设置在窗体身份验证配置中; 此设置的默认值是`Login.aspx`</span><span class="sxs-lookup"><span data-stu-id="f9ecf-192">Whether the Login control is on the login page as defined by `loginUrl` setting in the forms authentication configuration; this setting's default value is `Login.aspx`</span></span>
- <span data-ttu-id="f9ecf-193">是否存在`ReturnUrl`查询字符串参数</span><span class="sxs-lookup"><span data-stu-id="f9ecf-193">The presence of a `ReturnUrl` querystring parameter</span></span>
- <span data-ttu-id="f9ecf-194">登录控件的值[`DestinationUrl`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.destinationpageurl.aspx)</span><span class="sxs-lookup"><span data-stu-id="f9ecf-194">The value of the Login control's [`DestinationUrl` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.destinationpageurl.aspx)</span></span>
- <span data-ttu-id="f9ecf-195">`defaultUrl`身份验证配置设置在窗体中指定值; 此设置的默认值为`Default.aspx`</span><span class="sxs-lookup"><span data-stu-id="f9ecf-195">The `defaultUrl` value specified in the forms authentication configuration settings; this setting's default value is `Default.aspx`</span></span>

<span data-ttu-id="f9ecf-196">图 4 展示了如何登录控件使用这些四个参数来到达其合适的页面决策。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-196">Figure 4 depicts the how the Login control uses these four parameters to arrive at its appropriate page decision.</span></span>


<span data-ttu-id="f9ecf-197">[![将登录控件添加到页](validating-user-credentials-against-the-membership-user-store-cs/_static/image11.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="f9ecf-197">[![Add a Login Control to the Page](validating-user-credentials-against-the-membership-user-store-cs/_static/image11.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image10.png)</span></span>

<span data-ttu-id="f9ecf-198">**图 4**： 将登录控件添加到页 ([单击以查看实际尺寸的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="f9ecf-198">**Figure 4**: Add a Login Control to the Page  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image12.png))</span></span>


<span data-ttu-id="f9ecf-199">需要一段时间来测试 Login 控件通过访问通过浏览器的站点，成员身份 framework 中的现有用户的身份登录。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-199">Take a moment to test out the Login control by visiting the site through a browser and logging in as an existing user in the Membership framework.</span></span>

<span data-ttu-id="f9ecf-200">登录控件的呈现的接口是高度可配置。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-200">The Login control's rendered interface is highly configurable.</span></span> <span data-ttu-id="f9ecf-201">有多个属性可以影响它的外观;更重要的是，Login 控件可以转换为精确的控制布局的模板的用户界面元素。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-201">There are a number of properties that influence its appearance; what's more, the Login control can be converted into a template for precise control over the layout the user interface elements.</span></span> <span data-ttu-id="f9ecf-202">此步骤的其余部分检查如何自定义的外观和布局。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-202">The remainder of this step examines how to customize the appearance and layout.</span></span>

### <a name="customizing-the-login-controls-appearance"></a><span data-ttu-id="f9ecf-203">自定义登录控件的外观</span><span class="sxs-lookup"><span data-stu-id="f9ecf-203">Customizing the Login Control's Appearance</span></span>

<span data-ttu-id="f9ecf-204">登录控件的默认属性设置呈现具有 （日志中） 的标题的用户接口，对于用户名和密码输入，记住我的文本框和标签控件下次复选框和一个登录按钮。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-204">The Login control's default property settings render a user interface with a title ( Log In ), TextBox and Label controls for the username and password inputs, a Remember me next time CheckBox, and a Log In button.</span></span> <span data-ttu-id="f9ecf-205">这些元素的外观进行所有配置通过登录控件的多个属性。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-205">The appearances of these elements are all configurable through the Login control's numerous properties.</span></span> <span data-ttu-id="f9ecf-206">而且，可以通过设置属性或两个添加附加用户界面元素-例如到页面上以创建新的用户帐户的链接。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-206">Furthermore, additional user interface elements - such as a link to a page to create a new user account - can be added by setting a property or two.</span></span>

<span data-ttu-id="f9ecf-207">让我们花一些时间才能 gussy 向上我们登录控件的外观。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-207">Let's spend a few moments to gussy up the appearance of our Login control.</span></span> <span data-ttu-id="f9ecf-208">由于`Login.aspx`页已显示登录页顶部的文本，则登录控件的标题都是多余。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-208">Since the `Login.aspx` page already has text at the top of the page that says Login, the Login control's title is superfluous.</span></span> <span data-ttu-id="f9ecf-209">因此，清除[`TitleText`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.titletext.aspx)以删除登录控件的标题的值。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-209">Therefore, clear out the [`TitleText` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.titletext.aspx) value in order to remove the Login control's title.</span></span>

<span data-ttu-id="f9ecf-210">用户名: 和密码： 可以通过自定义的两个文本框中控件左侧标签[ `UserNameLabelText` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.usernamelabeltext.aspx)和[`PasswordLabelText`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordlabeltext.aspx)分别。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-210">The User Name: and Password: Labels to the left of the two TextBox controls can be customized through the [`UserNameLabelText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.usernamelabeltext.aspx) and [`PasswordLabelText` properties](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordlabeltext.aspx), respectively.</span></span> <span data-ttu-id="f9ecf-211">让我们更改用户名： 标签以读取用户名:。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-211">Let's change the User Name: Label to read Username:.</span></span> <span data-ttu-id="f9ecf-212">标签和文本框中样式均可通过进行[ `LabelStyle` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.labelstyle.aspx)和[`TextBoxStyle`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.textboxstyle.aspx)分别。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-212">The Label and TextBox styles are configurable through the [`LabelStyle`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.labelstyle.aspx) and [`TextBoxStyle` properties](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.textboxstyle.aspx), respectively.</span></span>

<span data-ttu-id="f9ecf-213">记住我可以通过登录控件的设置下一步时间复选框的文本属性[ `RememberMeText property` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.remembermetext.aspx)，并其默认检查状态都可通过配置[ `RememberMeSet property` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.remembermeset.aspx) (默认值为 False)。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-213">The Remember me next time CheckBox's Text property can be set through the Login control's [`RememberMeText property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.remembermetext.aspx), and its default checked state is configurable through the [`RememberMeSet property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.remembermeset.aspx) (which defaults to False).</span></span> <span data-ttu-id="f9ecf-214">请继续并设置`RememberMeSet`将默认选中属性设置为 True，以便记住我下次复选框。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-214">Go ahead and set the `RememberMeSet` property to True so that the Remember me next time CheckBox will be checked by default.</span></span>

<span data-ttu-id="f9ecf-215">登录控制提供有关如何调整其用户界面控件的布局的两个属性。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-215">The Login control offers two properties for adjusting the layout of its user interface controls.</span></span> <span data-ttu-id="f9ecf-216">[ `TextLayout property` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.textlayout.aspx)指示是否用户名: 和密码： 左侧的其对应的文本框中 （默认值），或其上方显示标签。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-216">The [`TextLayout property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.textlayout.aspx) indicates whether the Username: and Password: Labels appear to the left of their corresponding TextBoxes (the default), or above them.</span></span> <span data-ttu-id="f9ecf-217">[ `Orientation property` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.orientation.aspx)指示是否用户名和密码输入且恰好垂直位于 （上面另一个） 或水平。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-217">The [`Orientation property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.orientation.aspx) indicates whether the username and password inputs are situated vertically (one above the other) or horizontally.</span></span> <span data-ttu-id="f9ecf-218">我要将设置为其默认值，这两个属性，但我建议你尝试将这两个属性设置为其非默认值，若要查看产生的效果。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-218">I am going to leave these two properties set to their defaults, but I encourage you to try setting these two properties to their non-default values to see the resulting effect.</span></span>

> [!NOTE]
> <span data-ttu-id="f9ecf-219">在下一部分中，配置登录控件的布局中，我们将了解使用模板来定义布局控件的用户界面元素的精确布局。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-219">In the next section, Configuring the Login Control's Layout, we will look at using templates to define the precise layout of the Layout control's user interface elements.</span></span>


<span data-ttu-id="f9ecf-220">通过设置包装登录控件的属性设置[ `CreateUserText` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.createusertext.aspx)和[`CreateUserUrl`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.createuserurl.aspx)与非尚未注册？</span><span class="sxs-lookup"><span data-stu-id="f9ecf-220">Wrap up the Login control's property settings by setting the [`CreateUserText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.createusertext.aspx) and [`CreateUserUrl` properties](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.createuserurl.aspx) to Not registered yet?</span></span> <span data-ttu-id="f9ecf-221">创建帐户 ！</span><span class="sxs-lookup"><span data-stu-id="f9ecf-221">Create an account!</span></span> <span data-ttu-id="f9ecf-222">和`~/Membership/CreatingUserAccounts.aspx`分别。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-222">and `~/Membership/CreatingUserAccounts.aspx`, respectively.</span></span> <span data-ttu-id="f9ecf-223">这会将超链接添加到我们在中创建的登录控件的接口指针指向页<a id="SKM6"> </a>[前面教程](creating-user-accounts-cs.md)。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-223">This adds a hyperlink to the Login control's interface pointing to the page we created in the <a id="SKM6"></a>[preceding tutorial](creating-user-accounts-cs.md).</span></span> <span data-ttu-id="f9ecf-224">登录控件的[ `HelpPageText` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.helppagetext.aspx)和[`HelpPageUrl`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.helppageurl.aspx)和[ `PasswordRecoveryText` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordrecoverytext.aspx)和[`PasswordRecoveryUrl`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordrecoveryurl.aspx)即可在同样的方式呈现的帮助页和密码恢复页的链接。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-224">The Login control's [`HelpPageText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.helppagetext.aspx) and [`HelpPageUrl` properties](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.helppageurl.aspx) and [`PasswordRecoveryText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordrecoverytext.aspx) and [`PasswordRecoveryUrl` properties](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordrecoveryurl.aspx) work in the same manner, rendering links to a help page and a password recovery page.</span></span>

<span data-ttu-id="f9ecf-225">进行这些属性更改后，登录控件的声明性的标记和外观应类似于图 5 所示。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-225">After making these property changes, your Login control's declarative markup and appearance should look similar to that shown in Figure 5.</span></span>


<span data-ttu-id="f9ecf-226">[![登录控件的属性的值决定其外观](validating-user-credentials-against-the-membership-user-store-cs/_static/image14.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="f9ecf-226">[![The Login Control's Properties' Values Dictate Its Appearance](validating-user-credentials-against-the-membership-user-store-cs/_static/image14.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image13.png)</span></span>

<span data-ttu-id="f9ecf-227">**图 5**: 登录控件的属性的值决定其外观 ([单击以查看实际尺寸的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image15.png))</span><span class="sxs-lookup"><span data-stu-id="f9ecf-227">**Figure 5**: The Login Control's Properties' Values Dictate Its Appearance  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image15.png))</span></span>


### <a name="configuring-the-login-controls-layout"></a><span data-ttu-id="f9ecf-228">配置登录控件的布局</span><span class="sxs-lookup"><span data-stu-id="f9ecf-228">Configuring the Login Control's Layout</span></span>

<span data-ttu-id="f9ecf-229">登录 Web 控件的默认用户界面布局在 HTML 接口`<table>`。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-229">The Login Web control's default user interface lays out the interface in an HTML `<table>`.</span></span> <span data-ttu-id="f9ecf-230">但如果我们需要更好地控制呈现输出？</span><span class="sxs-lookup"><span data-stu-id="f9ecf-230">But what if we need finer control over the rendered output?</span></span> <span data-ttu-id="f9ecf-231">我们可能想要替换`<table>`具有一系列`<div>`标记。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-231">Maybe we want to replace the `<table>` with a series of `<div>` tags.</span></span> <span data-ttu-id="f9ecf-232">或者，如果我们的应用程序需要其他凭据进行身份验证？</span><span class="sxs-lookup"><span data-stu-id="f9ecf-232">Or what if our application requires additional credentials for authentication?</span></span> <span data-ttu-id="f9ecf-233">很多财务网站中，例如，要求用户提供不仅用户名和密码，但还个人标识号 (PIN) 或其他标识信息。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-233">Many financial websites, for instance, require users to supply not only a username and password, but also a Personal Identification Number (PIN), or other identifying information.</span></span> <span data-ttu-id="f9ecf-234">原因可能存在的内容，可将登录控件转换为模板，从中我们可以显式定义接口的声明性标记。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-234">Whatever the reasons may be, it is possible to convert the Login control into a template, from which we can explicitly define the interface's declarative markup.</span></span>

<span data-ttu-id="f9ecf-235">我们需要执行两项操作以便更新登录控件以收集其他凭据：</span><span class="sxs-lookup"><span data-stu-id="f9ecf-235">We need to do two things in order to update the Login control to collect additional credentials:</span></span>

1. <span data-ttu-id="f9ecf-236">更新以包括 Web 控件来收集其他凭据的登录控件的接口。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-236">Update the Login control's interface to include Web control(s) to collect the additional credentials.</span></span>
2. <span data-ttu-id="f9ecf-237">重写登录控件的内部身份验证逻辑，以便用户仅进行身份验证，其用户名和密码有效，并且也是有效，其附加的凭据。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-237">Override the Login control's internal authentication logic so that a user is only authenticated if their username and password is valid and their additional credentials are valid, too.</span></span>

<span data-ttu-id="f9ecf-238">若要完成第一个任务，我们需要将登录控件转换为模板并添加所需的 Web 控件。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-238">To accomplish the first task, we need to convert the Login control into a template and add the necessary Web controls.</span></span> <span data-ttu-id="f9ecf-239">与第二个任务，则可以通过创建控件的事件处理程序取代登录控件的身份验证逻辑[`Authenticate`事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.authenticate.aspx)。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-239">As for the second task, the Login control's authentication logic can be superseded by creating an event handler for the control's [`Authenticate` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.authenticate.aspx).</span></span>

<span data-ttu-id="f9ecf-240">让我们更新 Login 控件，以便它提示用户输入其用户名、 密码和电子邮件地址，如果提供的电子邮件地址与匹配的文件在其电子邮件地址仅进行身份验证用户。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-240">Let's update the Login control so that it prompts users for their username, password, and email address and only authenticates the user if the email address supplied matches their email address on file.</span></span> <span data-ttu-id="f9ecf-241">我们首先需要将登录控件的接口转换为模板。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-241">We first need to convert the Login control's interface to a template.</span></span> <span data-ttu-id="f9ecf-242">从登录控件的智能标记上，选择转换为模板选项。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-242">From the Login control's Smart Tag, choose the Convert to template option.</span></span>


<span data-ttu-id="f9ecf-243">[![将登录控件转换为模板](validating-user-credentials-against-the-membership-user-store-cs/_static/image17.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="f9ecf-243">[![Convert the Login Control to a Template](validating-user-credentials-against-the-membership-user-store-cs/_static/image17.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image16.png)</span></span>

<span data-ttu-id="f9ecf-244">**图 6**： 转换为模板 Login 控件 ([单击以查看实际尺寸的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="f9ecf-244">**Figure 6**: Convert the Login Control to a Template  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image18.png))</span></span>


> [!NOTE]
> <span data-ttu-id="f9ecf-245">若要恢复到其预 template 版本 Login 控件，请单击从控件的智能标记的重置链接。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-245">To revert the Login control to its pre-template version, click the Reset link from the control's Smart Tag.</span></span>


<span data-ttu-id="f9ecf-246">将登录控件转换为模板将添加`LayoutTemplate`到控件的 HTML 元素和定义的用户界面的 Web 控件与声明性标记。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-246">Converting the Login control to a template adds a `LayoutTemplate` to the control's declarative markup with HTML elements and Web controls defining the user interface.</span></span> <span data-ttu-id="f9ecf-247">如图 7 所示，将控件转换到模板中删除多个属性从属性窗口中，如`TitleText`， `CreateUserUrl`，依此类推，因为使用模板时，将忽略这些属性值。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-247">As Figure 7 shows, converting the control to a template removes a number of properties from the Properties window, such as `TitleText`, `CreateUserUrl`, and so forth, since these property values are ignored when using a template.</span></span>


<span data-ttu-id="f9ecf-248">[![较少的属性是可用的时登录控件转换为模板](validating-user-credentials-against-the-membership-user-store-cs/_static/image20.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="f9ecf-248">[![Fewer Properties are Available When the Login Control is Converted to a Template](validating-user-credentials-against-the-membership-user-store-cs/_static/image20.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image19.png)</span></span>

<span data-ttu-id="f9ecf-249">**图 7**： 较少的属性是可用的时登录控件转换为模板 ([单击以查看实际尺寸的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image21.png))</span><span class="sxs-lookup"><span data-stu-id="f9ecf-249">**Figure 7**: Fewer Properties are Available When the Login Control is Converted to a Template  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image21.png))</span></span>


<span data-ttu-id="f9ecf-250">中的 HTML 标记`LayoutTemplate`可能根据需要修改。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-250">The HTML markup in the `LayoutTemplate` may be modified as needed.</span></span> <span data-ttu-id="f9ecf-251">同样，随意向模板添加任何新 Web 控件。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-251">Likewise, feel free to add any new Web controls to the template.</span></span> <span data-ttu-id="f9ecf-252">但是，很重要，该登录控件的核心 Web 控件保留在该模板，并保留其分配`ID`值。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-252">However, it is important that Login control's core Web controls remain in the template and keep their assigned `ID` values.</span></span> <span data-ttu-id="f9ecf-253">具体而言，不删除或重命名`UserName`或`Password`文本框中，`RememberMe`复选框，`LoginButton`按钮，`FailureText`标签，或`RequiredFieldValidator`控件。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-253">In particular, do not remove or rename the `UserName` or `Password` TextBoxes, the `RememberMe` CheckBox, the `LoginButton` Button, the `FailureText` Label, or the `RequiredFieldValidator` controls.</span></span>

<span data-ttu-id="f9ecf-254">若要收集访问者的电子邮件地址，我们需要将一个文本框添加到模板。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-254">To collect the visitor's email address, we need to add a TextBox to the template.</span></span> <span data-ttu-id="f9ecf-255">添加以下声明性标记表行之间 (`<tr>`)，该字符串包含`Password`文本框中和下一步保存记住我的表行时间复选框：</span><span class="sxs-lookup"><span data-stu-id="f9ecf-255">Add the following declarative markup between the table row (`<tr>`) that contains the `Password` TextBox and the table row that holds the Remember me next time CheckBox:</span></span>

[!code-aspx[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample2.aspx)]

<span data-ttu-id="f9ecf-256">在添加后`Email`文本框中，请访问通过浏览器页面。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-256">After adding the `Email` TextBox, visit the page through a browser.</span></span> <span data-ttu-id="f9ecf-257">如图 8 所示，登录控件的用户界面现在包括第三个文本框。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-257">As Figure 8 shows, the Login control's user interface now includes a third textbox.</span></span>


<span data-ttu-id="f9ecf-258">[![登录控件现在包括有关用户的电子邮件地址文本框中](validating-user-credentials-against-the-membership-user-store-cs/_static/image23.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="f9ecf-258">[![The Login Control Now Includes a Textbox for the User's Email Address](validating-user-credentials-against-the-membership-user-store-cs/_static/image23.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image22.png)</span></span>

<span data-ttu-id="f9ecf-259">**图 8**： 登录控件现在包括有关用户的电子邮件地址文本框中 ([单击以查看实际尺寸的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image24.png))</span><span class="sxs-lookup"><span data-stu-id="f9ecf-259">**Figure 8**: The Login Control Now Includes a Textbox for the User's Email Address  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image24.png))</span></span>


<span data-ttu-id="f9ecf-260">此时，Login 控件仍在使用`Membership.ValidateUser`方法以验证提供的凭据。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-260">At this point, the Login control is still using the `Membership.ValidateUser` method to validate the supplied credentials.</span></span> <span data-ttu-id="f9ecf-261">相应地，在输入值`Email`文本框中没有任何影响在用户可以登录。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-261">Correspondingly, the value entered into the `Email` TextBox has no bearing on whether the user can log in.</span></span> <span data-ttu-id="f9ecf-262">在步骤 3 中，我们将介绍如何重写登录控件的身份验证逻辑，以便凭据仅被视为有效如果的用户名和密码有效，并且提供电子邮件地址匹配文件上的电子邮件地址。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-262">In Step 3 we will look at how to override the Login control's authentication logic so that the credentials are only considered valid if the username and password are valid and the supplied email address matches up with the email address on file.</span></span>

## <a name="step-3-modifying-the-login-controls-authentication-logic"></a><span data-ttu-id="f9ecf-263">步骤 3： 修改登录控件的身份验证逻辑</span><span class="sxs-lookup"><span data-stu-id="f9ecf-263">Step 3: Modifying the Login Control's Authentication Logic</span></span>

<span data-ttu-id="f9ecf-264">当访问者提供其凭据并单击登录按钮，回发时，才会和登录名来控制其身份验证工作流中的进行处理时。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-264">When a visitor supplies her credentials and clicks the Log In button, a postback ensues and the Login control progresses through its authentication workflow.</span></span> <span data-ttu-id="f9ecf-265">工作流实例开始通过引发[`LoggingIn`事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loggingin.aspx)。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-265">The workflow starts by raising the [`LoggingIn` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loggingin.aspx).</span></span> <span data-ttu-id="f9ecf-266">与此事件关联的任何事件处理程序可能会取消操作中的日志，通过设置`e.Cancel`属性`true`。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-266">Any event handlers associated with this event may cancel the log in operation by setting the `e.Cancel` property to `true`.</span></span>

<span data-ttu-id="f9ecf-267">如果在操作中的日志不会被取消，工作流执行过程通过引发[`Authenticate`事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.authenticate.aspx)。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-267">If the log in operation is not cancelled, the workflow progresses by raising the [`Authenticate` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.authenticate.aspx).</span></span> <span data-ttu-id="f9ecf-268">如果没有一个事件处理程序`Authenticate`事件，然后它负责确定提供的凭据是否有效。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-268">If there is an event handler for the `Authenticate` event, then it is responsible for determining whether the supplied credentials are valid or not.</span></span> <span data-ttu-id="f9ecf-269">如果不指定任何事件处理程序，则使用登录控件`Membership.ValidateUser`方法来确定所提供的凭据的有效性。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-269">If no event handler is specified, the Login control uses the `Membership.ValidateUser` method to determine the validity of the credentials.</span></span>

<span data-ttu-id="f9ecf-270">如果提供的凭据是否有效，则将创建窗体身份验证票证， [ `LoggedIn`事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loggedin.aspx)引发时，用户被重定向到合适的页面。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-270">If the supplied credentials are valid, then the forms authentication ticket is created, the [`LoggedIn` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loggedin.aspx) is raised, and the user is redirected to the appropriate page.</span></span> <span data-ttu-id="f9ecf-271">如果，但是，凭据被认为是无效，则[`LoginError`事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loginerror.aspx)引发是显示一条消息，告知用户其凭据已无效。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-271">If, however, the credentials are deemed invalid, then the [`LoginError` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loginerror.aspx) is raised and a message is displayed informing the user that their credentials were invalid.</span></span> <span data-ttu-id="f9ecf-272">默认情况下，在失败登录控件只需将设置其`FailureText`标签控件文本属性 （您登录尝试未成功失败消息。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-272">By default, on failure the Login control simply sets its `FailureText` Label control's Text property to a failure message ( Your login attempt was not successful.</span></span> <span data-ttu-id="f9ecf-273">请重试）。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-273">Please try again ).</span></span> <span data-ttu-id="f9ecf-274">但是，如果登录控件的[`FailureAction`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.failureaction.aspx)设置为`RedirectToLoginPage`，然后登录控制问题`Response.Redirect`至登录页追加查询字符串参数`loginfailure=1`（这将导致该登录名控件来显示失败消息）。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-274">However, if the Login control's [`FailureAction` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.failureaction.aspx) is set to `RedirectToLoginPage`, then the Login control issues a `Response.Redirect` to the login page appending the querystring parameter `loginfailure=1` (which causes the Login control to display the failure message).</span></span>

<span data-ttu-id="f9ecf-275">图 9 提供的身份验证工作流的流程图。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-275">Figure 9 offers a flow chart of the authentication workflow.</span></span>


<span data-ttu-id="f9ecf-276">[![登录控件的身份验证工作流](validating-user-credentials-against-the-membership-user-store-cs/_static/image26.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="f9ecf-276">[![The Login Control's Authentication Workflow](validating-user-credentials-against-the-membership-user-store-cs/_static/image26.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image25.png)</span></span>

<span data-ttu-id="f9ecf-277">**图 9**: 登录控件的身份验证工作流 ([单击以查看实际尺寸的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image27.png))</span><span class="sxs-lookup"><span data-stu-id="f9ecf-277">**Figure 9**: The Login Control's Authentication Workflow  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image27.png))</span></span>


> [!NOTE]
> <span data-ttu-id="f9ecf-278">如果你是否想知道当你将使用`FailureAction`的`RedirectToLogin`选项页上，请考虑以下方案。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-278">If you are wondering when you would use the `FailureAction`'s `RedirectToLogin` page option, consider the following scenario.</span></span> <span data-ttu-id="f9ecf-279">现在我们`Site.master`母版页当前具有，Hello，stranger 中显示的文本的左边的列时访问由匿名用户，但假设我们想要将该文本替换为登录控件。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-279">Right now our `Site.master` master page currently has the text, Hello, stranger displayed in the left column when visited by an anonymous user, but imagine that we wanted to replace that text with a Login control.</span></span> <span data-ttu-id="f9ecf-280">这样可以允许匿名用户若要从该站点，而无需直接访问登录页上的任何页登录。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-280">This would allow an anonymous user to log in from any page on the site, instead of requiring them to visit the login page directly.</span></span> <span data-ttu-id="f9ecf-281">但是，如果用户无法登录通过登录控件由主控页呈现，它可能使意义上，若要将它们重定向到登录页 (`Login.aspx`) 因为该页可能包含其他说明、 链接和其他帮助-例如，若要创建的链接新的帐户或检索的丢失密码的未被添加到母版页。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-281">However, if a user was unable to log in via the Login control rendered by the master page, it might make sense to redirect them to the login page (`Login.aspx`) because that page likely includes additional instructions, links, and other help - such as links to create a new account or retrieve a lost password - that were not added to the master page.</span></span>


### <a name="creating-theauthenticateevent-handler"></a><span data-ttu-id="f9ecf-282">创建`Authenticate`事件处理程序</span><span class="sxs-lookup"><span data-stu-id="f9ecf-282">Creating the`Authenticate`Event Handler</span></span>

<span data-ttu-id="f9ecf-283">若要插入到我们的自定义身份验证逻辑中，我们需要创建登录名控件的一个事件处理程序`Authenticate`事件。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-283">In order to plug in our custom authentication logic, we need to create an event handler for the Login control's `Authenticate` event.</span></span> <span data-ttu-id="f9ecf-284">创建的事件处理程序`Authenticate`事件将生成以下事件处理程序定义：</span><span class="sxs-lookup"><span data-stu-id="f9ecf-284">Creating an event handler for the `Authenticate` event will generate the following event handler definition:</span></span>

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample3.cs)]

<span data-ttu-id="f9ecf-285">如你所见，`Authenticate`事件处理程序传递的类型对象[ `AuthenticateEventArgs` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.authenticateeventargs.aspx)作为其第二个输入参数。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-285">As you can see, the `Authenticate` event handler is passed an object of type [`AuthenticateEventArgs`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.authenticateeventargs.aspx) as its second input parameter.</span></span> <span data-ttu-id="f9ecf-286">`AuthenticateEventArgs`类包含名为的布尔属性`Authenticated`用于指定提供的凭据是否有效。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-286">The `AuthenticateEventArgs` class contains a Boolean property named `Authenticated` that is used to specify whether the supplied credentials are valid.</span></span> <span data-ttu-id="f9ecf-287">我们的任务，然后，是编写代码此处以确定提供的凭据是否有效或不是，并将设置`e.Authenticate`属性相应地。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-287">Our task, then, is to write code here that determines whether the supplied credentials are valid or not, and to set the `e.Authenticate` property accordingly.</span></span>

### <a name="determining-and-validating-the-supplied-credentials"></a><span data-ttu-id="f9ecf-288">确定和验证提供的凭据</span><span class="sxs-lookup"><span data-stu-id="f9ecf-288">Determining and Validating the Supplied Credentials</span></span>

<span data-ttu-id="f9ecf-289">使用登录控件的[ `UserName` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.username.aspx)和[`Password`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.password.aspx)来确定由用户输入的用户名和密码凭据。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-289">Use the Login control's [`UserName`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.username.aspx) and [`Password` properties](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.password.aspx) to determine the username and password credentials entered by the user.</span></span> <span data-ttu-id="f9ecf-290">若要确定在任何其他 Web 控件中输入的值 (如`Email`我们在上一步中添加的文本框中)，使用 *`LoginControlID`*  `.FindControl`(" *`controlID`* ") 来获取以编程方式引用为 Web 控件模板中其`ID`属性等于 *`controlID`* 。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-290">In order to determine the values entered into any additional Web controls (such as the `Email` TextBox we added in the previous step), use *`LoginControlID`*`.FindControl`("*`controlID`*") to obtain a programmatic reference to the Web control in the template whose `ID` property is equal to *`controlID`*.</span></span> <span data-ttu-id="f9ecf-291">例如，若要获取对引用`Email`文本框中，使用以下代码：</span><span class="sxs-lookup"><span data-stu-id="f9ecf-291">For example, to get a reference to the `Email` TextBox, use the following code:</span></span>

`TextBox EmailTextBox = myLogin.FindControl("Email") as TextBox;`

<span data-ttu-id="f9ecf-292">若要验证用户的凭据，我们需要做两件事：</span><span class="sxs-lookup"><span data-stu-id="f9ecf-292">In order to validate the user's credentials we need to do two things:</span></span>

1. <span data-ttu-id="f9ecf-293">确保提供的用户名和密码有效</span><span class="sxs-lookup"><span data-stu-id="f9ecf-293">Ensure that the provided username and password are valid</span></span>
2. <span data-ttu-id="f9ecf-294">确保输入的电子邮件地址与试图进行登录的用户的文件上的电子邮件地址</span><span class="sxs-lookup"><span data-stu-id="f9ecf-294">Ensure that email address entered matches the email address on file for the user attempting to log in</span></span>

<span data-ttu-id="f9ecf-295">若要完成第一项检查我们就可以使用`Membership.ValidateUser`像我们在步骤 1 中看到的方法。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-295">To accomplish the first check we can simply use the `Membership.ValidateUser` method like we saw in Step 1.</span></span> <span data-ttu-id="f9ecf-296">对于第二项检查，我们需要确定用户的电子邮件地址，以便我们可以将其向文本框控件输入的电子邮件地址进行比较。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-296">For the second check, we need to determine the user's email address so that we can compare it to the email address they entered into the TextBox control.</span></span> <span data-ttu-id="f9ecf-297">若要获取有关特定用户的信息，请使用`Membership`类的[`GetUser`方法](https://msdn.microsoft.com/library/system.web.security.membership.getuser.aspx)。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-297">To get information about a particular user, use the `Membership` class's [`GetUser` method](https://msdn.microsoft.com/library/system.web.security.membership.getuser.aspx).</span></span>

<span data-ttu-id="f9ecf-298">`GetUser`方法具有大量的重载。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-298">The `GetUser` method has a number of overloads.</span></span> <span data-ttu-id="f9ecf-299">如果使用未传入任何参数，它将返回有关当前已登录用户的信息。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-299">If used without passing in any parameters, it returns information about the currently logged in user.</span></span> <span data-ttu-id="f9ecf-300">若要获取有关特定用户的信息，请调用`GetUser`在其用户名中传递。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-300">To get information about a particular user, call `GetUser` passing in their username.</span></span> <span data-ttu-id="f9ecf-301">两种方式的`GetUser`返回[`MembershipUser`对象](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx)，它具有属性，例如`UserName`， `Email`， `IsApproved`， `IsOnline`，依次类推。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-301">Either way, `GetUser` returns a [`MembershipUser` object](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx), which has properties like `UserName`, `Email`, `IsApproved`, `IsOnline`, and so on.</span></span>

<span data-ttu-id="f9ecf-302">下面的代码实现这些两个检查。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-302">The following code implements these two checks.</span></span> <span data-ttu-id="f9ecf-303">如果同时通过，然后`e.Authenticate`设置为`true`，否则它将分配`false`。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-303">If both pass, then `e.Authenticate` is set to `true`, otherwise it is assigned `false`.</span></span>

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample4.cs)]

<span data-ttu-id="f9ecf-304">使用此代码中的位置，尝试为输入正确的用户名、 密码和电子邮件地址的有效用户登录。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-304">With this code in place, attempt to log in as a valid user, entering the correct username, password, and email address.</span></span> <span data-ttu-id="f9ecf-305">重试，但这次有意使用不正确的电子邮件地址 （请参阅图 10）。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-305">Try it again, but this time purposefully use an incorrect email address (see Figure 10).</span></span> <span data-ttu-id="f9ecf-306">最后，它尝试使用不存在用户名第三次。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-306">Finally, try it a third time using a non-existent username.</span></span> <span data-ttu-id="f9ecf-307">在第一种情况下你应已成功登录到站点，但在最后两个情况下，你应看到登录控件的凭据无效消息。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-307">In the first case you should be successfully logged on to the site, but in the last two cases you should see the Login control's invalid credentials message.</span></span>


<span data-ttu-id="f9ecf-308">[![提供不正确的电子邮件地址时，Tito 无法登录。](validating-user-credentials-against-the-membership-user-store-cs/_static/image29.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image28.png)</span><span class="sxs-lookup"><span data-stu-id="f9ecf-308">[![Tito Cannot Log In When Supplying an Incorrect Email Address](validating-user-credentials-against-the-membership-user-store-cs/_static/image29.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image28.png)</span></span>

<span data-ttu-id="f9ecf-309">**图 10**: Tito 无法日志中时提供不正确的电子邮件地址 ([单击以查看实际尺寸的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image30.png))</span><span class="sxs-lookup"><span data-stu-id="f9ecf-309">**Figure 10**: Tito Cannot Log In When Supplying an Incorrect Email Address  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image30.png))</span></span>


> [!NOTE]
> <span data-ttu-id="f9ecf-310">步骤 1 中的如何成员资格 Framework 处理无效登录尝试次数部分中所述时`Membership.ValidateUser`方法调用该方法并传递凭据无效，它跟踪的无效登录尝试以及某一特定超出时阻止用户指定的时间窗口内的无效尝试次数的阈值。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-310">As discussed in the How the Membership Framework Handles Invalid Login Attempts section in Step 1, when the `Membership.ValidateUser` method is called and passed invalid credentials, it keeps track of the invalid login attempt and locks out the user if they exceed a certain threshold of invalid attempts within a specified time window.</span></span> <span data-ttu-id="f9ecf-311">因为我们自定义身份验证逻辑调用`ValidateUser`方法，有效用户名不正确的密码将递增无效的登录尝试计数器，但此计数器不会增加在这种情况，其中的用户名和密码是否有效，但电子邮件地址不正确。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-311">Since our custom authentication logic calls the `ValidateUser` method, an incorrect password for a valid username will increment the invalid login attempt counter, but this counter is not incremented in the case where the username and password are valid, but the email address is incorrect.</span></span> <span data-ttu-id="f9ecf-312">很有，此行为很合适，因为它不太黑客将知道的用户名和密码，但需要使用暴力破解技术来确定用户的电子邮件地址。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-312">Chances are, this behavior is suitable, since it's unlikely that a hacker will know the username and password, but have to use brute force techniques to determine the user's email address.</span></span>


## <a name="step-4-improving-the-login-controls-invalid-credentials-message"></a><span data-ttu-id="f9ecf-313">步骤 4： 提高登录控件的凭据无效消息</span><span class="sxs-lookup"><span data-stu-id="f9ecf-313">Step 4: Improving the Login Control's Invalid Credentials Message</span></span>

<span data-ttu-id="f9ecf-314">当用户尝试使用无效的凭据登录时，登录名，将显示一条消息说明的登录尝试不成功。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-314">When a user attempts to log on with invalid credentials, the Login control displays a message explaining that the login attempt was unsuccessful.</span></span> <span data-ttu-id="f9ecf-315">具体而言，该控件将显示由指定的消息其[`FailureText`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.failuretext.aspx)，具有默认值为您的登录尝试未成功。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-315">In particular, the control displays the message specified by its [`FailureText` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.failuretext.aspx), which has a default value of Your login attempt was not successful.</span></span> <span data-ttu-id="f9ecf-316">请重试。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-316">Please try again.</span></span>

<span data-ttu-id="f9ecf-317">回想一下，原因有很多原因用户的凭据可能无效：</span><span class="sxs-lookup"><span data-stu-id="f9ecf-317">Recall that there are many reasons why a user's credentials may be invalid:</span></span>

- <span data-ttu-id="f9ecf-318">用户名可能不存在</span><span class="sxs-lookup"><span data-stu-id="f9ecf-318">The username may not exist</span></span>
- <span data-ttu-id="f9ecf-319">用户名已存在，但密码为无效</span><span class="sxs-lookup"><span data-stu-id="f9ecf-319">The username exists, but the password is invalid</span></span>
- <span data-ttu-id="f9ecf-320">用户名和密码是虽然有效，但尚未批准的用户</span><span class="sxs-lookup"><span data-stu-id="f9ecf-320">The username and password are valid, but the user is not yet approved</span></span>
- <span data-ttu-id="f9ecf-321">用户名和密码是否有效，但是用户已被锁定扩展 （最有可能是由于它们超出指定的时间范围内的无效的登录尝试次数）</span><span class="sxs-lookup"><span data-stu-id="f9ecf-321">The username and password are valid, but the user is locked out (most likely because they exceeded the number of invalid login attempts within the specified time frame)</span></span>

<span data-ttu-id="f9ecf-322">和可能存在其他原因时使用自定义身份验证逻辑。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-322">And there may be other reasons when using custom authentication logic.</span></span> <span data-ttu-id="f9ecf-323">例如，替换为代码，我们编写了在步骤 3 中，用户名和密码可能有效，但可能不正确的电子邮件地址。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-323">For example, with the code we wrote in Step 3, the username and password may be valid, but the email address may be incorrect.</span></span>

<span data-ttu-id="f9ecf-324">无论原因的凭据无效，Login 控件显示相同的错误消息。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-324">Regardless of why the credentials are invalid, the Login control displays the same error message.</span></span> <span data-ttu-id="f9ecf-325">这种反馈缺乏可以让其帐户尚未批准或人员已锁定的用户感到困惑。通过工作很少，不过，我们可以具有的登录控制显示更适当的消息。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-325">This lack of feedback can be confusing for a user whose account has not yet been approved or who has been locked out. With a little bit of work, though, we can have the Login control display a more appropriate message.</span></span>

<span data-ttu-id="f9ecf-326">每当用户尝试登录与登录控件引发的凭据无效其`LoginError`事件。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-326">Whenever a user attempts to login with invalid credentials the Login control raises its `LoginError` event.</span></span> <span data-ttu-id="f9ecf-327">继续并创建事件处理程序对于此事件，并添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="f9ecf-327">Go ahead and create an event handler for this event, and add the following code:</span></span>

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample5.cs)]

<span data-ttu-id="f9ecf-328">上面的代码首先设置登录控件的`FailureText`属性设置为默认值 （您的登录尝试未成功。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-328">The above code starts by setting the Login control's `FailureText` property to the default value ( Your login attempt was not successful.</span></span> <span data-ttu-id="f9ecf-329">请重试）。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-329">Please try again ).</span></span> <span data-ttu-id="f9ecf-330">它然后检查是否提供的用户名将映射到现有的用户帐户。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-330">It then checks to see if the username supplied maps to an existing user account.</span></span> <span data-ttu-id="f9ecf-331">如果是，向生成`MembershipUser`对象的`IsLockedOut`和`IsApproved`属性以确定是否帐户已锁定，或者尚未批准。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-331">If so, it consults the resulting `MembershipUser` object's `IsLockedOut` and `IsApproved` properties to determine if the account has been locked out or has not yet been approved.</span></span> <span data-ttu-id="f9ecf-332">在任一情况下，`FailureText`属性更新为相应的值。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-332">In either case, the `FailureText` property is updated to a corresponding value.</span></span>

<span data-ttu-id="f9ecf-333">若要测试此代码，有意尝试登录作为现有用户，但使用了错误的密码。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-333">To test this code, purposefully attempt to log in as an existing user, but use an incorrect password.</span></span> <span data-ttu-id="f9ecf-334">在 10 分钟时间范围内的行中执行操作这五次，该帐户将被锁定。图 11 显示，后续的登录尝试将始终会失败 （甚至使用正确的密码），但现在将显示更具描述性你的帐户已锁定由于无效的登录尝试输入太多次。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-334">Do this five times in a row within a 10 minute time frame and the account will be locked out. As Figure 11 shows, subsequent login attempts will always fail (even with the correct password), but will now display the more descriptive Your account has been locked out because of too many invalid login attempts.</span></span> <span data-ttu-id="f9ecf-335">请与管理员联系，让你的帐户解锁的邮件。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-335">Please contact the administrator to have your account unlocked message.</span></span>


<span data-ttu-id="f9ecf-336">[![Tito 执行无效的登录尝试输入太多次，并且已被锁定。](validating-user-credentials-against-the-membership-user-store-cs/_static/image32.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="f9ecf-336">[![Tito Performed Too Many Invalid Login Attempts and Has Been Locked Out](validating-user-credentials-against-the-membership-user-store-cs/_static/image32.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image31.png)</span></span>

<span data-ttu-id="f9ecf-337">**图 11**: Tito 执行太多无效登录尝试次数和具有已锁定 ([单击以查看实际尺寸的图像](validating-user-credentials-against-the-membership-user-store-cs/_static/image33.png))</span><span class="sxs-lookup"><span data-stu-id="f9ecf-337">**Figure 11**: Tito Performed Too Many Invalid Login Attempts and Has Been Locked Out  ([Click to view full-size image](validating-user-credentials-against-the-membership-user-store-cs/_static/image33.png))</span></span>


## <a name="summary"></a><span data-ttu-id="f9ecf-338">摘要</span><span class="sxs-lookup"><span data-stu-id="f9ecf-338">Summary</span></span>

<span data-ttu-id="f9ecf-339">以前本教程中，我们登录页验证的用户名/密码对硬编码列表提供的凭据。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-339">Prior this tutorial, our login page validated the supplied credentials against a hard-coded list of username/password pairs.</span></span> <span data-ttu-id="f9ecf-340">在本教程中，我们更新页后，可以验证针对成员资格框架的凭据。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-340">In this tutorial, we updated the page to validate credentials against the Membership framework.</span></span> <span data-ttu-id="f9ecf-341">在步骤 1 中我们讨论在使用`Membership.ValidateUser`方法以编程方式。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-341">In Step 1 we looked at using the `Membership.ValidateUser` method programmatically.</span></span> <span data-ttu-id="f9ecf-342">在步骤 2 中我们已更换我们手动创建的用户界面和代码与登录控件。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-342">In Step 2 we replaced our manually created user interface and code with the Login control.</span></span>

<span data-ttu-id="f9ecf-343">登录控件呈现标准登录用户界面，并自动验证用户的凭据针对成员资格框架。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-343">The Login control renders a standard login user interface and automatically validates the user's credentials against the Membership framework.</span></span> <span data-ttu-id="f9ecf-344">此外，在发生时有效的凭据，登录控制用户在登录通过窗体身份验证。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-344">Moreover, in the event of valid credentials, the Login control signs the user in via forms authentication.</span></span> <span data-ttu-id="f9ecf-345">简单地说，完全正常运行的登录名的用户体验是可用只需将登录控件拖动到页面、 没有额外声明性标记或所需代码。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-345">In short, a fully functional login user experience is available by simply dragging the Login control onto a page, no extra declarative markup or code necessary.</span></span> <span data-ttu-id="f9ecf-346">更多的是什么，Login 控件是可高度自定义，允许进行精细大程度上控制呈现的用户界面和身份验证逻辑。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-346">What's more, the Login control is highly customizable, allowing for a fine degree of control over both the rendered user interface and authentication logic.</span></span>

<span data-ttu-id="f9ecf-347">此时我们的网站的访问者可以创建新的用户帐户和日志到站点，但我们尚未查看限制对页基于经过身份验证的用户访问权限。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-347">At this point visitors to our website can create a new user account and log into the site, but we have yet to look at restricting access to pages based on the authenticated user.</span></span> <span data-ttu-id="f9ecf-348">当前，任何用户，经过身份验证或匿名的可以在我们的站点上查看的任何页面。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-348">Currently, any user, authenticated or anonymous, can view any page on our site.</span></span> <span data-ttu-id="f9ecf-349">以及控制访问我们的站点上的页面以用户的用户为基础，我们可能具有其功能依赖于用户某些页。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-349">Along with controlling access to our site's pages on a user-by-user basis, we might have certain pages whose functionality depends on the user.</span></span> <span data-ttu-id="f9ecf-350">下一教程讲述如何限制和根据在已登录用户的页面中功能的访问。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-350">The next tutorial looks at how to limit access and in-page functionality based on the logged in user.</span></span>

<span data-ttu-id="f9ecf-351">尽情享受编程 ！</span><span class="sxs-lookup"><span data-stu-id="f9ecf-351">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="f9ecf-352">其他阅读材料</span><span class="sxs-lookup"><span data-stu-id="f9ecf-352">Further Reading</span></span>

<span data-ttu-id="f9ecf-353">在本教程中讨论的主题的详细信息，请参阅以下资源：</span><span class="sxs-lookup"><span data-stu-id="f9ecf-353">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="f9ecf-354">显示自定义消息到锁定和未经批准的用户</span><span class="sxs-lookup"><span data-stu-id="f9ecf-354">Displaying Custom Messages to Locked Out and Non-Approved Users</span></span>](http://aspnet.4guysfromrolla.com/articles/050306-1.aspx)
- [<span data-ttu-id="f9ecf-355">检查 ASP.NET 2.0 的成员资格、 角色和配置文件</span><span class="sxs-lookup"><span data-stu-id="f9ecf-355">Examining ASP.NET 2.0's Membership, Roles, and Profile</span></span>](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx)
- [<span data-ttu-id="f9ecf-356">如何： 创建 ASP.NET 登录页</span><span class="sxs-lookup"><span data-stu-id="f9ecf-356">How To: Create an ASP.NET Login Page</span></span>](https://msdn.microsoft.com/library/ms178331.aspx)
- [<span data-ttu-id="f9ecf-357">登录控件技术文档</span><span class="sxs-lookup"><span data-stu-id="f9ecf-357">Login Control Technical Documentation</span></span>](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.aspx)
- [<span data-ttu-id="f9ecf-358">使用登录控件</span><span class="sxs-lookup"><span data-stu-id="f9ecf-358">Using the Login Controls</span></span>](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/security/login.aspx)

### <a name="about-the-author"></a><span data-ttu-id="f9ecf-359">关于作者</span><span class="sxs-lookup"><span data-stu-id="f9ecf-359">About the Author</span></span>

<span data-ttu-id="f9ecf-360">Scott Mitchell，多个 ASP/ASP.NET 丛书的作者和创始人 4GuysFromRolla.com，具有已使用自 1998 年 Microsoft Web 技术。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-360">Scott Mitchell, author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="f9ecf-361">Scott 的作用是作为独立的顾问、 培训师和编写器。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-361">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="f9ecf-362">最新书籍是 *[Sam 教授自己 ASP.NET 2.0 24 小时内](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-362">His latest book is *[Sams Teach Yourself ASP.NET 2.0 in 24 Hours](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span></span> <span data-ttu-id="f9ecf-363">可以在达到 Scott [ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com)或通过在其博客地址[http://ScottOnWriting.NET](http://scottonwriting.net/)。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-363">Scott can be reached at [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="f9ecf-364">特别感谢</span><span class="sxs-lookup"><span data-stu-id="f9ecf-364">Special Thanks To</span></span>

<span data-ttu-id="f9ecf-365">本教程系列已由许多有用的审阅者评审。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-365">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="f9ecf-366">本教程中的前导审阅者已 Teresa 墨和 Michael Olivero。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-366">Lead reviewers for this tutorial were Teresa Murphy and Michael Olivero.</span></span> <span data-ttu-id="f9ecf-367">对感兴趣查看我即将到来的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="f9ecf-367">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="f9ecf-368">如果是这样，删除我一行[ mitchell@4GuysFromRolla.com ](mailto:mitchell@4guysfromrolla.com)。</span><span class="sxs-lookup"><span data-stu-id="f9ecf-368">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4guysfromrolla.com).</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="f9ecf-369">[上一页](creating-user-accounts-cs.md)
[下一页](user-based-authorization-cs.md)</span><span class="sxs-lookup"><span data-stu-id="f9ecf-369">[Previous](creating-user-accounts-cs.md)
[Next](user-based-authorization-cs.md)</span></span>
