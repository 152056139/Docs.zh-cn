---
uid: whitepapers/add-mobile-pages-to-your-aspnet-web-forms-mvc-application
title: "如何： 将移动页面添加到 ASP.NET Web 窗体 / MVC 应用程序 |Microsoft 文档"
author: rick-anderson
description: "本介绍通过多种方式来提供针对 ASP.NET Web 窗体中的移动设备进行了优化的页面 / MVC 应用程序，并提供的建议体系结构和..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 01/20/2011
ms.topic: article
ms.assetid: 3124f28e-cc32-418a-afe3-519fa56f4c36
ms.technology: 
ms.prod: .net-framework
msc.legacyurl: /whitepapers/add-mobile-pages-to-your-aspnet-web-forms-mvc-application
msc.type: content
ms.openlocfilehash: aac359b26c508784793a67260dc2e65c30db687a
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 01/24/2018
---
<a name="how-to-add-mobile-pages-to-your-aspnet-web-forms--mvc-application"></a><span data-ttu-id="a4b87-103">如何： 将移动页面添加到 ASP.NET Web 窗体 / MVC 应用程序</span><span class="sxs-lookup"><span data-stu-id="a4b87-103">How To: Add Mobile Pages to Your ASP.NET Web Forms / MVC Application</span></span>
====================
> <span data-ttu-id="a4b87-104">**适用于**</span><span class="sxs-lookup"><span data-stu-id="a4b87-104">**Applies To**</span></span>
> 
> - <span data-ttu-id="a4b87-105">ASP.NET Web 窗体版本 4.0</span><span class="sxs-lookup"><span data-stu-id="a4b87-105">ASP.NET Web Forms version 4.0</span></span>
> - <span data-ttu-id="a4b87-106">ASP.NET MVC 版本 3.0</span><span class="sxs-lookup"><span data-stu-id="a4b87-106">ASP.NET MVC version 3.0</span></span>
> 
> <span data-ttu-id="a4b87-107">**摘要**</span><span class="sxs-lookup"><span data-stu-id="a4b87-107">**Summary**</span></span>
> 
> <span data-ttu-id="a4b87-108">本介绍通过多种方式来提供针对 ASP.NET Web 窗体中的移动设备进行了优化的页面 / MVC 应用程序和提供的建议体系结构和设计时目标大范围的设备要考虑的问题。</span><span class="sxs-lookup"><span data-stu-id="a4b87-108">This How To describes various ways to serve pages optimized for mobile devices from your ASP.NET Web Forms / MVC application, and suggests architectural and design issues to consider when targeting a broad range of devices.</span></span> <span data-ttu-id="a4b87-109">为什么从 ASP.NET 2.0 到 3.5 ASP.NET 移动控件现已过时，并讨论某些现代的替代方法，还介绍了此文档。</span><span class="sxs-lookup"><span data-stu-id="a4b87-109">This document also explains why the ASP.NET Mobile Controls from ASP.NET 2.0 to 3.5 are now obsolete, and discusses some modern alternatives.</span></span>


## <a name="contents"></a><span data-ttu-id="a4b87-110">内容</span><span class="sxs-lookup"><span data-stu-id="a4b87-110">Contents</span></span>

- <span data-ttu-id="a4b87-111">概述</span><span class="sxs-lookup"><span data-stu-id="a4b87-111">Overview</span></span>
- <span data-ttu-id="a4b87-112">体系结构选项</span><span class="sxs-lookup"><span data-stu-id="a4b87-112">Architectural options</span></span>
- <span data-ttu-id="a4b87-113">浏览器和设备的检测</span><span class="sxs-lookup"><span data-stu-id="a4b87-113">Browser and device detection</span></span>
- <span data-ttu-id="a4b87-114">ASP.NET Web 窗体应用程序可以如何提供移动特定页</span><span class="sxs-lookup"><span data-stu-id="a4b87-114">How ASP.NET Web Forms applications can present mobile-specific pages</span></span>
- <span data-ttu-id="a4b87-115">ASP.NET MVC 应用程序可以如何提供移动特定页</span><span class="sxs-lookup"><span data-stu-id="a4b87-115">How ASP.NET MVC applications can present mobile-specific pages</span></span>
- <span data-ttu-id="a4b87-116">其他资源</span><span class="sxs-lookup"><span data-stu-id="a4b87-116">Additional resources</span></span>

<span data-ttu-id="a4b87-117">有关 ASP.NET Web 窗体和 MVC 演示这份白皮书的技术的可下载代码示例，请参阅[移动应用和使用 ASP.NET 站点](https://docs.microsoft.com/aspnet/mobile/overview)。</span><span class="sxs-lookup"><span data-stu-id="a4b87-117">For downloadable code samples demonstrating this white paper's techniques for both ASP.NET Web Forms and MVC, see [Mobile Apps & Sites with ASP.NET](https://docs.microsoft.com/aspnet/mobile/overview).</span></span>

## <a name="overview"></a><span data-ttu-id="a4b87-118">概述</span><span class="sxs-lookup"><span data-stu-id="a4b87-118">Overview</span></span>

<span data-ttu-id="a4b87-119">移动设备 – 智能手机、 功能手机和平板电脑 – 不断增大受欢迎程度作为一种方法访问 Web。</span><span class="sxs-lookup"><span data-stu-id="a4b87-119">Mobile devices – smartphones, feature phones, and tablets – continue to grow in popularity as a means to access the Web.</span></span> <span data-ttu-id="a4b87-120">对于许多 web 开发人员和面向 web 的企业，这意味着越来越，务必为访客使用这些设备提供了很好的浏览体验。</span><span class="sxs-lookup"><span data-stu-id="a4b87-120">For many web developers and web-oriented businesses, this means it's increasingly important to provide a great browsing experience for visitors using those devices.</span></span>

### <a name="how-earlier-versions-of-aspnet-supported-mobile-browsers"></a><span data-ttu-id="a4b87-121">如何早期版本的 ASP.NET 支持移动浏览器</span><span class="sxs-lookup"><span data-stu-id="a4b87-121">How earlier versions of ASP.NET supported mobile browsers</span></span>

<span data-ttu-id="a4b87-122">ASP.NET 版本 2.0 到 3.5 包含*ASP.NET 移动控件*： 一组中的移动设备的服务器控件*System.Web.Mobile.dll*程序集和*System.Web.UI.MobileControls*命名空间。</span><span class="sxs-lookup"><span data-stu-id="a4b87-122">ASP.NET versions 2.0 to 3.5 included *ASP.NET Mobile Controls*: a set of server controls for mobile devices in the *System.Web.Mobile.dll* assembly and the *System.Web.UI.MobileControls* namespace.</span></span> <span data-ttu-id="a4b87-123">程序集仍包含在 ASP.NET 4 中，但它已弃用。</span><span class="sxs-lookup"><span data-stu-id="a4b87-123">The assembly is still included in ASP.NET 4, but it is deprecated.</span></span> <span data-ttu-id="a4b87-124">开发人员建议将迁移到更现代的方法，如本白皮书中的描述。</span><span class="sxs-lookup"><span data-stu-id="a4b87-124">Developers are advised to migrate to more modern approaches, such as those described in this paper.</span></span>

<span data-ttu-id="a4b87-125">ASP.NET 移动控件为什么已标记为过时的原因是它们的设计面向盛行围绕 2005年和更早版本的手机。</span><span class="sxs-lookup"><span data-stu-id="a4b87-125">The reason why ASP.NET Mobile Controls have been marked as obsolete is that their design is oriented around the mobile phones that were common around 2005 and earlier.</span></span> <span data-ttu-id="a4b87-126">控件被主要设计用于呈现 WML 或 cHTML 标记 （而不是正则 HTML) 为该纪元的 WAP 浏览器。</span><span class="sxs-lookup"><span data-stu-id="a4b87-126">The controls are mainly designed to render WML or cHTML markup (instead of regular HTML) for the WAP browsers of that era.</span></span> <span data-ttu-id="a4b87-127">但 WAP、 WML 和 cHTML 不再适用于大多数项目，因为 HTML 现在变得无处不在标记语言中的移动和桌面浏览器相似。</span><span class="sxs-lookup"><span data-stu-id="a4b87-127">But WAP, WML, and cHTML are no longer relevant for most projects, because HTML has now become the ubiquitous markup language for mobile and desktop browsers alike.</span></span>

### <a name="the-challenges-of-supporting-mobile-devices-today"></a><span data-ttu-id="a4b87-128">目前支持移动设备的面临的挑战</span><span class="sxs-lookup"><span data-stu-id="a4b87-128">The challenges of supporting mobile devices today</span></span>

<span data-ttu-id="a4b87-129">即使移动浏览器现在几乎普遍支持 HTML，仍将面临着许多挑战，旨在创建极佳移动浏览体验时：</span><span class="sxs-lookup"><span data-stu-id="a4b87-129">Even though mobile browsers now almost universally support HTML, you will still face many challenges when aiming to create great mobile browsing experiences:</span></span>

- <span data-ttu-id="a4b87-130">***屏幕大小***-在表单中，极大地改变的移动设备，并且其屏幕通常有很多小于桌面监视器。</span><span class="sxs-lookup"><span data-stu-id="a4b87-130">***Screen size*** - Mobile devices vary dramatically in form, and their screens are often much smaller than desktop monitors.</span></span> <span data-ttu-id="a4b87-131">因此，你可能需要为其设计完全不同的页面布局。</span><span class="sxs-lookup"><span data-stu-id="a4b87-131">So, you may need to design completely different page layouts for them.</span></span>
- <span data-ttu-id="a4b87-132">***输入方法***– 某些设备具有键盘、 一些具有 styluses、 其他人使用触摸屏输入。</span><span class="sxs-lookup"><span data-stu-id="a4b87-132">***Input methods*** – Some devices have keypads, some have styluses, others use touch.</span></span> <span data-ttu-id="a4b87-133">你可能需要考虑多个导航机制和数据的输入的方法。</span><span class="sxs-lookup"><span data-stu-id="a4b87-133">You may need to consider multiple navigation mechanisms and data input methods.</span></span>
- <span data-ttu-id="a4b87-134">***你遵从标准***– 许多移动浏览器不支持的最新的 HTML、 CSS 或 JavaScript 标准。</span><span class="sxs-lookup"><span data-stu-id="a4b87-134">***Standards compliance*** – Many mobile browsers do not support the latest HTML, CSS, or JavaScript standards.</span></span>
- <span data-ttu-id="a4b87-135">***带宽***– 移动电话网络数据网络性能会发生变化巨大，和一些最终用户是对关税收费兆字节。</span><span class="sxs-lookup"><span data-stu-id="a4b87-135">***Bandwidth*** – Cellular data network performance varies wildly, and some end users are on tariffs that charge by the megabyte.</span></span>

<span data-ttu-id="a4b87-136">没有任何通用型解决方案;你的应用程序将需要的外观和行为以不同的方式根据访问它的设备。</span><span class="sxs-lookup"><span data-stu-id="a4b87-136">There's no one-size-fits-all solution; your application will have to look and behave differently according to the device accessing it.</span></span> <span data-ttu-id="a4b87-137">具体取决于你想何种级别的移动，这可能是支持的为 web 开发人员比以往桌面"浏览器大战"一个更大难题。</span><span class="sxs-lookup"><span data-stu-id="a4b87-137">Depending on what level of mobile support you want, this can be a bigger challenge for web developers than the desktop "browser wars" ever was.</span></span>

<span data-ttu-id="a4b87-138">通常最初接近的第一次移动浏览器支持的开发人员认为它是仅重要支持最新且最复杂的智能手机 （例如，Windows Phone 7、 iPhone 或 Android），可能是因为开发人员通常个人拥有此类设备。</span><span class="sxs-lookup"><span data-stu-id="a4b87-138">Developers approaching mobile browser support for the first time often initially think it's only important to support the latest and most sophisticated smartphones (e.g., Windows Phone 7, iPhone, or Android), perhaps because developers often personally own such devices.</span></span> <span data-ttu-id="a4b87-139">但是，更便宜手机仍然非常受欢迎，而且其所有者并使用它们来浏览网页-尤其是在移动电话是更轻松地获得比宽带连接的国家/地区。</span><span class="sxs-lookup"><span data-stu-id="a4b87-139">However, cheaper phones are still extremely popular, and their owners do use them to browse the web – especially in countries where mobile phones are easier to get than a broadband connection.</span></span> <span data-ttu-id="a4b87-140">你的业务需要决定哪个范围的设备，以支持通过考虑其可能的客户。</span><span class="sxs-lookup"><span data-stu-id="a4b87-140">Your business will need to decide what range of devices to support by considering its likely customers.</span></span> <span data-ttu-id="a4b87-141">如果你正在生成 luxury 运行状况 spa 在线小册子，可能实现的业务决定仅面向高级智能手机，而如果你要创建影院票证预订系统，你可能需要考虑为访客使用较不强大的功能手机。</span><span class="sxs-lookup"><span data-stu-id="a4b87-141">If you're building an online brochure for a luxury health spa, you might make a business decision only to target advanced smartphones, whereas if you're creating a ticket booking system for a cinema, you probably need to account for visitors with less powerful feature phones.</span></span>

## <a name="architectural-options"></a><span data-ttu-id="a4b87-142">体系结构选项</span><span class="sxs-lookup"><span data-stu-id="a4b87-142">Architectural options</span></span>

<span data-ttu-id="a4b87-143">我们获取的 ASP.NET Web 窗体或 MVC 的特定技术详细信息之前，请注意 web 开发人员通常有三个主要的可能选项，用于支持移动浏览器：</span><span class="sxs-lookup"><span data-stu-id="a4b87-143">Before we get to the specific technical details of ASP.NET Web Forms or MVC, note that web developers in general have three main possible options for supporting mobile browsers:</span></span>

1. <span data-ttu-id="a4b87-144">***不执行任何操作 –***你只需创建标准的、 面向桌面的 web 应用程序，并依赖于移动浏览器是可以接受呈现。</span><span class="sxs-lookup"><span data-stu-id="a4b87-144">***Do nothing –*** You can simply create a standard, desktop-oriented web application, and rely on mobile browsers to render it acceptably.</span></span> 

    - <span data-ttu-id="a4b87-145">**利用**： 它是最便宜的选择实现并维护 – 不额外的工作</span><span class="sxs-lookup"><span data-stu-id="a4b87-145">**Advantage**: It's the cheapest option to implement and maintain – no extra work</span></span>
    - <span data-ttu-id="a4b87-146">**缺点**： 提供的最差的最终用户体验：</span><span class="sxs-lookup"><span data-stu-id="a4b87-146">**Disadvantage**: Gives the worst end-user experience:</span></span> 

        - <span data-ttu-id="a4b87-147">最新的智能手机作为桌面浏览器中，同样可能会导致你 HTML 但来缩放和滚动水平和垂直来使用你在小屏幕上的内容，仍会强制用户。</span><span class="sxs-lookup"><span data-stu-id="a4b87-147">The latest smartphones may render your HTML just as well as a desktop browser, but users will still be forced to zoom and scroll horizontally and vertically to consume your content on a small screen.</span></span> <span data-ttu-id="a4b87-148">这是远离最佳。</span><span class="sxs-lookup"><span data-stu-id="a4b87-148">This is far from optimal.</span></span>
        - <span data-ttu-id="a4b87-149">较旧的设备和功能手机可能无法令人满意的方式呈现你的标记。</span><span class="sxs-lookup"><span data-stu-id="a4b87-149">Older devices and feature phones may fail to render your markup in a satisfactory way.</span></span>
        - <span data-ttu-id="a4b87-150">即使在最新的平板电脑设备 （其屏幕可以是便携式计算机屏幕一样大），不同的交互规则适用。</span><span class="sxs-lookup"><span data-stu-id="a4b87-150">Even on the latest tablet devices (whose screens can be as big as laptop screens), different interaction rules apply.</span></span> <span data-ttu-id="a4b87-151">触摸基于输入最适用于较大的按钮和链接 spread 进一步分离，并且没有没有办法将鼠标光标鼠标悬停在弹出菜单。</span><span class="sxs-lookup"><span data-stu-id="a4b87-151">Touch-based input works best with larger buttons and links spread further apart, and there's no way to hover a mouse cursor over a fly-out menu.</span></span>
2. <span data-ttu-id="a4b87-152">***解决客户端上的问题*–**与小心使用 CSS 和[渐进增强](http://en.wikipedia.org/wiki/Progressive_enhancement)标记、 样式和适应任何浏览器运行这些脚本可以创建。</span><span class="sxs-lookup"><span data-stu-id="a4b87-152">***Solve the problem on the client* –** With careful use of CSS and [progressive enhancement](http://en.wikipedia.org/wiki/Progressive_enhancement) you can create markup, styles, and scripts that adapt to whatever browser is running them.</span></span> <span data-ttu-id="a4b87-153">例如，对于[CSS 3 媒体查询](http://www.w3.org/TR/2010/CR-css3-mediaqueries-20100727/)，你可以创建在屏幕的比的所选阈值窄的设备将变为单个列布局的多列布局。</span><span class="sxs-lookup"><span data-stu-id="a4b87-153">For example, with [CSS 3 media queries](http://www.w3.org/TR/2010/CR-css3-mediaqueries-20100727/), you could create a multi-column layout that turns into a single column layout on devices whose screens are narrower than a chosen threshold.</span></span> 

    - <span data-ttu-id="a4b87-154">**利用**： 优化使用，即使对于根据它们具有所需的屏幕，输入的特征的未知未来设备中的特定设备的呈现</span><span class="sxs-lookup"><span data-stu-id="a4b87-154">**Advantage**: Optimizes rendering for the specific device in use, even for unknown future devices according to whatever screen and input characteristics they have</span></span>
    - <span data-ttu-id="a4b87-155">**利用**： 你在所有设备类型 – 最小重复代码或工作量之间共享服务器端逻辑，可以轻松</span><span class="sxs-lookup"><span data-stu-id="a4b87-155">**Advantage**: Easily lets you share server-side logic across all device types – minimal duplication of code or effort</span></span>
    - <span data-ttu-id="a4b87-156">**缺点**： 移动设备是因此不同于桌面版设备，你可能确实要移动页面是完全不同于桌面页面，其中显示了不同的信息。</span><span class="sxs-lookup"><span data-stu-id="a4b87-156">**Disadvantage**: Mobile devices are so different from desktop devices that you may really want your mobile pages to be completely different from your desktop pages, showing different information.</span></span> <span data-ttu-id="a4b87-157">此类变体可能效率很低或不可能实现能够可靠地通过 CSS 单独出现时，尤其要考虑如何不一致旧设备解释 CSS 规则。</span><span class="sxs-lookup"><span data-stu-id="a4b87-157">Such variations can be inefficient or impossible to achieve robustly through CSS alone, especially considering how inconsistently older devices interpret CSS rules.</span></span> <span data-ttu-id="a4b87-158">这是 CSS 3 特性的尤其如此。</span><span class="sxs-lookup"><span data-stu-id="a4b87-158">This is particularly true of CSS 3 attributes.</span></span>
    - <span data-ttu-id="a4b87-159">**缺点**： 未提供对不同的服务器端逻辑和适用于不同设备的工作流支持。</span><span class="sxs-lookup"><span data-stu-id="a4b87-159">**Disadvantage**: Provides no support for varying server-side logic and workflows for different devices.</span></span> <span data-ttu-id="a4b87-160">例如，不能通过 CSS 单独实现的简化购物车签出工作流为移动用户。</span><span class="sxs-lookup"><span data-stu-id="a4b87-160">You can't, for example, implement a simplified shopping cart checkout workflow for mobile users by means of CSS alone.</span></span>
    - <span data-ttu-id="a4b87-161">**缺点**： 效率不高的带宽使用。</span><span class="sxs-lookup"><span data-stu-id="a4b87-161">**Disadvantage**: Inefficient bandwidth use.</span></span> <span data-ttu-id="a4b87-162">你的服务器可能需要传输的标记和样式的适用于所有可能的设备，即使目标设备将仅使用该信息的子集。</span><span class="sxs-lookup"><span data-stu-id="a4b87-162">You server may have to transmit the markup and styles that apply to all possible devices, even though the target device will only use a subset of that information.</span></span>
3. <span data-ttu-id="a4b87-163">***解决此问题在服务器上的*–**如果你的服务器知道哪些设备正在访问它 – 或在该设备，例如其屏幕大小和输入的方法的最小的特征和移动设备 – 是否它可以运行不同的逻辑和输出不同的 HTML 标记。</span><span class="sxs-lookup"><span data-stu-id="a4b87-163">***Solve the problem on the server* –** If your server knows what device is accessing it – or at least the characteristics of that device, such as its screen size and input method, and whether it's a mobile device – it can run different logic and output different HTML markup.</span></span> 

    - <span data-ttu-id="a4b87-164">**优点：**最大灵活性。</span><span class="sxs-lookup"><span data-stu-id="a4b87-164">**Advantage:** Maximum flexibility.</span></span> <span data-ttu-id="a4b87-165">没有任何限制到多少可以优化你的标记中的所需的、 特定于设备的布局或你的服务器端逻辑的移动而有所不同。</span><span class="sxs-lookup"><span data-stu-id="a4b87-165">There's no limit to how much you can vary your server-side logic for mobiles or optimize your markup for the desired, device-specific layout.</span></span>
    - <span data-ttu-id="a4b87-166">**优点：**高效带宽使用。</span><span class="sxs-lookup"><span data-stu-id="a4b87-166">**Advantage:** Efficient bandwidth use.</span></span> <span data-ttu-id="a4b87-167">只需将标记和目标设备要使用的样式信息传输。</span><span class="sxs-lookup"><span data-stu-id="a4b87-167">You only need to transmit the markup and styling information that the target device is going to use.</span></span>
    - <span data-ttu-id="a4b87-168">**缺点：**有时强制工作量或代码的重复 （例如，使你创建的 Web 窗体页或 MVC 视图的类似但略有不同的副本项）。</span><span class="sxs-lookup"><span data-stu-id="a4b87-168">**Disadvantage:** Sometimes forces repetition of effort or code (e.g., making you create similar but slightly different copies of your Web Forms pages or MVC views).</span></span> <span data-ttu-id="a4b87-169">其中可能将抽取常见逻辑到基础层或服务，但仍，你的 UI 代码或标记的某些部分可能需要复制，然后在并行中维护。</span><span class="sxs-lookup"><span data-stu-id="a4b87-169">Where possible you will factor out common logic into an underlying layer or service, but still, some parts of your UI code or markup may have to be duplicated and then maintained in parallel.</span></span>
    - <span data-ttu-id="a4b87-170">**缺点：**设备检测并不繁琐。</span><span class="sxs-lookup"><span data-stu-id="a4b87-170">**Disadvantage:** Device detection is not trivial.</span></span> <span data-ttu-id="a4b87-171">它要求的列表或已知的设备类型和其特征 （这并非始终在完全保持最新） 的数据库，并且并不能保证准确匹配每个传入请求。</span><span class="sxs-lookup"><span data-stu-id="a4b87-171">It requires a list or database of known device types and their characteristics (which may not always be perfectly up-to-date) and isn't guaranteed to accurately match every incoming request.</span></span> <span data-ttu-id="a4b87-172">本文档介绍某些选项，并且其缺陷更高版本。</span><span class="sxs-lookup"><span data-stu-id="a4b87-172">This document describes some options and their pitfalls later.</span></span>

<span data-ttu-id="a4b87-173">若要获得最佳结果，大多数开发人员查找他们需要合并选项 (2) 和 (3)。</span><span class="sxs-lookup"><span data-stu-id="a4b87-173">To get the best results, most developers find they need to combine options (2) and (3).</span></span> <span data-ttu-id="a4b87-174">使用 CSS 或甚至 JavaScript 客户端上最容纳样式存在细微差异，而数据、 工作流或标记中的主要区别最有效地在服务器端代码中实现。</span><span class="sxs-lookup"><span data-stu-id="a4b87-174">Minor stylistic differences are best accommodated on the client using CSS or even JavaScript, whereas major differences in data, workflow, or markup are most effectively implemented in server-side code.</span></span>

### <a name="this-paper-focuses-on-server-side-techniques"></a><span data-ttu-id="a4b87-175">本白皮书重点介绍服务器端技术</span><span class="sxs-lookup"><span data-stu-id="a4b87-175">This paper focuses on server-side techniques</span></span>

<span data-ttu-id="a4b87-176">因为 ASP.NET Web 窗体和 MVC 是这两种主要的服务器端技术，本白皮书将重点服务器端技巧，以帮助你制作不同标记和移动浏览器的逻辑。</span><span class="sxs-lookup"><span data-stu-id="a4b87-176">Since ASP.NET Web Forms and MVC are both primarily server-side technologies, this white paper will focus on server-side techniques that let you produce different markup and logic for mobile browsers.</span></span> <span data-ttu-id="a4b87-177">当然，还可以将此合并使用任何客户端技术 （例如，CSS 3 媒体查询，渐进式增强功能 JavaScript），但这是更一种 web 设计比 ASP.NET 开发。</span><span class="sxs-lookup"><span data-stu-id="a4b87-177">Of course, you can also combine this with any client-side technique (e.g., CSS 3 media queries, progressive-enhancement JavaScript), but that's more a matter of web design than ASP.NET development.</span></span>

## <a name="browser-and-device-detection"></a><span data-ttu-id="a4b87-178">浏览器和设备的检测</span><span class="sxs-lookup"><span data-stu-id="a4b87-178">Browser and device detection</span></span>

<span data-ttu-id="a4b87-179">有关为支持移动设备的所有服务器端方法的密钥先决条件是要了解你的访问者正在使用何种设备。</span><span class="sxs-lookup"><span data-stu-id="a4b87-179">The key prerequisite for all server-side techniques for supporting mobile devices is to know what device your visitor is using.</span></span> <span data-ttu-id="a4b87-180">实际上，甚至更好了解知道该设备的制造商和型号数*特征*的设备。</span><span class="sxs-lookup"><span data-stu-id="a4b87-180">In fact, even better than knowing the manufacturer and model number of that device is knowing the *characteristics* of the device.</span></span> <span data-ttu-id="a4b87-181">特征可能包括：</span><span class="sxs-lookup"><span data-stu-id="a4b87-181">Characteristics may include:</span></span>

- <span data-ttu-id="a4b87-182">是移动设备？</span><span class="sxs-lookup"><span data-stu-id="a4b87-182">Is it a mobile device?</span></span>
- <span data-ttu-id="a4b87-183">输入的法 （鼠标/键盘、 触摸、 键盘、 游戏杆，...）</span><span class="sxs-lookup"><span data-stu-id="a4b87-183">Input method (mouse/keyboard, touch, keypad, joystick, …)</span></span>
- <span data-ttu-id="a4b87-184">屏幕大小 （以物理方式和以像素为单位）</span><span class="sxs-lookup"><span data-stu-id="a4b87-184">Screen size (physically and in pixels)</span></span>
- <span data-ttu-id="a4b87-185">支持的介质和数据格式</span><span class="sxs-lookup"><span data-stu-id="a4b87-185">Supported media and data formats</span></span>
- <span data-ttu-id="a4b87-186">Etc.</span><span class="sxs-lookup"><span data-stu-id="a4b87-186">Etc.</span></span>

<span data-ttu-id="a4b87-187">它是更好的做法因为做出决策基于特征与型号，然后您将能够更好地处理的未来设备。</span><span class="sxs-lookup"><span data-stu-id="a4b87-187">It's better to make decisions based on characteristics than model number, because then you'll be better equipped to handle future devices.</span></span>

### <a name="using-aspnets-built-in-browser-detection-support"></a><span data-ttu-id="a4b87-188">使用 ASP。NET 的内置浏览器检测支持</span><span class="sxs-lookup"><span data-stu-id="a4b87-188">Using ASP.NET's built-in browser detection support</span></span>

<span data-ttu-id="a4b87-189">ASP.NET Web 窗体和 MVC 的开发人员可以立即发现正在访问的浏览器的重要特征，通过检查属性*Request.Browser*对象。</span><span class="sxs-lookup"><span data-stu-id="a4b87-189">ASP.NET Web Forms and MVC developers can immediately discover important characteristics of a visiting browser by inspecting properties of the *Request.Browser* object.</span></span> <span data-ttu-id="a4b87-190">有关示例，请参阅</span><span class="sxs-lookup"><span data-stu-id="a4b87-190">For example, see</span></span>

- <span data-ttu-id="a4b87-191">Request.Browser.IsMobileDevice</span><span class="sxs-lookup"><span data-stu-id="a4b87-191">Request.Browser.IsMobileDevice</span></span>
- <span data-ttu-id="a4b87-192">Request.Browser.MobileDeviceManufacturer, Request.Browser.MobileDeviceModel</span><span class="sxs-lookup"><span data-stu-id="a4b87-192">Request.Browser.MobileDeviceManufacturer, Request.Browser.MobileDeviceModel</span></span>
- <span data-ttu-id="a4b87-193">Request.Browser.ScreenPixelsWidth</span><span class="sxs-lookup"><span data-stu-id="a4b87-193">Request.Browser.ScreenPixelsWidth</span></span>
- <span data-ttu-id="a4b87-194">Request.Browser.SupportsXmlHttp</span><span class="sxs-lookup"><span data-stu-id="a4b87-194">Request.Browser.SupportsXmlHttp</span></span>
- <span data-ttu-id="a4b87-195">...以及许多其他</span><span class="sxs-lookup"><span data-stu-id="a4b87-195">…and many others</span></span>

<span data-ttu-id="a4b87-196">在后台，ASP.NET 平台之一匹配传入*用户代理*针对一组浏览器定义 XML 文件中的正则表达式 (UA) HTTP 标头。</span><span class="sxs-lookup"><span data-stu-id="a4b87-196">Behind the scenes, the ASP.NET platform matches the incoming *User-Agent* (UA) HTTP header against regular expressions in a set of Browser Definition XML files.</span></span> <span data-ttu-id="a4b87-197">默认情况下该平台包括很多常见的移动设备的定义，你可以为其他你想要识别添加自定义浏览器定义文件。</span><span class="sxs-lookup"><span data-stu-id="a4b87-197">By default the platform includes definitions for many common mobile devices, and you can add custom Browser Definition files for others you wish to recognize.</span></span> <span data-ttu-id="a4b87-198">有关更多详细信息，请参阅 MSDN 页面[ASP.NET Web 服务器控件和浏览器功能](https://msdn.microsoft.com/library/x3k2ssx2.aspx)。</span><span class="sxs-lookup"><span data-stu-id="a4b87-198">For more details, see the MSDN page [ASP.NET Web Server Controls and Browser Capabilities](https://msdn.microsoft.com/library/x3k2ssx2.aspx).</span></span>

### <a name="using-the-wurfl-device-database-via-51degreesmobi-foundation"></a><span data-ttu-id="a4b87-199">使用通过 51Degrees.mobi Foundation WURFL 设备数据库</span><span class="sxs-lookup"><span data-stu-id="a4b87-199">Using the WURFL device database via 51Degrees.mobi Foundation</span></span>

<span data-ttu-id="a4b87-200">尽管 ASP。NET 的内置浏览器检测支持将足以满足许多应用程序，有两种主要的情况下它可能无法满足：</span><span class="sxs-lookup"><span data-stu-id="a4b87-200">While ASP.NET's built-in browser detection support will be sufficient for many applications, there are two main cases when it might not be enough:</span></span>

- <span data-ttu-id="a4b87-201">***你想要识别最新的设备***（无需手动为其创建浏览器定义文件）。</span><span class="sxs-lookup"><span data-stu-id="a4b87-201">***You want to recognize the latest devices***(without manually creating Browser Definition files for them).</span></span> <span data-ttu-id="a4b87-202">请注意，.NET 4 的浏览器定义文件不不够新，无法识别 Windows Phone 7、 Android 手机、 Opera Mobile 浏览器或 Apple Ipad。</span><span class="sxs-lookup"><span data-stu-id="a4b87-202">Note that .NET 4's Browser Definition files are not recent enough to recognize Windows Phone 7, Android phones, Opera Mobile browsers, or Apple iPads.</span></span>
- <span data-ttu-id="a4b87-203">***你需要有关设备功能的更多详细的信息***。</span><span class="sxs-lookup"><span data-stu-id="a4b87-203">***You need more detailed information about device capabilities***.</span></span> <span data-ttu-id="a4b87-204">你可能需要了解的有关设备的输入方法 （例如，触摸 vs 键盘），或哪些音频格式浏览器支持。</span><span class="sxs-lookup"><span data-stu-id="a4b87-204">You may need to know about a device's input method (e.g., touch vs keypad), or what audio formats the browser supports.</span></span> <span data-ttu-id="a4b87-205">在标准的浏览器定义文件中，此信息不可用。</span><span class="sxs-lookup"><span data-stu-id="a4b87-205">This information isn't available in the standard Browser Definition files.</span></span>

<span data-ttu-id="a4b87-206">[*无线通用资源文件*(WURFL) 项目](http://wurfl.sourceforge.net/)维护更多最新信息和详细信息中使用的移动设备有关今天。</span><span class="sxs-lookup"><span data-stu-id="a4b87-206">The [*Wireless Universal Resource File* (WURFL) project](http://wurfl.sourceforge.net/) maintains much more up-to-date and detailed information about mobile devices in use today.</span></span>

<span data-ttu-id="a4b87-207">为.NET 开发人员令人欣慰是该 ASP。NET 的浏览器检测功能是可扩展的，因此可以对它若要解决这些问题进行增强。</span><span class="sxs-lookup"><span data-stu-id="a4b87-207">The great news for .NET developers is that ASP.NET's browser detection feature is extensible, so it's possible to enhance it to overcome these problems.</span></span> <span data-ttu-id="a4b87-208">例如，你可以添加开放源代码[ *51Degrees.mobi Foundation* ](https://github.com/51Degrees/dotNET-Device-Detection)到你的项目的库。</span><span class="sxs-lookup"><span data-stu-id="a4b87-208">For example, you can add the open source [*51Degrees.mobi Foundation*](https://github.com/51Degrees/dotNET-Device-Detection) library to your project.</span></span> <span data-ttu-id="a4b87-209">它是一个 ASP.NET IHttpModule 或浏览器功能提供程序 （Web 窗体和 MVC 应用程序可用），直接读取 WURFL 数据并将其挂钩到 ASP。NET 的内置浏览器检测机制。</span><span class="sxs-lookup"><span data-stu-id="a4b87-209">It's an ASP.NET IHttpModule or Browser Capabilities Provider (usable on both Web Forms and MVC applications), that directly reads WURFL data and hooks it into ASP.NET's built-in browser detection mechanism.</span></span> <span data-ttu-id="a4b87-210">一旦你已安装模块， *Request.Browser*突然将包含大量更准确的详细信息： 它将正确识别很多前面提到的设备，并列出其功能 （包括其他功能，例如输入法）。</span><span class="sxs-lookup"><span data-stu-id="a4b87-210">Once you've installed the module, *Request.Browser* will suddenly contain a lot more accurate and detailed information: it will correctly recognize many of the devices previously mentioned and list their capabilities (including additional capabilities such as input method).</span></span> <span data-ttu-id="a4b87-211">请参阅更多详细信息的项目的文档。</span><span class="sxs-lookup"><span data-stu-id="a4b87-211">See the project's documentation for more details.</span></span>

## <a name="how-web-forms-applications-can-present-mobile-specific-pages"></a><span data-ttu-id="a4b87-212">Web 窗体应用程序可以如何提供移动特定页</span><span class="sxs-lookup"><span data-stu-id="a4b87-212">How Web Forms applications can present mobile-specific pages</span></span>

<span data-ttu-id="a4b87-213">默认情况下，下面是一个全新的 Web 窗体应用程序在常见的移动设备上的显示方式：</span><span class="sxs-lookup"><span data-stu-id="a4b87-213">By default, here's how a brand new Web Forms application displays on common mobile devices:</span></span>

![](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/_static/image1.png)

<span data-ttu-id="a4b87-214">显然，既不布局看上去非常适合移动应用 – 此页旨在用于大型、 面向布局的监视器，不能为小面向纵向的屏幕。</span><span class="sxs-lookup"><span data-stu-id="a4b87-214">Clearly, neither layout looks very mobile-friendly – this page was designed for a large, landscape-oriented monitor, not for a small portrait-oriented screen.</span></span> <span data-ttu-id="a4b87-215">因此你可以做什么信息？</span><span class="sxs-lookup"><span data-stu-id="a4b87-215">So what can you do about it?</span></span>

<span data-ttu-id="a4b87-216">如之前在本白皮书中所述，有多种方法来定制移动设备的页面。</span><span class="sxs-lookup"><span data-stu-id="a4b87-216">As discussed earlier in this paper, there are many ways to tailor your pages for mobile devices.</span></span> <span data-ttu-id="a4b87-217">一些技术都是基于服务器的其他人在客户端上运行。</span><span class="sxs-lookup"><span data-stu-id="a4b87-217">Some techniques are server-based, others run on the client.</span></span>

### <a name="creating-a-mobile-specific-master-page"></a><span data-ttu-id="a4b87-218">创建移动特定的母版页</span><span class="sxs-lookup"><span data-stu-id="a4b87-218">Creating a mobile-specific master page</span></span>

<span data-ttu-id="a4b87-219">根据你的要求，你可能能够使用相同的 Web 窗体的所有访问者，但具有两个单独的主控页： 一个用于桌面的访问者，另一个为移动的访客。</span><span class="sxs-lookup"><span data-stu-id="a4b87-219">Depending on your requirements, you may be able to use the same Web Forms for all visitors, but have two separate master pages: one for desktop visitors, another for mobile visitors.</span></span> <span data-ttu-id="a4b87-220">这允许你灵活地更改 CSS 样式表或你顶级的 HTML 标记，以满足而不强制你要复制的任何页逻辑的移动设备。</span><span class="sxs-lookup"><span data-stu-id="a4b87-220">This gives you the flexibility of changing the CSS stylesheet or your top-level HTML markup to suit mobile devices, without forcing you to duplicate any page logic.</span></span>

<span data-ttu-id="a4b87-221">这是很简单的操作。</span><span class="sxs-lookup"><span data-stu-id="a4b87-221">This is easy to do.</span></span> <span data-ttu-id="a4b87-222">例如，你可以将如下所示的 PreInit 处理添加到 Web 窗体：</span><span class="sxs-lookup"><span data-stu-id="a4b87-222">For example, you can add a PreInit handler such as the following to a Web Form:</span></span>

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample1.cs)]

<span data-ttu-id="a4b87-223">现在，创建母版页调用 Mobile.Master 顶级文件夹中的应用程序，并检测到移动设备时，将使用它。</span><span class="sxs-lookup"><span data-stu-id="a4b87-223">Now, create a master page called Mobile.Master in the top-level folder of your application, and it will be used when a mobile device is detected.</span></span> <span data-ttu-id="a4b87-224">如有必要，移动母版页可以引用特定于移动的 CSS 样式表。</span><span class="sxs-lookup"><span data-stu-id="a4b87-224">Your mobile master page can reference a mobile-specific CSS stylesheet if necessary.</span></span> <span data-ttu-id="a4b87-225">桌面的访问者将看到你默认主页面上，不是移动答案。</span><span class="sxs-lookup"><span data-stu-id="a4b87-225">Desktop visitors will still see your default master page, not the mobile one.</span></span>

### <a name="creating-independent-mobile-specific-web-forms"></a><span data-ttu-id="a4b87-226">创建独立移动特定 Web 窗体</span><span class="sxs-lookup"><span data-stu-id="a4b87-226">Creating independent mobile-specific Web Forms</span></span>

<span data-ttu-id="a4b87-227">最大的灵活性，你可以更进一步比单纯单独的主控页，针对不同设备类型。</span><span class="sxs-lookup"><span data-stu-id="a4b87-227">For maximum flexibility, you can go much further than just having separate master pages for different device types.</span></span> <span data-ttu-id="a4b87-228">你可以实现两个*完全分隔的 Web 窗体页面的集*– 一个为桌面浏览器设置，另一套用于移动。</span><span class="sxs-lookup"><span data-stu-id="a4b87-228">You can implement two *totally separate sets of Web Forms pages* – one set for desktop browsers, another set for mobiles.</span></span> <span data-ttu-id="a4b87-229">这最适用如果你想要移动的访问者向提供非常不同的信息或工作流。</span><span class="sxs-lookup"><span data-stu-id="a4b87-229">This works best if you want to present very different information or workflows to mobile visitors.</span></span> <span data-ttu-id="a4b87-230">本部分的其余部分介绍详细的这种方法。</span><span class="sxs-lookup"><span data-stu-id="a4b87-230">The rest of this section describes this approach in detail.</span></span>

<span data-ttu-id="a4b87-231">假设你已有设计用于桌面浏览器的 Web 窗体应用程序，旨在创建一个在项目中，称为"Mobile"子文件夹和生成移动页面存在的最简单的方法，以继续。</span><span class="sxs-lookup"><span data-stu-id="a4b87-231">Assuming you already have a Web Forms application designed for desktop browsers, the easiest way to proceed is to create a subfolder called "Mobile" within your project, and build your mobile pages there.</span></span> <span data-ttu-id="a4b87-232">您可以构造整个子站点，具有其自己的主控页、 样式表和页，使用的所有相同你将用于任何其他 Web 窗体应用程序的技术。</span><span class="sxs-lookup"><span data-stu-id="a4b87-232">You can construct an entire sub-site, with its own master pages, style sheets, and pages, using all the same techniques that you'd use for any other Web Forms application.</span></span> <span data-ttu-id="a4b87-233">你不一定需要生成移动等效*每个*桌面站点中的页上，你可以选择何种功能子集合理的移动访问者。</span><span class="sxs-lookup"><span data-stu-id="a4b87-233">You don't necessarily need to produce a mobile equivalent for *every* page in your desktop site; you can choose what subset of functionality makes sense for mobile visitors.</span></span>

<span data-ttu-id="a4b87-234">移动页面可以共享公共静态资源 (如图像、 JavaScript 或 CSS 文件) 与常规页面如果你想。</span><span class="sxs-lookup"><span data-stu-id="a4b87-234">Your mobile pages can share common static resources (such as images, JavaScript, or CSS files) with your regular pages if you wish.</span></span> <span data-ttu-id="a4b87-235">由于你"Mobile"的文件夹将*不*标记作为单独的应用程序时 （它是只需简单的子文件夹 Web 窗体页） 的 IIS 中承载它将也是共享所有相同配置、 会话数据和其他基础结构，即你桌面的页数。</span><span class="sxs-lookup"><span data-stu-id="a4b87-235">Since your "Mobile" folder will *not* be marked as a separate application when hosted in IIS (it's just a simple subfolder of Web Forms pages), it will also share all the same configuration, Session data, and other infrastructure as your desktop pages.</span></span>

> [!NOTE]
> <span data-ttu-id="a4b87-236">由于这种方法通常涉及一些重复代码 （移动页面有可能与桌面页共享一些相似之处），务必分解出任何常见业务逻辑或数据访问代码到共享的基础层或服务。</span><span class="sxs-lookup"><span data-stu-id="a4b87-236">Since this approach usually involves some duplication of code (mobile pages are likely to share some similarities with desktop pages), it's important to factor out any common business logic or data access code into a shared underlying layer or service.</span></span> <span data-ttu-id="a4b87-237">否则，你将双精度的创建和维护你的应用程序的工作量。</span><span class="sxs-lookup"><span data-stu-id="a4b87-237">Otherwise, you'll double the effort of creating and maintaining your application.</span></span>


#### <a name="redirecting-mobile-visitors-to-your-mobile-pages"></a><span data-ttu-id="a4b87-238">重定向到你移动页的移动访问者</span><span class="sxs-lookup"><span data-stu-id="a4b87-238">Redirecting mobile visitors to your mobile pages</span></span>

<span data-ttu-id="a4b87-239">通常很方便，若要仅在重定向到移动页的移动访问者*第一个*请求在其浏览会话中 （以及不在其会话中的每个请求），因为：</span><span class="sxs-lookup"><span data-stu-id="a4b87-239">It's often convenient to redirect mobile visitors to the mobile pages only on the *first* request in their browsing session (and not on every request in their session), because:</span></span>

- <span data-ttu-id="a4b87-240">然后，你可以轻松地允许移动访问者能够访问你的桌面页，根据自己的意愿 – 只需将链接放在你将转到"桌面版本"的主页面上。</span><span class="sxs-lookup"><span data-stu-id="a4b87-240">You can then easily allow mobile visitors to access your desktop pages if they wish – just put a link on your master page that goes to "Desktop version".</span></span> <span data-ttu-id="a4b87-241">在距访客不会重定向回移动页，因为它不再第一个请求在其会话。</span><span class="sxs-lookup"><span data-stu-id="a4b87-241">The visitor won't be redirected back to a mobile page, because it's no longer the first request in their session.</span></span>
- <span data-ttu-id="a4b87-242">它可以避免干扰对任何动态资源 （例如，如果你具有的你的站点的桌面和移动部件会显示在 IFRAME 中或某些 Ajax 处理程序的常见 Web 窗体） 的你的站点的桌面和移动部分之间共享的请求的风险</span><span class="sxs-lookup"><span data-stu-id="a4b87-242">It avoids the risk of interfering with requests for any dynamic resources shared between desktop and mobile parts of your site (e.g., if you have a common Web Form that both desktop and mobile parts of your site display in an IFRAME, or certain Ajax handlers)</span></span>

<span data-ttu-id="a4b87-243">若要执行此操作，可以将放在你重定向逻辑**会话\_启动**方法。</span><span class="sxs-lookup"><span data-stu-id="a4b87-243">To do this, you can place your redirection logic in a **Session\_Start** method.</span></span> <span data-ttu-id="a4b87-244">例如，将以下方法添加到 Global.asax.cs 文件：</span><span class="sxs-lookup"><span data-stu-id="a4b87-244">For example, add the following method to your Global.asax.cs file:</span></span>

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample2.cs)]

#### <a name="configuring-forms-authentication-to-respect-your-mobile-pages"></a><span data-ttu-id="a4b87-245">配置采用了移动页的 Forms 身份验证</span><span class="sxs-lookup"><span data-stu-id="a4b87-245">Configuring Forms Authentication to respect your mobile pages</span></span>

<span data-ttu-id="a4b87-246">请注意窗体身份验证使进行某些假设，它可以将重定向访客期间和之后的身份验证过程：</span><span class="sxs-lookup"><span data-stu-id="a4b87-246">Note that Forms Authentication makes certain assumptions about where it can redirect visitors during and after the authentication process:</span></span>

- <span data-ttu-id="a4b87-247">当用户需要进行身份验证时，窗体身份验证将他们重定向到您的桌面登录页，而不考虑它们是否是桌面或移动用户 (因为它仅有的概念*一个*登录 URL)。</span><span class="sxs-lookup"><span data-stu-id="a4b87-247">When a user needs to be authenticated, Forms Authentication will redirect them to your desktop login page, regardless of whether they're a desktop or mobile user (because it only has a concept of *one* login URL).</span></span> <span data-ttu-id="a4b87-248">假设你想要以不同方式样式对移动登录页，需要增强您的桌面登录页，以便将移动用户重定向到单独移动登录页。</span><span class="sxs-lookup"><span data-stu-id="a4b87-248">Assuming you want to style your mobile login page differently, you need to enhance your desktop login page so that it redirects mobile users to a separate mobile login page.</span></span> <span data-ttu-id="a4b87-249">例如，以下将代码添加到你**桌面**隐藏代码的登录页：</span><span class="sxs-lookup"><span data-stu-id="a4b87-249">For example, add the following code to your **desktop** login page code-behind:</span></span> 

    [!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample3.cs)]
- <span data-ttu-id="a4b87-250">用户成功登录后，窗体身份验证将默认情况下将它们重定向到桌面的主页 (因为它仅有的概念*一个*默认页)。</span><span class="sxs-lookup"><span data-stu-id="a4b87-250">After a user successfully logs in, Forms Authentication will by default redirect them to your desktop home page (because it only has a concept of *one* default page).</span></span> <span data-ttu-id="a4b87-251">你需要增强您的移动登录页，以便它将重定向到移动主页后成功日志中。</span><span class="sxs-lookup"><span data-stu-id="a4b87-251">You need to enhance your mobile login page so that it redirects to the mobile home page after a successful log-in.</span></span> <span data-ttu-id="a4b87-252">例如，以下将代码添加到你**移动**隐藏代码的登录页：</span><span class="sxs-lookup"><span data-stu-id="a4b87-252">For example, add the following code to your **mobile** login page code-behind:</span></span> 

    [!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample4.cs)]
  
 <span data-ttu-id="a4b87-253">此代码假定你的页面具有登录名的服务器控件调用 LoginUser，如下所示的默认项目模板。</span><span class="sxs-lookup"><span data-stu-id="a4b87-253">This code assumes your page has a Login server control called LoginUser, as in the default project template.</span></span>

### <a name="working-with-output-caching"></a><span data-ttu-id="a4b87-254">使用输出缓存</span><span class="sxs-lookup"><span data-stu-id="a4b87-254">Working with Output Caching</span></span>

<span data-ttu-id="a4b87-255">如果你使用的输出缓存，请注意，默认情况下，它是桌面的用户可以访问 （从而导致其输出缓存） 的某些 URL 后, 跟然后接收缓存的桌面输出移动用户。</span><span class="sxs-lookup"><span data-stu-id="a4b87-255">If you're using output caching, beware that by default it's possible for a desktop user to visit a certain URL (causing its output to be cached), followed by a mobile user who then receives the cached desktop output.</span></span> <span data-ttu-id="a4b87-256">你只是改变你母版页按设备类型，或者实现每个设备类型的完全独立 Web 窗体是否将应用此警告。</span><span class="sxs-lookup"><span data-stu-id="a4b87-256">This warning applies whether you're just varying your master page by device type, or implementing totally separate Web Forms per device type.</span></span>

<span data-ttu-id="a4b87-257">若要避免此问题，你可以指示 ASP.NET 改变根据访问者是否正在使用移动设备的缓存项。</span><span class="sxs-lookup"><span data-stu-id="a4b87-257">To avoid the problem, you can instruct ASP.NET to vary the cache entry according to whether the visitor is using a mobile device.</span></span> <span data-ttu-id="a4b87-258">将 VaryByCustom 参数添加到页面的 OutputCache 声明，如下所示：</span><span class="sxs-lookup"><span data-stu-id="a4b87-258">Add a VaryByCustom parameter to your page's OutputCache declaration as follows:</span></span>

[!code-aspx[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample5.aspx)]

<span data-ttu-id="a4b87-259">接下来，定义*isMobileDevice*作为自定义缓存通过添加以下方法的参数重写到 Global.asax.cs 文件：</span><span class="sxs-lookup"><span data-stu-id="a4b87-259">Next, define *isMobileDevice* as a custom cache parameter by adding the following method override to your Global.asax.cs file:</span></span>

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample6.cs)]

<span data-ttu-id="a4b87-260">这将确保移动到页的访问者没有收到以前通过桌面访问者放入缓存的输出。</span><span class="sxs-lookup"><span data-stu-id="a4b87-260">This will ensure that mobile visitors to the page don't receive output previously put into the cache by a desktop visitor.</span></span>

### <a name="a-working-example"></a><span data-ttu-id="a4b87-261">获得可运行示例</span><span class="sxs-lookup"><span data-stu-id="a4b87-261">A working example</span></span>

<span data-ttu-id="a4b87-262">若要查看这些技术在操作中的，下载[这份白皮书的代码示例](https://docs.microsoft.com/aspnet/mobile/overview)。</span><span class="sxs-lookup"><span data-stu-id="a4b87-262">To see these techniques in action, download [this white paper's code samples](https://docs.microsoft.com/aspnet/mobile/overview).</span></span> <span data-ttu-id="a4b87-263">Web 窗体示例应用程序自动重移动用户定向到一组称为移动的子文件夹中的移动特定页面。</span><span class="sxs-lookup"><span data-stu-id="a4b87-263">The Web Forms sample application automatically redirects mobile users to a set of mobile-specific pages in a subfolder called Mobile.</span></span> <span data-ttu-id="a4b87-264">可从以下屏幕截图中看到针对移动浏览器中，更好地优化的标记和这些页面的样式：</span><span class="sxs-lookup"><span data-stu-id="a4b87-264">The markup and styling of those pages is better optimized for mobile browsers, as you can see from the following screenshots:</span></span>

![](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/_static/image2.png)

<span data-ttu-id="a4b87-265">有关针对移动浏览器进行优化您的标记和 CSS 的更多技巧，请参阅"样式移动页的移动浏览器"在本文档后面的部分。</span><span class="sxs-lookup"><span data-stu-id="a4b87-265">For more tips about optimizing your markup and CSS for mobile browsers, see the section "Styling mobile pages for mobile browsers" later in this document.</span></span>

## <a name="how-aspnet-mvc-applications-can-present-mobile-specific-pages"></a><span data-ttu-id="a4b87-266">ASP.NET MVC 应用程序可以如何提供移动特定页</span><span class="sxs-lookup"><span data-stu-id="a4b87-266">How ASP.NET MVC applications can present mobile-specific pages</span></span>

<span data-ttu-id="a4b87-267">由于模型-视图-控制器模式将脱耦 （在控制器） 的应用程序逻辑与表示逻辑 （在视图中），你可以从任何以下方法来处理服务器端代码中的移动支持：</span><span class="sxs-lookup"><span data-stu-id="a4b87-267">Since the Model-View-Controller pattern decouples application logic (in controllers) from presentation logic (in views), you can choose from any of the following approaches to handling mobile support in server-side code:</span></span>

1. <span data-ttu-id="a4b87-268">***对于桌面版和移动浏览器，使用相同的控制器和视图，但呈现的视图有不同的 Razor 布局，具体取决于设备类型 *。**</span><span class="sxs-lookup"><span data-stu-id="a4b87-268">***Use the same controllers and views for both desktop and mobile browsers, but render the views with different Razor layouts depending on the device type*.**</span></span> <span data-ttu-id="a4b87-269">如果你要在所有设备上显示相同的数据，但只是想要提供不同的 CSS 样式表或更改为移动的几个顶级 HTML 元素，此选项效果最佳。</span><span class="sxs-lookup"><span data-stu-id="a4b87-269">This option works best if you're displaying identical data on all devices, but simply want to supply different CSS stylesheets or change a few top-level HTML elements for mobiles.</span></span>
2. <span data-ttu-id="a4b87-270">***对于桌面版和移动浏览器，使用同一个控制器，但呈现根据设备类型的不同视图***。</span><span class="sxs-lookup"><span data-stu-id="a4b87-270">***Use the same controllers for both desktop and mobile browsers, but render different views depending on the device type***.</span></span> <span data-ttu-id="a4b87-271">如果是显示大致相同的数据并提供相同的工作流的最终用户，此选项效果最佳，但想要呈现非常不同的 HTML 标记，以满足当前使用的设备。</span><span class="sxs-lookup"><span data-stu-id="a4b87-271">This option works best if you're displaying roughly the same data and providing the same workflows for end users, but want to render very different HTML markup to suit the device being used.</span></span>
3. <span data-ttu-id="a4b87-272">***创建桌面和移动浏览器，每个实现独立控制器和视图的单独区域 *。**</span><span class="sxs-lookup"><span data-stu-id="a4b87-272">***Create separate areas for desktop and mobile browsers, implementing independent controllers and views for each*.**</span></span> <span data-ttu-id="a4b87-273">如果你显示非常不同的屏幕，包含不同的信息和前导用户通过优化为其设备类型的不同工作流，此选项效果最佳。</span><span class="sxs-lookup"><span data-stu-id="a4b87-273">This option works best if you're displaying very different screens, containing different information and leading the user through different workflows optimized for their device type.</span></span> <span data-ttu-id="a4b87-274">这可能意味着一些重复代码，但你也可以通过将出常见逻辑分解到基础层或服务对的最小化。</span><span class="sxs-lookup"><span data-stu-id="a4b87-274">It may mean some repetition of code, but you can minimize that by factoring out common logic into an underlying layer or service.</span></span>

<span data-ttu-id="a4b87-275">如果你想要利用**第一个**选项和变化仅 Razor 布局每种设备类型，它是非常简单。</span><span class="sxs-lookup"><span data-stu-id="a4b87-275">If you want to take the **first** option and vary only the Razor layout per device type, it's very easy.</span></span> <span data-ttu-id="a4b87-276">只需修改你\_ViewStart.cshtml 文件，如下所示：</span><span class="sxs-lookup"><span data-stu-id="a4b87-276">Just modify your \_ViewStart.cshtml file as follows:</span></span>

[!code-cshtml[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample7.cshtml)]

<span data-ttu-id="a4b87-277">现在，你可以创建移动特定布局调用\_LayoutMobile.cshtml 与页结构和 CSS 规则针对移动设备进行了优化。</span><span class="sxs-lookup"><span data-stu-id="a4b87-277">Now you can create a mobile-specific layout called \_LayoutMobile.cshtml with a page structure and CSS rules optimized for mobile devices.</span></span>

<span data-ttu-id="a4b87-278">如果你想要利用**第二个**选项呈现器根据访问者的设备类型的完全不同视图，请参阅[Scott Hanselman 的博客文章](http://www.hanselman.com/blog/ABetterASPNETMVCMobileDeviceCapabilitiesViewEngine.aspx)。</span><span class="sxs-lookup"><span data-stu-id="a4b87-278">If you want to take the **second** option render totally different views according to the visitor's device type, see [Scott Hanselman's blog post](http://www.hanselman.com/blog/ABetterASPNETMVCMobileDeviceCapabilitiesViewEngine.aspx).</span></span>

<span data-ttu-id="a4b87-279">本文的其余部分侧重于**第三个**选项 – 创建单独的控制器*和*视图适用于移动设备 – 以便您可以控制完全为移动的访客提供哪些功能的子集。</span><span class="sxs-lookup"><span data-stu-id="a4b87-279">The rest of this paper focuses on the **third** option – creating separate controllers *and* views for mobile devices – so you can control exactly what subset of functionality is offered for mobile visitors.</span></span>

### <a name="setting-up-a-mobile-area-within-your-aspnet-mvc-application"></a><span data-ttu-id="a4b87-280">ASP.NET MVC 应用程序中的移动区域设置</span><span class="sxs-lookup"><span data-stu-id="a4b87-280">Setting up a Mobile area within your ASP.NET MVC application</span></span>

<span data-ttu-id="a4b87-281">你可以添加以常规方式称为"移动"到现有的 ASP.NET MVC 应用程序的区域： 右键单击你的项目名称，在解决方案资源管理器，然后选择添加 à 区域。</span><span class="sxs-lookup"><span data-stu-id="a4b87-281">You can add an area called "Mobile" to an existing ASP.NET MVC application in the normal way: right-click on your project name in Solution Explorer, then choose Add à Area.</span></span> <span data-ttu-id="a4b87-282">根据需要对 ASP.NET MVC 应用程序内的任何其他区域，然后可以添加控制器和视图。</span><span class="sxs-lookup"><span data-stu-id="a4b87-282">You can then add controllers and views as you would for any other area within an ASP.NET MVC application.</span></span> <span data-ttu-id="a4b87-283">例如，将添加到你移动区域调用 HomeController 作为移动访客主页的新控制器。</span><span class="sxs-lookup"><span data-stu-id="a4b87-283">For example, add to your Mobile area a new controller called HomeController to act as a homepage for mobile visitors.</span></span>

### <a name="ensuring-the-url-mobile-reaches-the-mobile-homepage"></a><span data-ttu-id="a4b87-284">确保 URL /Mobile 达到移动主页</span><span class="sxs-lookup"><span data-stu-id="a4b87-284">Ensuring the URL /Mobile reaches the mobile homepage</span></span>

<span data-ttu-id="a4b87-285">如果你想 URL /Mobile 来访问上 HomeController 移动区域内的索引操作，你将需要对路由配置进行以下两个小型更改。</span><span class="sxs-lookup"><span data-stu-id="a4b87-285">If you want the URL /Mobile to reach the Index action on HomeController inside your Mobile area, you will need to make two small changes to your routing configuration.</span></span> <span data-ttu-id="a4b87-286">首先，更新 MobileAreaRegistration 类以便 HomeController 默认控制器你移动所在区域，如下面的代码中所示：</span><span class="sxs-lookup"><span data-stu-id="a4b87-286">First, update your MobileAreaRegistration class so that HomeController is the default controller in your Mobile area, as shown in the following code:</span></span>

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample8.cs)]

<span data-ttu-id="a4b87-287">这意味着移动主页现在将在 /Mobile，而不是/移动/主页，位于因为"主页"现在为隐式移动页面的默认控制器名称。</span><span class="sxs-lookup"><span data-stu-id="a4b87-287">This means the mobile homepage will now be located at /Mobile, rather than /Mobile/Home, because "Home" is now the implicitly default controller name for mobile pages.</span></span>

<span data-ttu-id="a4b87-288">接下来，请注意，通过将第二个 HomeController 添加到你的应用程序 （即，移动一个，除了现有桌面一个），你将破坏了你正则桌面主页。</span><span class="sxs-lookup"><span data-stu-id="a4b87-288">Next, note that by adding a second HomeController to your application (i.e., the mobile one, in addition to the existing desktop one), you'll have broken your regular desktop homepage.</span></span> <span data-ttu-id="a4b87-289">它将失败并出现错误"*找到多个类型符合名为主页控制器*"。</span><span class="sxs-lookup"><span data-stu-id="a4b87-289">It will fail with the error "*Multiple types were found that match the controller named 'Home'*".</span></span> <span data-ttu-id="a4b87-290">若要解决此问题，请更新顶层路由配置 （在 Global.asax.cs) 指定歧义时，你的桌面 HomeController 的执行优先级：</span><span class="sxs-lookup"><span data-stu-id="a4b87-290">To resolve this, update your top-level routing configuration (in Global.asax.cs) to specify that your desktop HomeController should take priority when there's ambiguity:</span></span>

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample9.cs)]

<span data-ttu-id="a4b87-291">现在该错误会离开和 URL http://*yoursite*/ 将到达的桌面主页和 http://*yoursite*/mobile/ 将到达移动主页。</span><span class="sxs-lookup"><span data-stu-id="a4b87-291">Now the error will go away, and the URL http://*yoursite*/ will reach the desktop homepage, and http://*yoursite*/mobile/ will reach the mobile homepage.</span></span>

### <a name="redirecting-mobile-visitors-to-your-mobile-area"></a><span data-ttu-id="a4b87-292">重定向到你移动区域的移动访问者</span><span class="sxs-lookup"><span data-stu-id="a4b87-292">Redirecting mobile visitors to your mobile area</span></span>

<span data-ttu-id="a4b87-293">有许多不同的扩展点在 ASP.NET MVC 中，因此有许多可能的方法，以插入重定向逻辑。</span><span class="sxs-lookup"><span data-stu-id="a4b87-293">There are many different extensibility points in ASP.NET MVC, so there are many possible ways to inject redirection logic.</span></span> <span data-ttu-id="a4b87-294">一种很不错的选择是创建一个筛选器属性，[RedirectMobileDevicesToMobileArea]，执行的重定向，如果满足以下条件：</span><span class="sxs-lookup"><span data-stu-id="a4b87-294">One neat option is to create a filter attribute, [RedirectMobileDevicesToMobileArea], that performs a redirection if the following conditions are met:</span></span>

1. <span data-ttu-id="a4b87-295">它是用户的会话中的第一个请求 （即，Session.IsNewSession 等于 true）</span><span class="sxs-lookup"><span data-stu-id="a4b87-295">It's the first request in the user's session (i.e., Session.IsNewSession equals true)</span></span>
2. <span data-ttu-id="a4b87-296">请求来自移动浏览器 （即，Request.Browser.IsMobileDevice 等于 true）</span><span class="sxs-lookup"><span data-stu-id="a4b87-296">The request comes from a mobile browser (i.e., Request.Browser.IsMobileDevice equals true)</span></span>
3. <span data-ttu-id="a4b87-297">用户未在已请求的移动区域中的资源 (即，*路径*URL 的一部分不会以开头 /Mobile)</span><span class="sxs-lookup"><span data-stu-id="a4b87-297">The user is not already requesting a resource in the mobile area (i.e., the *path* part of the URL does not begin with /Mobile)</span></span>

<span data-ttu-id="a4b87-298">随附这份白皮书的可下载示例包括此逻辑的实现。</span><span class="sxs-lookup"><span data-stu-id="a4b87-298">The downloadable sample included with this white paper includes an implementation of this logic.</span></span> <span data-ttu-id="a4b87-299">它作为授权筛选器，从 AuthorizeAttribute，这意味着它可以正确起作用，即使你使用输出缓存 （否则为如果桌面的访问者的第一个访问某些 URL，桌面输出可能缓存，然后提供给派生实现后续移动访问者）。</span><span class="sxs-lookup"><span data-stu-id="a4b87-299">It's implemented as an authorization filter, derived from AuthorizeAttribute, which means it can work correctly even if you are using output caching (otherwise, if a desktop visitor first accesses a certain URL, the desktop output might be cached and then served to subsequent mobile visitors).</span></span>

<span data-ttu-id="a4b87-300">由于它是筛选器，你可以选择将它应用到特定控制器和操作，例如，</span><span class="sxs-lookup"><span data-stu-id="a4b87-300">As it's a filter, you can choose either to apply it to specific controllers and actions, e.g.,</span></span>

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample10.cs)]

<span data-ttu-id="a4b87-301">…</span><span class="sxs-lookup"><span data-stu-id="a4b87-301">…</span></span> <span data-ttu-id="a4b87-302">你可以将其应用于所有控制器和操作如 MVC 3 或*全局筛选器*Global.asax.cs 文件中：</span><span class="sxs-lookup"><span data-stu-id="a4b87-302">or you can apply it to all controllers and actions as an MVC 3 *global filter* in your Global.asax.cs file:</span></span>

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample11.cs)]

<span data-ttu-id="a4b87-303">可下载的示例还演示如何创建此特性将重定向到你移动区域中的特定位置的子类。</span><span class="sxs-lookup"><span data-stu-id="a4b87-303">The downloadable sample also demonstrates how you can create subclasses of this attribute that redirect to specific locations within your mobile area.</span></span> <span data-ttu-id="a4b87-304">例如，这意味着你可以：</span><span class="sxs-lookup"><span data-stu-id="a4b87-304">This means, for example, you can:</span></span>

- <span data-ttu-id="a4b87-305">注册全局筛选器如下所示上述默认情况下发送到移动主页的移动访问者。</span><span class="sxs-lookup"><span data-stu-id="a4b87-305">Register a global filter as shown above that sends mobile visitors to the mobile homepage by default.</span></span>
- <span data-ttu-id="a4b87-306">也适用于采用移动到具有请求的任何产品页面的移动版本的访问者的"查看产品"操作的特殊 [RedirectMobileDevicesToMobileProductPage] 筛选器。</span><span class="sxs-lookup"><span data-stu-id="a4b87-306">Also apply a special [RedirectMobileDevicesToMobileProductPage] filter to a "view product" action that takes mobile visitors to the mobile version of whatever product page they had requested.</span></span>
- <span data-ttu-id="a4b87-307">此外将筛选器的其他特殊子类应用于特定操作，将重定向到等效的移动页的移动访问者</span><span class="sxs-lookup"><span data-stu-id="a4b87-307">Also apply other special subclasses of the filter to specific actions, redirecting mobile visitors to the equivalent mobile page</span></span>

### <a name="configuring-forms-authentication-to-respect-your-mobile-pages"></a><span data-ttu-id="a4b87-308">配置采用了移动页的 Forms 身份验证</span><span class="sxs-lookup"><span data-stu-id="a4b87-308">Configuring Forms Authentication to respect your mobile pages</span></span>

<span data-ttu-id="a4b87-309">如果你使用的窗体身份验证，则应注意，当用户需要登录时，它自动将用户重定向到单个特定"登录"的 URL，即默认情况下**/帐户/登录**。</span><span class="sxs-lookup"><span data-stu-id="a4b87-309">If you're using Forms Authentication, you should note that when a user needs to log in, it automatically redirects the user to a single specific "log on" URL, which by default is **/Account/LogOn**.</span></span> <span data-ttu-id="a4b87-310">这意味着，移动用户可能会重定向到你的桌面"登录"操作。</span><span class="sxs-lookup"><span data-stu-id="a4b87-310">This means that mobile users may be redirected to your desktop "log on" action.</span></span>

<span data-ttu-id="a4b87-311">若要避免此问题，请向你的桌面"登录"操作添加逻辑，以便它将重定向移动用户再次到"登录"的移动操作。</span><span class="sxs-lookup"><span data-stu-id="a4b87-311">To avoid this problem, add logic to your desktop "log on" action so that it redirects mobile users again to a mobile "log on" action.</span></span> <span data-ttu-id="a4b87-312">如果你使用的默认 ASP.NET MVC 应用程序模板，更新 AccountController 的登录操作，如下所示：</span><span class="sxs-lookup"><span data-stu-id="a4b87-312">If you're using the default ASP.NET MVC application template, update AccountController's LogOn action as follows:</span></span>

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample12.cs)]

<span data-ttu-id="a4b87-313">…</span><span class="sxs-lookup"><span data-stu-id="a4b87-313">…</span></span> <span data-ttu-id="a4b87-314">然后在你移动所在区域调用 AccountController 控制器上实现合适的移动特定"登录"操作。</span><span class="sxs-lookup"><span data-stu-id="a4b87-314">and then implement a suitable mobile-specific "log on" action on a controller called AccountController in your Mobile area.</span></span>

### <a name="working-with-output-caching"></a><span data-ttu-id="a4b87-315">使用输出缓存</span><span class="sxs-lookup"><span data-stu-id="a4b87-315">Working with Output Caching</span></span>

<span data-ttu-id="a4b87-316">如果你使用 [OutputCache] 筛选器，必须强制执行要根据设备类型而变化的缓存项。</span><span class="sxs-lookup"><span data-stu-id="a4b87-316">If you're using the [OutputCache] filter, you must force the cache entry to vary by device type.</span></span> <span data-ttu-id="a4b87-317">例如，编写：</span><span class="sxs-lookup"><span data-stu-id="a4b87-317">For example, write:</span></span>

[!code-javascript[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample13.js)]

<span data-ttu-id="a4b87-318">然后，将以下方法添加到 Global.asax.cs 文件：</span><span class="sxs-lookup"><span data-stu-id="a4b87-318">Then, add the following method to your Global.asax.cs file:</span></span>

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample14.cs)]

<span data-ttu-id="a4b87-319">这将确保移动到页的访问者没有收到以前通过桌面访问者放入缓存的输出。</span><span class="sxs-lookup"><span data-stu-id="a4b87-319">This will ensure that mobile visitors to the page don't receive output previously put into the cache by a desktop visitor.</span></span>

### <a name="a-working-example"></a><span data-ttu-id="a4b87-320">获得可运行示例</span><span class="sxs-lookup"><span data-stu-id="a4b87-320">A working example</span></span>

<span data-ttu-id="a4b87-321">若要查看这些技术在操作中的，下载[这份白皮书的代码的关联示例](https://docs.microsoft.com/aspnet/mobile/overview)。</span><span class="sxs-lookup"><span data-stu-id="a4b87-321">To see these techniques in action, download [this white paper's code associated samples](https://docs.microsoft.com/aspnet/mobile/overview).</span></span> <span data-ttu-id="a4b87-322">此示例包括增强，从而支持使用上面所述的方法的移动设备的 ASP.NET MVC 3 （候选发布版） 应用程序。</span><span class="sxs-lookup"><span data-stu-id="a4b87-322">The sample includes an ASP.NET MVC 3 (Release Candidate) application enhanced to support mobile devices using the methods described above.</span></span>

## <a name="further-guidance-and-suggestions"></a><span data-ttu-id="a4b87-323">更多指导和建议</span><span class="sxs-lookup"><span data-stu-id="a4b87-323">Further guidance and suggestions</span></span>

<span data-ttu-id="a4b87-324">下面的讨论适用于 Web 窗体和 MVC 的开发人员使用本文档中阐述的技术。</span><span class="sxs-lookup"><span data-stu-id="a4b87-324">The following discussion applies both to Web Forms and MVC developers who are using the techniques covered in this document.</span></span>

### <a name="enhancing-your-redirection-logic-using-51degreesmobi-foundation"></a><span data-ttu-id="a4b87-325">提高使用 51Degrees.mobi Foundation 你重定向逻辑</span><span class="sxs-lookup"><span data-stu-id="a4b87-325">Enhancing your redirection logic using 51Degrees.mobi Foundation</span></span>

<span data-ttu-id="a4b87-326">此文档中所示的重定向逻辑可能会完全能够满足你的应用程序，但它不起作用，如果你需要禁用会话，或与拒绝的 cookie （这些不能具有会话），因为它不会知道是否给定请求的移动浏览器从该访问者选择第一个。</span><span class="sxs-lookup"><span data-stu-id="a4b87-326">The redirection logic shown in this document may be perfectly sufficient for your application, but it won't work if you need to disable sessions, or with mobile browsers that reject cookies (these can't have sessions), because it won't know whether a given request is the first one from that visitor.</span></span>

<span data-ttu-id="a4b87-327">你已学习了如何开放源代码 51Degrees.mobi Foundation 可以提高 ASP 的准确性。NET 的浏览器检测。</span><span class="sxs-lookup"><span data-stu-id="a4b87-327">You already learned how the open source 51Degrees.mobi Foundation can improve the accuracy of ASP.NET's browser detection.</span></span> <span data-ttu-id="a4b87-328">它还具有一项内置功能来重定向到在 Web.config 中配置的特定位置的移动访问者。能够根据 ASP.NET 会话正常 (并因此 cookie) 通过将存储的访问者的 HTTP 标头和 IP 地址的哈希的临时日志，以便它知道每个请求是否是从给定 vistor 的第一个。</span><span class="sxs-lookup"><span data-stu-id="a4b87-328">It also has a built-in ability to redirect mobile visitors to specific locations configured in Web.config. It's able to work without depending on ASP.NET Sessions (and hence cookies) by storing a temporary log of hashes of visitors' HTTP headers and IP addresses, so it knows whether or not each request is the first one from a given vistor.</span></span>

<span data-ttu-id="a4b87-329">下面的元素添加到 web.config 文件的 fiftyOne 节将重定向到页从检测到的移动设备的第一个请求 ~ / Mobile/Default.aspx。</span><span class="sxs-lookup"><span data-stu-id="a4b87-329">The following element added to the fiftyOne section of the web.config file will redirect the first request from a detected mobile device to the page ~/Mobile/Default.aspx.</span></span> <span data-ttu-id="a4b87-330">移动文件夹下的页的任何请求将*不*被重定向，无论何种设备类型。</span><span class="sxs-lookup"><span data-stu-id="a4b87-330">Any requests to pages under the Mobile folder will *not* be redirected, regardless of device type.</span></span> <span data-ttu-id="a4b87-331">如果移动设备已处于非活动状态一段的 20 分钟或更多的设备将被遗忘和后续请求将被视为出于的重定向的新的。</span><span class="sxs-lookup"><span data-stu-id="a4b87-331">If the mobile device has been inactive for a period of 20 minutes or more the device will be forgotten and subsequent requests will be treated as new ones for the purposes of redirection.</span></span>

[!code-xml[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample15.xml)]

<span data-ttu-id="a4b87-332">有关更多详细信息，请参阅[51degrees.mobi Foundation 文档](https://github.com/51Degrees/dotNET-Device-Detection)。</span><span class="sxs-lookup"><span data-stu-id="a4b87-332">For more details, see [51degrees.mobi Foundation documentation](https://github.com/51Degrees/dotNET-Device-Detection).</span></span>

> [!NOTE]
> <span data-ttu-id="a4b87-333">你*可以*使用 51Degrees.mobi Foundation 重定向功能，在 ASP.NET MVC 应用程序，但你将需要定义纯 Url，不是从路由的参数或通过将放在 MVC 筛选器根据你重定向的配置上操作。</span><span class="sxs-lookup"><span data-stu-id="a4b87-333">You *can* use 51Degrees.mobi Foundation's redirection feature on ASP.NET MVC applications, but you will need to define your redirection configuration in terms of plain URLs, not in terms of routing parameters or by putting MVC filters on actions.</span></span> <span data-ttu-id="a4b87-334">这是因为 （在撰写本文时） 51Degrees.mobi Foundation 无法识别筛选器或路由。</span><span class="sxs-lookup"><span data-stu-id="a4b87-334">This is because (at the time of writing) 51Degrees.mobi Foundation does not recognize filters or routing.</span></span>


### <a name="disabling-transcoders-and-proxy-servers"></a><span data-ttu-id="a4b87-335">禁用转码器和代理服务器</span><span class="sxs-lookup"><span data-stu-id="a4b87-335">Disabling Transcoders and Proxy Servers</span></span>

<span data-ttu-id="a4b87-336">移动网络运营商在移动 internet 其方法中具有两个主要目标：</span><span class="sxs-lookup"><span data-stu-id="a4b87-336">Mobile network operators have two broad objectives in their approach to the mobile internet:</span></span>

1. <span data-ttu-id="a4b87-337">提供作为尽可能得多相关内容</span><span class="sxs-lookup"><span data-stu-id="a4b87-337">Provide as much relevant content as possible</span></span>
2. <span data-ttu-id="a4b87-338">最大化可以共享的有限的单选网络带宽的客户的数</span><span class="sxs-lookup"><span data-stu-id="a4b87-338">Maximize the number of customers who can share the limited radio network bandwidth</span></span>

<span data-ttu-id="a4b87-339">由于大多数 web 页中为大型桌面尺寸屏幕和快速修复行宽带连接设计，许多运算符使用*转码器*或*代理服务器*，动态更改 web 内容。</span><span class="sxs-lookup"><span data-stu-id="a4b87-339">Since most web pages were designed for large desktop-sized screens and fast fixed-line broadband connections, many operators use *transcoders* or *proxy servers* that dynamically alter web content.</span></span> <span data-ttu-id="a4b87-340">它们可能会修改你的 HTML 标记或 CSS 以适合较小屏幕 （特别是对于"功能手机"缺少处理复杂的布局的处理能力），和它们可能重新压缩映像 （显著减少其质量） 以提高页传递速度。</span><span class="sxs-lookup"><span data-stu-id="a4b87-340">They may modify your HTML markup or CSS to suit smaller screens (especially for "feature phones" that lack the processing power to handle complex layouts), and they may recompress your images (significantly reducing their quality) to improve page delivery speeds.</span></span>

<span data-ttu-id="a4b87-341">但如果你已取得以生成你的站点的移动优化版本的工作，您可能不需要网络运营商干扰它任何进一步。</span><span class="sxs-lookup"><span data-stu-id="a4b87-341">But if you've taken the effort to produce a mobile-optimized version of your site, you probably don't want the network operator to interfere with it any further.</span></span> <span data-ttu-id="a4b87-342">你可以将以下行添加到页\_任何 ASP.NET Web 窗体中的负载事件：</span><span class="sxs-lookup"><span data-stu-id="a4b87-342">You can add the following line to the Page\_Load event in any ASP.NET Web Form:</span></span>

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample16.cs)]

<span data-ttu-id="a4b87-343">或者，为 ASP.NET MVC 控制器，你可以添加以下方法重写，以便它适用于在该控制器上的所有操作：</span><span class="sxs-lookup"><span data-stu-id="a4b87-343">Or, for an ASP.NET MVC controller, you could add the following method override so that it applies to all actions on that controller:</span></span>

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample17.cs)]

<span data-ttu-id="a4b87-344">生成的 HTTP 消息通知 W3C 符合转码器和代理服务器不以更改内容。</span><span class="sxs-lookup"><span data-stu-id="a4b87-344">The resulting HTTP message informs W3C compliant transcoders and proxies not to alter content.</span></span> <span data-ttu-id="a4b87-345">当然，没有移动网络运营商将遵守此消息能保证。</span><span class="sxs-lookup"><span data-stu-id="a4b87-345">Of course, there is no guarantee that mobile network operators will respect this message.</span></span>

### <a name="styling-mobile-pages-for-mobile-browsers"></a><span data-ttu-id="a4b87-346">移动浏览器样式移动页</span><span class="sxs-lookup"><span data-stu-id="a4b87-346">Styling mobile pages for mobile browsers</span></span>

<span data-ttu-id="a4b87-347">它超出了范围本文详细说明的哪些类型的 HTML 标记工作正确或哪些 web 设计技术最大化特定设备上的可用性。</span><span class="sxs-lookup"><span data-stu-id="a4b87-347">It's beyond the scope of this document to describe in great detail what kinds of HTML markup work correctly or which web design techniques maximize usability on particular devices.</span></span> <span data-ttu-id="a4b87-348">该类具有设置到你可以找到足够简单布局中，优化移动大小屏幕，而无需使用不可靠 HTML 或 CSS 定位技巧。</span><span class="sxs-lookup"><span data-stu-id="a4b87-348">It's up to you to find a sufficiently simple layout, optimized for a mobile-sized screen, without using unreliable HTML or CSS positioning tricks.</span></span> <span data-ttu-id="a4b87-349">但是，是一个重要的技术，值得一提的是，*视区元标记*。</span><span class="sxs-lookup"><span data-stu-id="a4b87-349">One important technique worth mentioning, however, is the *viewport meta tag*.</span></span>

<span data-ttu-id="a4b87-350">某些现代移动浏览器，用于桌面监视器工作量显示网页中的呈现虚拟画布，也称为"视区"上的页面 （例如，虚拟视区是 980 像素宽 iPhone 上, 和 850 像素宽 Opera Mobile 在默认情况下），然后缩减结果以适合屏幕的物理像素。</span><span class="sxs-lookup"><span data-stu-id="a4b87-350">Certain modern mobile browsers, in an effort display web pages meant for desktop monitors, render the page on a virtual canvas, also called "viewport" (e.g., the virtual viewport is 980 pixels wide on iPhone, and 850 pixels wide on Opera Mobile by default) and then scale the result down to fit onto the screen's physical pixels.</span></span> <span data-ttu-id="a4b87-351">然后，用户可以放大并移动该视区。</span><span class="sxs-lookup"><span data-stu-id="a4b87-351">The user can then zoom in and pan around that viewport.</span></span> <span data-ttu-id="a4b87-352">这样做的优势，它可让浏览器显示其预期的布局中的页面，但它也是具有它强制缩放和平移，其中对于用户来说不方便的缺点。</span><span class="sxs-lookup"><span data-stu-id="a4b87-352">This has the advantage that it lets the browser display the page in its intended layout, but it's also has the disadvantage that it forces zooming and panning, which is inconvenient for the user.</span></span> <span data-ttu-id="a4b87-353">如果你设计移动，最好是设计窄屏幕，以便有必要进行没有缩放或水平滚动。</span><span class="sxs-lookup"><span data-stu-id="a4b87-353">If you're designing for mobile, it's better to design for a narrow screen so that no zooming or horizontal scrolling is necessary.</span></span>

<span data-ttu-id="a4b87-354">告诉移动浏览器将视区应如何宽的方法是通过非标准*视区*meta 标记。</span><span class="sxs-lookup"><span data-stu-id="a4b87-354">A way to tell the mobile browser how wide the viewport should be is through the nonstandard *viewport* meta tag.</span></span> <span data-ttu-id="a4b87-355">例如，如果你将以下代码添加到页面的 HEAD 部分中，</span><span class="sxs-lookup"><span data-stu-id="a4b87-355">For example, if you add the following to your page's HEAD section,</span></span>

[!code-html[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample18.html)]

<span data-ttu-id="a4b87-356">…</span><span class="sxs-lookup"><span data-stu-id="a4b87-356">…</span></span> <span data-ttu-id="a4b87-357">然后支持智能手机浏览器将布局 480 像素宽虚拟画布上的页面。</span><span class="sxs-lookup"><span data-stu-id="a4b87-357">then supporting smartphone browsers will lay out the page on a 480-pixel wide virtual canvas.</span></span> <span data-ttu-id="a4b87-358">这意味着，如果你的 HTML 元素定义以百分比表示的宽度，百分比将解释此 480 像素宽度，不默认视区宽度方面。</span><span class="sxs-lookup"><span data-stu-id="a4b87-358">This means that if your HTML elements define their widths in percentage terms, the percentages will be interpreted with respect to this 480-pixel width, not the default viewport width.</span></span> <span data-ttu-id="a4b87-359">因此，用户很少需要缩放和平移操作水平 – 显著提高的移动浏览体验。</span><span class="sxs-lookup"><span data-stu-id="a4b87-359">As a result, the user is less likely to have to zoom and pan horizontally – considerably improving the mobile browsing experience.</span></span>

<span data-ttu-id="a4b87-360">如果你想要匹配设备的物理像素的视区宽度时，你可以指定以下各项：</span><span class="sxs-lookup"><span data-stu-id="a4b87-360">If you want the viewport width to match the device's physical pixels, you can specify the following:</span></span>

[!code-html[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample19.html)]

<span data-ttu-id="a4b87-361">为此正常工作，你必须不显式强制超过该宽度的元素 (例如，使用*宽度*属性或 CSS 属性)，否则浏览器会强制使用更大的视区而不考虑。</span><span class="sxs-lookup"><span data-stu-id="a4b87-361">For this to work correctly, you must not explicitly force elements to exceed that width (e.g., using a *width* attribute or CSS property), otherwise the browser will be forced to use a larger viewport regardless.</span></span> <span data-ttu-id="a4b87-362">另请参阅：[更多详细信息使用了非标准的视区标记](https://developer.apple.com/library/safari/#documentation/AppleApplications/Reference/SafariHTMLRef/Articles/MetaTags.html)。</span><span class="sxs-lookup"><span data-stu-id="a4b87-362">See also: [more details about the nonstandard viewport tag](https://developer.apple.com/library/safari/#documentation/AppleApplications/Reference/SafariHTMLRef/Articles/MetaTags.html).</span></span>

<span data-ttu-id="a4b87-363">大多数现代智能手机支持*双重方向*： 它们可以保存在纵向或横向模式中。</span><span class="sxs-lookup"><span data-stu-id="a4b87-363">Most modern smartphones support *dual orientation*: they can be held in either portrait or landscape mode.</span></span> <span data-ttu-id="a4b87-364">因此，务必不假设的屏幕宽度 （像素）。</span><span class="sxs-lookup"><span data-stu-id="a4b87-364">So, it's important not to make assumptions about the screen width in pixels.</span></span> <span data-ttu-id="a4b87-365">不甚至假设，修复后的屏幕宽度，因为用户可以重新定向其设备时它们位于你的页面。</span><span class="sxs-lookup"><span data-stu-id="a4b87-365">Don't even assume that the screen width is fixed, because the user can re-orient their device while they are on your page.</span></span>

<span data-ttu-id="a4b87-366">通知他们内容页标题中的以下元标记已经过优化，适用于移动，因此不应转换，也可接受较旧的 Windows Mobile 和 Blackberry 设备。</span><span class="sxs-lookup"><span data-stu-id="a4b87-366">Older Windows Mobile and Blackberry devices may also accept the following meta tags in the page header to inform them content has been optimized for mobile and therefore should not be transformed.</span></span>

[!code-html[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample20.html)]

## <a name="additional-resources"></a><span data-ttu-id="a4b87-367">其他资源</span><span class="sxs-lookup"><span data-stu-id="a4b87-367">Additional Resources</span></span>

<span data-ttu-id="a4b87-368">有关移动设备仿真程序和可用于测试移动的 ASP.NET web 应用程序的列表，请参阅页面[模拟常用的移动设备以进行测试](../mobile/device-simulators.md)。</span><span class="sxs-lookup"><span data-stu-id="a4b87-368">For a list of mobile device emulators and simulators you can use to test your mobile ASP.NET web application, see the page [Simulate popular mobile devices for testing](../mobile/device-simulators.md).</span></span>

## <a name="credits"></a><span data-ttu-id="a4b87-369">信用</span><span class="sxs-lookup"><span data-stu-id="a4b87-369">Credits</span></span>

- <span data-ttu-id="a4b87-370">主要作者： Steven Sanderson</span><span class="sxs-lookup"><span data-stu-id="a4b87-370">Primary author: Steven Sanderson</span></span>
- <span data-ttu-id="a4b87-371">审阅者 / 其他内容编写器： James Rosewell、 Mikael Söderström、 Scott Hanselman、 Scott 搜寻</span><span class="sxs-lookup"><span data-stu-id="a4b87-371">Reviewers / additional content writers: James Rosewell, Mikael Söderström, Scott Hanselman, Scott Hunter</span></span>
