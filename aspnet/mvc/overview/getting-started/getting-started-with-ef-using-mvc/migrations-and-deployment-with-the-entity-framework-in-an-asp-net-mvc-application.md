---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
title: 代码优先迁移和部署 ASP.NET MVC 应用程序中的实体框架 |Microsoft 文档
author: tdykstra
description: Contoso 大学示例 web 应用程序演示如何创建使用 Entity Framework 6 Code First 和 Visual Studio 的 ASP.NET MVC 5 应用程序...
ms.author: aspnetcontent
manager: wpickett
ms.date: 11/07/2014
ms.topic: article
ms.assetid: d4dfc435-bda6-4621-9762-9ba270f8de4e
ms.technology: dotnet-mvc
ms.prod: .net-framework
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 04d393edca0469df140f06a7d083a48aa8f84b65
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/06/2018
ms.locfileid: "30879551"
---
<a name="code-first-migrations-and-deployment-with-the-entity-framework-in-an-aspnet-mvc-application"></a><span data-ttu-id="5c5f2-103">代码优先迁移和部署 ASP.NET MVC 应用程序中的实体框架</span><span class="sxs-lookup"><span data-stu-id="5c5f2-103">Code First Migrations and Deployment with the Entity Framework in an ASP.NET MVC Application</span></span>
====================
<span data-ttu-id="5c5f2-104">通过[Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="5c5f2-104">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

<span data-ttu-id="5c5f2-105">[下载已完成的项目](http://code.msdn.microsoft.com/ASPNET-MVC-Application-b01a9fe8)或[下载 PDF](http://download.microsoft.com/download/0/F/B/0FBFAA46-2BFD-478F-8E56-7BF3C672DF9D/Getting%20Started%20with%20Entity%20Framework%206%20Code%20First%20using%20MVC%205.pdf)</span><span class="sxs-lookup"><span data-stu-id="5c5f2-105">[Download Completed Project](http://code.msdn.microsoft.com/ASPNET-MVC-Application-b01a9fe8) or [Download PDF](http://download.microsoft.com/download/0/F/B/0FBFAA46-2BFD-478F-8E56-7BF3C672DF9D/Getting%20Started%20with%20Entity%20Framework%206%20Code%20First%20using%20MVC%205.pdf)</span></span>

> <span data-ttu-id="5c5f2-106">Contoso 大学示例 web 应用程序演示如何创建使用 Entity Framework 6 Code First 和 Visual Studio 2013 的 ASP.NET MVC 5 应用程序。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-106">The Contoso University sample web application demonstrates how to create ASP.NET MVC 5 applications using the Entity Framework 6 Code First and Visual Studio 2013.</span></span> <span data-ttu-id="5c5f2-107">若要了解系列教程，请参阅[本系列中的第一个教程](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md)。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-107">For information about the tutorial series, see [the first tutorial in the series](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span></span>

<span data-ttu-id="5c5f2-108">到目前为止应用程序已经运行本地 IIS Express 在开发计算机上。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-108">So far the application has been running locally in IIS Express on your development computer.</span></span> <span data-ttu-id="5c5f2-109">若要实际的应用程序可用于通过 Internet 使用其他人，你必须将其部署到 web 宿主提供程序。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-109">To make a real application available for other people to use over the Internet, you have to deploy it to a web hosting provider.</span></span> <span data-ttu-id="5c5f2-110">在本教程中，你将部署到 Azure 中云 Contoso 大学应用程序。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-110">In this tutorial, you'll deploy the Contoso University application to the cloud in Azure.</span></span>

<span data-ttu-id="5c5f2-111">本教程包含以下各节：</span><span class="sxs-lookup"><span data-stu-id="5c5f2-111">The tutorial contains the following sections:</span></span>

- <span data-ttu-id="5c5f2-112">启用 Code First 迁移。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-112">Enable Code First Migrations.</span></span> <span data-ttu-id="5c5f2-113">迁移功能，可更改数据模型并将其部署到生产环境所做的更改，通过无需删除并重新创建该数据库中更新数据库架构。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-113">The Migrations feature enables you to change the data model and deploy your changes to production by updating the database schema without having to drop and re-create the database.</span></span>
- <span data-ttu-id="5c5f2-114">将部署到 Azure。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-114">Deploy to Azure.</span></span> <span data-ttu-id="5c5f2-115">此步骤是可选的;无部署项目的情况下，您可以使用剩余的教程继续。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-115">This step is optional; you can continue with the remaining tutorials without having deployed the project.</span></span>

<span data-ttu-id="5c5f2-116">我们建议你与源代码管理中使用持续集成过程进行部署，但本教程不涉及这些主题。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-116">We recommend that you use a continuous integration process with source control for deployment, but this tutorial does not cover those topics.</span></span> <span data-ttu-id="5c5f2-117">有关详细信息，请参阅[源代码管理](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control)和[持续集成](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery)的章节[使用 Azure 构建真实世界云应用](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction)电子书。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-117">For more information, see the [source control](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control) and [continuous integration](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) chapters of the [Building Real-World Cloud Apps with Azure](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction) e-book.</span></span>

## <a name="enable-code-first-migrations"></a><span data-ttu-id="5c5f2-118">启用 Code First 迁移</span><span class="sxs-lookup"><span data-stu-id="5c5f2-118">Enable Code First Migrations</span></span>

<span data-ttu-id="5c5f2-119">开发新应用程序时，数据模型会频繁更改。每当模型更改时，模型都无法与数据库保持同步。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-119">When you develop a new application, your data model changes frequently, and each time the model changes, it gets out of sync with the database.</span></span> <span data-ttu-id="5c5f2-120">你已配置实体框架可以自动除去并重新创建数据库每次更改数据模型。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-120">You have configured the Entity Framework to automatically drop and re-create the database each time you change the data model.</span></span> <span data-ttu-id="5c5f2-121">当添加、 删除，或更改实体类或更改你`DbContext`类，在下次运行应用程序时自动删除现有数据库，创建一个新的匹配模型，并设定其种子使用测试数据。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-121">When you add, remove, or change entity classes or change your `DbContext` class, the next time you run the application it automatically deletes your existing database, creates a new one that matches the model, and seeds it with test data.</span></span>

<span data-ttu-id="5c5f2-122">这种使数据库与数据模型保持同步的方法适用于多种情况，但将应用程序部署到生产环境的情况除外。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-122">This method of keeping the database in sync with the data model works well until you deploy the application to production.</span></span> <span data-ttu-id="5c5f2-123">当在生产环境中运行应用程序时，它通常存储数据，你想要保留，并不想丢失的所有内容每次进行一次更改如添加新列。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-123">When the application is running in production, it is usually storing data that you want to keep, and you don't want to lose everything each time you make a change such as adding a new column.</span></span> <span data-ttu-id="5c5f2-124">[Code First 迁移](https://msdn.microsoft.com/data/jj591621)功能启用 Code First 来更新数据库架构，而不是删除并重新创建数据库，从而解决了此问题。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-124">The [Code First Migrations](https://msdn.microsoft.com/data/jj591621) feature solves this problem by enabling Code First to update the database schema instead of dropping and re-creating the database.</span></span> <span data-ttu-id="5c5f2-125">在本教程中，你将部署该应用程序，并准备，你将启用迁移。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-125">In this tutorial, you'll deploy the application, and to prepare for that you'll enable Migrations.</span></span>

1. <span data-ttu-id="5c5f2-126">禁用初始值设定项，你将其设置前面通过注释掉或删除`contexts`添加到应用程序 Web.config 文件的元素。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-126">Disable the initializer that you set up earlier by commenting out or deleting the `contexts` element that you added to the application Web.config file.</span></span>

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample1.xml?highlight=2,6)]
2. <span data-ttu-id="5c5f2-127">应用程序中还*Web.config*文件，将连接字符串中数据库的名称更改为 ContosoUniversity2。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-127">Also in the application *Web.config* file, change the name of the database in the connection string to ContosoUniversity2.</span></span>

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample2.xml?highlight=2)]

    <span data-ttu-id="5c5f2-128">此更改将设置项目，以便初始迁移创建新的数据库。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-128">This change sets up the project so that the first migration will create a new database.</span></span> <span data-ttu-id="5c5f2-129">这不是必需，但你将看到更高版本的原因是一个不错的主意。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-129">This isn't required but you'll see later why it's a good idea.</span></span>
3. <span data-ttu-id="5c5f2-130">从**工具**菜单上，单击**库程序包管理器**然后**程序包管理器控制台**。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-130">From the **Tools** menu, click **Library Package Manager** and then **Package Manager Console**.</span></span>

    ![Selecting_Package_Manager_Console](https://asp.net/media/4336350/1pm.png)
4. <span data-ttu-id="5c5f2-132">在`PM>`提示符处输入以下命令：</span><span class="sxs-lookup"><span data-stu-id="5c5f2-132">At the `PM>` prompt enter the following commands:</span></span>

    `enable-migrations`  
    `add-migration InitialCreate`

    ![enable-migrations 命令](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image1.png)

    <span data-ttu-id="5c5f2-134">`enable-migrations`命令创建*迁移*文件夹 ContosoUniversity 项目中，且在该文件夹中放入*Configuration.cs*可编辑以配置迁移的文件。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-134">The `enable-migrations` command creates a *Migrations* folder in the ContosoUniversity project, and it puts in that folder a *Configuration.cs* file that you can edit to configure Migrations.</span></span>

    <span data-ttu-id="5c5f2-135">(如果你错过了前面将引导你要更改数据库名称的步骤，迁移会查找现有的数据库，并自动执行`add-migration`命令。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-135">(If you missed the step above that directs you to change the database name, Migrations will find the existing database and automatically do the `add-migration` command.</span></span> <span data-ttu-id="5c5f2-136">这是确定，它仅表示部署数据库之前，不会运行迁移代码的测试。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-136">That's OK, it just means you won't run a test of the migrations code before you deploy the database.</span></span> <span data-ttu-id="5c5f2-137">在运行时，更高版本`update-database`命令不会发生因为数据库已存在。)</span><span class="sxs-lookup"><span data-stu-id="5c5f2-137">Later when you run the `update-database` command nothing will happen because the database will already exist.)</span></span>

    ![迁移文件夹](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image2.png)

    <span data-ttu-id="5c5f2-139">与前面，所看到的初始值设定项类一样`Configuration`类包括`Seed`方法。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-139">Like the initializer class that you saw earlier, the `Configuration` class includes a `Seed` method.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample3.cs)]

    <span data-ttu-id="5c5f2-140">用途[种子](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx)方法是，可以插入或更新测试数据，Code First 创建或更新数据库之后。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-140">The purpose of the [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method is to enable you to insert or update test data after Code First creates or updates the database.</span></span> <span data-ttu-id="5c5f2-141">创建数据库时和每次更新数据库架构时，数据模型更改后调用该方法。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-141">The method is called when the database is created and every time the database schema is updated after a data model change.</span></span>

### <a name="set-up-the-seed-method"></a><span data-ttu-id="5c5f2-142">设置 Seed 方法</span><span class="sxs-lookup"><span data-stu-id="5c5f2-142">Set up the Seed Method</span></span>

<span data-ttu-id="5c5f2-143">当你删除并重新创建每个数据模型更改的数据库，你使用初始值设定项类的`Seed`方法插入测试数据，因为每次模型更改后删除了该数据库及其测试的所有数据将丢失。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-143">When you are dropping and re-creating the database for every data model change, you use the initializer class's `Seed` method to insert test data, because after every model change the database is dropped and all the test data is lost.</span></span> <span data-ttu-id="5c5f2-144">使用 Code First 迁移，数据保留在数据库更改后的测试，因此包括中的测试数据[种子](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx)方法通常不是必需。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-144">With Code First Migrations, test data is retained after database changes, so including test data in the [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method is typically not necessary.</span></span> <span data-ttu-id="5c5f2-145">事实上，你不希望`Seed`方法插入测试数据，如果你将使用迁移来将数据库部署到生产环境，因为`Seed`方法将在生产中运行。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-145">In fact, you don't want the `Seed` method to insert test data if you'll be using Migrations to deploy the database to production, because the `Seed` method will run in production.</span></span> <span data-ttu-id="5c5f2-146">在这种情况下你想`Seed`方法插入到数据库所需数据在生产环境中。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-146">In that case you want the `Seed` method to insert into the database only the data that you need in production.</span></span> <span data-ttu-id="5c5f2-147">例如，你可能想要包括在实际部门名称的数据库`Department`表应用程序在生产环境中可用时。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-147">For example, you might want the database to include actual department names in the `Department` table when the application becomes available in production.</span></span>

<span data-ttu-id="5c5f2-148">对于本教程，你将在使用迁移部署，但你`Seed`方法将是否仍要插入测试数据，以更加轻松地查看应用程序功能而无需手动插入大量数据的工作原理。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-148">For this tutorial, you'll be using Migrations for deployment, but your `Seed` method will insert test data anyway in order to make it easier to see how application functionality works without having to manually insert a lot of data.</span></span>

1. <span data-ttu-id="5c5f2-149">内容替换*Configuration.cs*替换为以下代码，将测试数据加载到新数据库的文件。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-149">Replace the contents of the *Configuration.cs* file with the following code, which will load test data into the new database.</span></span> 

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample4.cs)]

    <span data-ttu-id="5c5f2-150">[种子](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx)方法采用数据库上下文对象作为输入参数，并方法中的代码使用该对象将新实体添加到数据库。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-150">The [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method takes the database context object as an input parameter, and the code in the method uses that object to add new entities to the database.</span></span> <span data-ttu-id="5c5f2-151">对于每个实体类型的代码将创建新的实体的集合，将它们添加到相应[DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx)属性，然后将保存到数据库的更改。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-151">For each entity type, the code creates a collection of new entities, adds them to the appropriate [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) property, and then saves the changes to the database.</span></span> <span data-ttu-id="5c5f2-152">无需调用[SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx)后的实体的每个组的方法，按上文所述，但执行该操作可帮助你找到问题的源，如果代码写入数据库时发生异常。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-152">It isn't necessary to call the [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) method after each group of entities, as is done here, but doing that helps you locate the source of a problem if an exception occurs while the code is writing to the database.</span></span>

    <span data-ttu-id="5c5f2-153">一些插入数据的语句使用[AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx)方法来执行"upsert"操作。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-153">Some of the statements that insert data use the [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) method to perform an "upsert" operation.</span></span> <span data-ttu-id="5c5f2-154">因为`Seed`方法运行每次执行时`update-database`命令时，通常每个迁移后，不能只是插入数据，因为你尝试添加的行已将存在后创建数据库的初始迁移。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-154">Because the `Seed` method runs every time you execute the `update-database` command, typically after each migration, you can't just insert data, because the rows you are trying to add will already be there after the first migration that creates the database.</span></span> <span data-ttu-id="5c5f2-155">"Upsert"操作可以防止如果你尝试插入的行已存在，但它会发生的错误***重写***对测试应用程序时可能已做的数据的任何更改。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-155">The "upsert" operation prevents errors that would happen if you try to insert a row that already exists, but it ***overrides*** any changes to data that you may have made while testing the application.</span></span> <span data-ttu-id="5c5f2-156">使用某些表中的测试数据您可能不希望这种情况： 在某些情况下在测试期间更改数据时所需更改后数据库更新保留。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-156">With test data in some tables you might not want that to happen: in some cases when you change data while testing you want your changes to remain after database updates.</span></span> <span data-ttu-id="5c5f2-157">在这种情况下要执行条件的插入操作： 仅当它尚不存在插入行。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-157">In that case you want to do a conditional insert operation: insert a row only if it doesn't already exist.</span></span> <span data-ttu-id="5c5f2-158">Seed 方法使用这两种方法。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-158">The Seed method uses both approaches.</span></span>

    <span data-ttu-id="5c5f2-159">第一个参数传递给[AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx)方法指定要用于检查行是否已存在的属性。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-159">The first parameter passed to the [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) method specifies the property to use to check if a row already exists.</span></span> <span data-ttu-id="5c5f2-160">你要提供，测试学生数据`LastName`属性可以用于此目的，因为每个列表中的最后一个名称是唯一的：</span><span class="sxs-lookup"><span data-stu-id="5c5f2-160">For the test student data that you are providing, the `LastName` property can be used for this purpose since each last name in the list is unique:</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample5.cs)]

    <span data-ttu-id="5c5f2-161">此代码假定最后一个名称是唯一的。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-161">This code assumes that last names are unique.</span></span> <span data-ttu-id="5c5f2-162">如果你手动添加具有重复的最后一名学生，你将获得以下异常下次执行迁移。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-162">If you manually add a student with a duplicate last name, you'll get the following exception the next time you perform a migration.</span></span>

    <span data-ttu-id="5c5f2-163">序列包含多个元素</span><span class="sxs-lookup"><span data-stu-id="5c5f2-163">Sequence contains more than one element</span></span>

    <span data-ttu-id="5c5f2-164">有关如何处理如名为"Alexander Carson"的两个学生的冗余数据的信息，请参阅[进行种子设定和调试 Entity Framework (EF) 数据库](https://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx)Rick Anderson 博客上。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-164">For information about how to handle redundant data such as two students named "Alexander Carson", see [Seeding and Debugging Entity Framework (EF) DBs](https://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx) on Rick Anderson's blog.</span></span> <span data-ttu-id="5c5f2-165">有关详细信息`AddOrUpdate`方法，请参阅[负责使用 EF 4.3 AddOrUpdate 方法](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/)Julie Lerman 博客上。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-165">For more information about the `AddOrUpdate` method, see [Take care with EF 4.3 AddOrUpdate Method](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/) on Julie Lerman's blog.</span></span>

    <span data-ttu-id="5c5f2-166">创建的代码`Enrollment`实体假定你已具有`ID`在实体中的值`students`集合，虽然未在创建集合的代码中设置该属性。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-166">The code that creates `Enrollment` entities assumes you have the `ID` value in the entities in the `students` collection, although you didn't set that property in the code that creates the collection.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample6.cs?highlight=2)]

    <span data-ttu-id="5c5f2-167">你可以使用`ID`此处属性因为`ID`在调用时设置值`SaveChanges`为`students`集合。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-167">You can use the `ID` property here because the `ID` value is set when you call `SaveChanges` for the `students` collection.</span></span> <span data-ttu-id="5c5f2-168">EF 自动获取的主键值时它将实体插入到数据库中，并由此更新`ID`在内存中的实体属性。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-168">EF automatically gets the primary key value when it inserts an entity into the database, and it updates the `ID` property of the entity in memory.</span></span>

    <span data-ttu-id="5c5f2-169">每个添加的代码`Enrollment`实体到`Enrollments`实体集不使用`AddOrUpdate`方法。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-169">The code that adds each `Enrollment` entity to the `Enrollments` entity set doesn't use the `AddOrUpdate` method.</span></span> <span data-ttu-id="5c5f2-170">它会检查实体是否已存在，以及插入该实体，如果它不存在。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-170">It checks if an entity already exists and inserts the entity if it doesn't exist.</span></span> <span data-ttu-id="5c5f2-171">此方法将保留通过使用应用程序 UI 对注册级进行的更改。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-171">This approach will preserve changes you make to an enrollment grade by using the application UI.</span></span> <span data-ttu-id="5c5f2-172">此代码循环访问的每个成员`Enrollment`[列表](https://msdn.microsoft.com/library/6sh2ey19.aspx)和如果数据库中未找到注册，它将注册添加到数据库。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-172">The code loops through each member of the `Enrollment`[List](https://msdn.microsoft.com/library/6sh2ey19.aspx) and if the enrollment is not found in the database, it adds the enrollment to the database.</span></span> <span data-ttu-id="5c5f2-173">第一次更新数据库，数据库将为空，，因此它会将添加每个注册。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-173">The first time you update the database, the database will be empty, so it will add each enrollment.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample7.cs)]
2. <span data-ttu-id="5c5f2-174">生成项目。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-174">Build the project.</span></span>

### <a name="execute-the-first-migration"></a><span data-ttu-id="5c5f2-175">执行第一次迁移</span><span class="sxs-lookup"><span data-stu-id="5c5f2-175">Execute the First Migration</span></span>

<span data-ttu-id="5c5f2-176">当执行`add-migration`命令时，迁移生成将从头开始创建数据库的代码。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-176">When you executed the `add-migration` command, Migrations generated the code that would create the database from scratch.</span></span> <span data-ttu-id="5c5f2-177">此代码也是在*迁移*文件夹中，在名为的文件*&lt;时间戳&gt;\_InitialCreate.cs*。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-177">This code is also in the *Migrations* folder, in the file named *&lt;timestamp&gt;\_InitialCreate.cs*.</span></span> <span data-ttu-id="5c5f2-178">`Up`方法`InitialCreate`类创建对应的数据模型实体集，将数据库表和`Down`方法将其删除。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-178">The `Up` method of the `InitialCreate` class creates the database tables that correspond to the data model entity sets, and the `Down` method deletes them.</span></span>

[!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample8.cs)]

<span data-ttu-id="5c5f2-179">迁移调用 `Up` 方法为迁移实现数据模型更改。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-179">Migrations calls the `Up` method to implement the data model changes for a migration.</span></span> <span data-ttu-id="5c5f2-180">输入用于回退更新的命令时，迁移调用 `Down` 方法。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-180">When you enter a command to roll back the update, Migrations calls the `Down` method.</span></span>

<span data-ttu-id="5c5f2-181">这是你输入时创建的初始迁移`add-migration InitialCreate`命令。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-181">This is the initial migration that was created when you entered the `add-migration InitialCreate` command.</span></span> <span data-ttu-id="5c5f2-182">参数 (`InitialCreate`在示例中) 用于文件命名，并可以是任何所需内容; 你通常要选择的单词或短语，总结了中迁移正在进行的内容。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-182">The parameter (`InitialCreate` in the example) is used for the file name and can be whatever you want; you typically choose a word or phrase that summarizes what is being done in the migration.</span></span> <span data-ttu-id="5c5f2-183">例如，你可能会将更高版本迁移&quot;AddDepartmentTable&quot;。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-183">For example, you might name a later migration &quot;AddDepartmentTable&quot;.</span></span>

<span data-ttu-id="5c5f2-184">如果创建初始迁移时已存在数据库，则会生成数据库创建代码，但此代码不必运行，因为数据库已与数据库模型相匹配。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-184">If you created the initial migration when the database already exists, the database creation code is generated but it doesn't have to run because the database already matches the data model.</span></span> <span data-ttu-id="5c5f2-185">将应用部署到其中尚不存在数据库的其他环境时，此代码将运行以创建数据库，因此最好提前进行测试。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-185">When you deploy the app to another environment where the database doesn't exist yet, this code will run to create your database, so it's a good idea to test it first.</span></span> <span data-ttu-id="5c5f2-186">这也是提前更改连接字符串中数据库的名称的原因，这样迁移才能从头创建新数据库。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-186">That's why you changed the name of the database in the connection string earlier -- so that migrations can create a new one from scratch.</span></span>

1. <span data-ttu-id="5c5f2-187">在**程序包管理器控制台**窗口中，输入以下命令：</span><span class="sxs-lookup"><span data-stu-id="5c5f2-187">In the **Package Manager Console** window, enter the following command:</span></span>

    `update-database`

    ![](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image3.png)

    <span data-ttu-id="5c5f2-188">`update-database`命令将运行`Up`方法，创建数据库然后运行`Seed`方法来填充数据库。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-188">The `update-database` command runs the `Up` method to create the database and then it runs the `Seed` method to populate the database.</span></span> <span data-ttu-id="5c5f2-189">相同的过程后将运行自动在生产中部署应用程序，正如你将看到的下一节中。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-189">The same process will run automatically in production after you deploy the application, as you'll see in the following section.</span></span>
2. <span data-ttu-id="5c5f2-190">使用**服务器资源管理器**以检查数据库，就像在第一个教程中，并运行应用程序以验证所有内容仍适用相同像以前那样。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-190">Use **Server Explorer** to inspect the database as you did in the first tutorial, and run the application to verify that everything still works the same as before.</span></span>

## <a name="deploy-to-azure"></a><span data-ttu-id="5c5f2-191">将部署到 Azure</span><span class="sxs-lookup"><span data-stu-id="5c5f2-191">Deploy to Azure</span></span>

<span data-ttu-id="5c5f2-192">到目前为止应用程序已经运行本地 IIS Express 在开发计算机上。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-192">So far the application has been running locally in IIS Express on your development computer.</span></span> <span data-ttu-id="5c5f2-193">若要使其可供其他人通过 Internet 使用，必须将其部署到 web 宿主提供程序。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-193">To make it available for other people to use over the Internet, you have to deploy it to a web hosting provider.</span></span> <span data-ttu-id="5c5f2-194">在本教程的本部分将将其部署到 Azure。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-194">In this section of the tutorial you'll deploy it to Azure.</span></span> <span data-ttu-id="5c5f2-195">本部分是可选的;你可以跳过此并继续以下教程中，或者你可调整不同的宿主提供程序所选的本部分中说明。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-195">This section is optional; you can skip this and continue with the following tutorial, or you can adapt the instructions in this section for a different hosting provider of your choice.</span></span>

### <a name="using-code-first-migrations-to-deploy-the-database"></a><span data-ttu-id="5c5f2-196">使用 Code First 迁移将数据库部署</span><span class="sxs-lookup"><span data-stu-id="5c5f2-196">Using Code First Migrations to Deploy the Database</span></span>

<span data-ttu-id="5c5f2-197">若要将数据库部署将使用 Code First 迁移。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-197">To deploy the database you'll use Code First Migrations.</span></span> <span data-ttu-id="5c5f2-198">在创建使用从 Visual Studio 部署的配置设置的发布配置文件时，你将选择一个复选框**更新数据库**。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-198">When you create the publish profile that you use to configure settings for deploying from Visual Studio, you'll select a check box labeled **Update Database**.</span></span> <span data-ttu-id="5c5f2-199">此设置会导致自动配置应用程序的部署过程*Web.config*文件在目标服务器上，以便代码优先使用`MigrateDatabaseToLatestVersion`初始值设定项类。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-199">This setting causes the deployment process to automatically configure the application *Web.config* file on the destination server so that Code First uses the `MigrateDatabaseToLatestVersion` initializer class.</span></span>

<span data-ttu-id="5c5f2-200">Visual Studio 不执行任何操作与数据库在部署过程时它正在将你的项目复制到目标服务器。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-200">Visual Studio doesn't do anything with the database during the deployment process while it is copying your project to the destination server.</span></span> <span data-ttu-id="5c5f2-201">当你运行部署的应用程序，它为部署后首次访问数据库时，Code First 检查数据库是否与数据模型匹配。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-201">When you run the deployed application and it accesses the database for the first time after deployment, Code First checks if the database matches the data model.</span></span> <span data-ttu-id="5c5f2-202">如果存在不匹配，Code First 自动创建数据库 （如果它尚不存在） 或 （如果数据库存在，但与模型不匹配） 的最新版本更新数据库架构。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-202">If there's a mismatch, Code First automatically creates the database (if it doesn't exist yet) or updates the database schema to the latest version (if a database exists but doesn't match the model).</span></span> <span data-ttu-id="5c5f2-203">如果应用程序实施迁移`Seed`方法，创建数据库或架构更新后的方法运行。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-203">If the application implements a Migrations `Seed` method, the method runs after the database is created or the schema is updated.</span></span>

<span data-ttu-id="5c5f2-204">迁移过程`Seed`方法插入测试数据。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-204">Your Migrations `Seed` method inserts test data.</span></span> <span data-ttu-id="5c5f2-205">如果你在部署到生产环境，你将必须更改`Seed`方法，以便它只会将你想要插入到你的生产数据库的数据。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-205">If you were deploying to a production environment, you would have to change the `Seed` method so that it only inserts data that you want to be inserted into your production database.</span></span> <span data-ttu-id="5c5f2-206">例如，当前数据模型中你可能想要开发数据库中具有真实课程但虚构学生。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-206">For example, in your current data model you might want to have real courses but fictional students in the development database.</span></span> <span data-ttu-id="5c5f2-207">你可以编写`Seed`加载同时在开发中，并在部署到生产环境之前然后注释虚构学生方法。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-207">You can write a `Seed` method to load both in development, and then comment out the fictional students before you deploy to production.</span></span> <span data-ttu-id="5c5f2-208">也可以编写`Seed`加载仅课程，并使用应用程序的用户界面手动测试数据库中输入虚构学生方法。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-208">Or you can write a `Seed` method to load only courses, and enter the fictional students in the test database manually by using the application's UI.</span></span>

### <a name="get-an-azure-account"></a><span data-ttu-id="5c5f2-209">获取 Azure 帐户</span><span class="sxs-lookup"><span data-stu-id="5c5f2-209">Get an Azure account</span></span>

<span data-ttu-id="5c5f2-210">你将需要一个 Azure 帐户。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-210">You'll need an Azure account.</span></span> <span data-ttu-id="5c5f2-211">如果你还没有一个，但你有 Visual Studio 订阅，你可以[激活您的订阅权益](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/)。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-211">If you don't already have one, but you do have a Visual Studio subscription, you can [activate your subscription benefits](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/).</span></span> <span data-ttu-id="5c5f2-212">否则，可以在几分钟内创建一个免费试用帐户。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-212">Otherwise, you can create a free trial account in just a couple of minutes.</span></span> <span data-ttu-id="5c5f2-213">有关详细信息，请参阅[Azure 免费试用版](https://azure.microsoft.com/free/)。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-213">For details, see [Azure Free Trial](https://azure.microsoft.com/free/).</span></span>

### <a name="create-a-web-site-and-a-sql-database-in-azure"></a><span data-ttu-id="5c5f2-214">在 Azure 中创建网站和 SQL 数据库</span><span class="sxs-lookup"><span data-stu-id="5c5f2-214">Create a web site and a SQL database in Azure</span></span>

<span data-ttu-id="5c5f2-215">你在 Azure 中的 web 应用将共享宿主环境中运行，这意味着它与其他 Azure 客户端共享的虚拟机 (Vm) 上运行。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-215">Your web app in Azure will run in a shared hosting environment, which means it runs on virtual machines (VMs) that are shared with other Azure clients.</span></span> <span data-ttu-id="5c5f2-216">共享宿主环境是在云中开始低成本方法。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-216">A shared hosting environment is a low-cost way to get started in the cloud.</span></span> <span data-ttu-id="5c5f2-217">更高版本，如果你的 web 流量增加，应用程序可以缩放以满足需要通过在专用 Vm 上运行。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-217">Later, if your web traffic increases, the application can scale to meet the need by running on dedicated VMs.</span></span> <span data-ttu-id="5c5f2-218">若要了解为 Azure App Service 定价选项的详细信息，请阅读该文档上[Azure 文档](https://azure.microsoft.com/pricing/details/app-service/)</span><span class="sxs-lookup"><span data-stu-id="5c5f2-218">To learn more about Pricing Options for Azure App Service, read the documentation on [Azure Docs](https://azure.microsoft.com/pricing/details/app-service/)</span></span>

<span data-ttu-id="5c5f2-219">你将部署到 Azure SQL 数据库的数据库。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-219">You'll deploy the database to Azure SQL Database.</span></span> <span data-ttu-id="5c5f2-220">SQL 数据库是根据 SQL Server 技术构建的基于云的关系数据库服务。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-220">SQL Database is a cloud-based relational database service that is built on SQL Server technologies.</span></span> <span data-ttu-id="5c5f2-221">工具和应用程序使用 SQL Server 还处理 SQL 数据库。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-221">Tools and applications that work with SQL Server also work with SQL Database.</span></span>

1. <span data-ttu-id="5c5f2-222">在[Azure 管理门户](https://portal.azure.com)，单击**新建**在左侧选项卡中，单击**查看所有**在新的边栏选项卡，然后单击**Web 应用和 SQL**中**Web**部分和最后**创建**。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-222">In the [Azure Management Portal](https://portal.azure.com), click **New** in the left tab, click **See all** in new blade, and then click **Web App & SQL** in the **Web** Section and finally **Create**.</span></span>

    ![在管理门户中的新按钮](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/CreateWeb-Sql.png)

   <span data-ttu-id="5c5f2-224">**新的 Web 应用和 SQL-创建**向导随即打开。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-224">The **New Web App & SQL - Create** wizard opens.</span></span>

2. <span data-ttu-id="5c5f2-225">在边栏选项卡，输入中的字符串**应用名称**框，以用作你的应用程序的唯一 URL。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-225">In the blade, enter a string in the **App name** box to use as the unique URL for your application.</span></span> <span data-ttu-id="5c5f2-226">完整的 URL 将包含你在此处输入的 Azure 应用程序服务的默认域 plus 的 (。 azurewebsites.net)。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-226">The complete URL will consist of what you enter here plus the default domain of Azure App Services (.azurewebsites.net).</span></span> <span data-ttu-id="5c5f2-227">如果**应用名称**已被使用，该向导将通知你这些带有红色*应用程序名称不可用*消息。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-227">If the **App name** is already taken, the Wizard will notify you of this with a red *The app name is not available* message.</span></span> <span data-ttu-id="5c5f2-228">如果**应用名称**是可用，你将获得一个绿色复选标记。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-228">If the **App name** is available, you will get a green checkmark.</span></span>

    ![创建包含在管理门户中的数据库链接](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Create-WebApp.png)

3. <span data-ttu-id="5c5f2-230">在**订阅**下拉列表中，请选择要在其中的 Azure 订阅**App Service**驻留。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-230">In the **Subscription** Dropdown, please choose the Azure Subscription in which you want the **App Service** to reside.</span></span>

4. <span data-ttu-id="5c5f2-231">在**资源组**文本框中，选择一个资源组或创建一个新。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-231">In the **Resource Group** text box, choose a Resource Group or create a new one.</span></span> <span data-ttu-id="5c5f2-232">此设置指定您的网站将运行在哪个数据中心。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-232">This setting specifies which data center your web site will run in.</span></span> <span data-ttu-id="5c5f2-233">有关资源组的详细信息，请继续阅读文档[Azure 文档](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-overview#resource-groups)。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-233">For more information about Resource Groups, read the documentation on [Azure Docs](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-overview#resource-groups).</span></span>
5. <span data-ttu-id="5c5f2-234">创建一个新**App Service 计划**通过单击*App Service 部分*，**新建**，并填写**App Service 计划**（可以是相同的名称应用程序服务），**位置**，和**定价层**（没有可用的选项）。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-234">Create a new **App Service Plan** by clicking the *App Service section*, **Create New**, and fill in **App Service plan** (can be same name as App Service), **Location**, and **Pricing tier** (there is a free option).</span></span>

    ![](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Create-AppService.png)
6. <span data-ttu-id="5c5f2-235">单击**SQL 数据库**，然后选择*新建*或选择现有数据库</span><span class="sxs-lookup"><span data-stu-id="5c5f2-235">Click the **SQL Database**, and choose *Create New* or select an existing database</span></span>

    ![](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Create-Database.png)

7. <span data-ttu-id="5c5f2-236">在**名称**框中，输入你的数据库的名称。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-236">In the **Name** box, enter a name for your database.</span></span>
8. <span data-ttu-id="5c5f2-237">单击**目标服务器**框中，选择**创建新的服务器**。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-237">Click the **Target Server** box, select **Create a new server**.</span></span> <span data-ttu-id="5c5f2-238">或者，如果你以前创建的服务器，你可以从可用服务器列表中选择该服务器。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-238">Alternatively, if you previously created a server, you can select that server from list of available servers.</span></span>
9. <span data-ttu-id="5c5f2-239">选择**定价层**部分中，选择*免费*。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-239">Choose **Pricing tier** section, choose *Free*.</span></span> <span data-ttu-id="5c5f2-240">如果需要其他资源，数据库可以扩展至在任何时间。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-240">If additional resources are needed, the database can be scaled up at any time.</span></span> <span data-ttu-id="5c5f2-241">若要了解有关 Azure SQL 定价的更多信息，请阅读该文档上[Azure 文档](https://azure.microsoft.com/pricing/details/sql-database/)。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-241">To learn more on Azure SQL Pricing, read the documentation on [Azure Docs](https://azure.microsoft.com/pricing/details/sql-database/).</span></span>
10. <span data-ttu-id="5c5f2-242">修改[排序规则](https://docs.microsoft.com/sql/relational-databases/collations/collation-and-unicode-support)根据需要。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-242">Modify [collation](https://docs.microsoft.com/sql/relational-databases/collations/collation-and-unicode-support) as needed.</span></span>
11. <span data-ttu-id="5c5f2-243">输入管理员**SQL 管理员用户名**和**SQL 管理员密码**。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-243">Enter an administrator **SQL Admin Username** and **SQL Admin Password**.</span></span> <span data-ttu-id="5c5f2-244">如果你选择**新建 SQL 数据库服务器**，不要输入现有名称和密码在此处，你应输入新名称和密码，你现在定义以后访问数据库时使用。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-244">If you selected **New SQL Database server**, you aren't entering an existing name and password here, you're entering a new name and password that you're defining now to use later when you access the database.</span></span> <span data-ttu-id="5c5f2-245">如果你选择你之前创建的服务器，你将为该服务器输入凭据。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-245">If you selected a server that you created previously, you'll enter credentials for that server.</span></span>
12. <span data-ttu-id="5c5f2-246">可以为 App Service 中使用 Application Insights 启用遥测数据收集。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-246">Telemetry collection can be enabled for App Service using Application Insights.</span></span> <span data-ttu-id="5c5f2-247">与配置少的 application Insights 收集有价值的事件、 异常、 依赖项、 请求和跟踪信息。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-247">Application Insights with little configuration collects valuable event, exception, dependency, request, and trace information.</span></span> <span data-ttu-id="5c5f2-248">若要了解有关 Application Insights 的详细信息，开始[Azure 文档](https://azure.microsoft.com/services/application-insights/)。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-248">To learn more about Application Insights, get started in [Azure Docs](https://azure.microsoft.com/services/application-insights/).</span></span>
13. <span data-ttu-id="5c5f2-249">单击**创建**底部的边栏选项卡，以指示你已完成。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-249">Click **Create** at the bottom of the blade to indicate that you're finished.</span></span>
  
    <span data-ttu-id="5c5f2-250">管理门户返回到仪表板页上，与**通知**边栏选项卡页顶部显示正在创建网站。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-250">The Management Portal returns to the Dashboards page, and the **Notifications** blade at the top of the page shows that the site is being created.</span></span> <span data-ttu-id="5c5f2-251">（通常小于一分钟），一段时间后将部署成功的通知。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-251">After a while (typically less than a minute), there will be a notification that the Deployment succeeded.</span></span> <span data-ttu-id="5c5f2-252">在左侧的导航栏中的新**App Service**出现在*应用程序服务*部分和新**SQL 数据库**出现在*SQL 数据库*部分。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-252">In the navigation bar at the left, the new **App Service** appears in the *App Services* section and the new **SQL Database** appears in the *SQL Databases* section.</span></span>

### <a name="deploy-the-application-to-azure"></a><span data-ttu-id="5c5f2-253">部署到 Azure 应用程序</span><span class="sxs-lookup"><span data-stu-id="5c5f2-253">Deploy the application to Azure</span></span>

1. <span data-ttu-id="5c5f2-254">在 Visual Studio 中，右键单击中的项目**解决方案资源管理器**和选择**发布**从上下文菜单。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-254">In Visual Studio, right-click the project in **Solution Explorer** and select **Publish** from the context menu.</span></span>
  
    ![在项目上下文菜单中发布](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image10.png)
2. <span data-ttu-id="5c5f2-256">在**配置文件**选项卡**发布 Web**向导中，单击**Microsoft Azure App Service**。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-256">In the **Profile** tab of the **Publish Web** wizard, click **Microsoft Azure App Service**.</span></span>
  
    ![导入发布设置](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-ChooseTarget.png)
3. <span data-ttu-id="5c5f2-258">如果之前未添加你的 Azure 订阅在 Visual Studio 中，在屏幕上执行步骤。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-258">If you have not previously added your Azure subscription in Visual Studio, perform the steps on the screen.</span></span> <span data-ttu-id="5c5f2-259">这些步骤启用 Visual Studio 以连接到你的 Azure 订阅因此，该列表的**应用程序服务**将包括您的网站。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-259">These steps enable Visual Studio to connect to your Azure subscription so that the list of **App Services** will include your web site.</span></span>
 
4. <span data-ttu-id="5c5f2-260">选择**订阅**App Service 添加到，然后**App Service 计划**App Service 是的一部分的文件夹和最后**App Service**本身跟**确定**。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-260">Select the **Subscription** you added the App Service to, then the **App Service Plan** folder your App Service is a part of, and finally the **App Service** itself followed by **Ok**.</span></span>

    ![选择 App Service](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-AppService.png)
5. <span data-ttu-id="5c5f2-262">在配置配置文件后，**连接**将显示选项卡。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-262">After the Profile has been configured, the **Connection** tab will be shown.</span></span> <span data-ttu-id="5c5f2-263">单击**验证连接**若要确保设置正确无误</span><span class="sxs-lookup"><span data-stu-id="5c5f2-263">Click **Validate Connection** to make sure that the settings are correct</span></span>

    ![验证连接](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-Connection.png)
6. <span data-ttu-id="5c5f2-265">在验证连接后，旁边出现一个绿色的复选标记**验证连接**按钮。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-265">When the connection has been validated, a green check mark is shown next to the **Validate Connection** button.</span></span> <span data-ttu-id="5c5f2-266">单击 **“下一步”**。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-266">Click **Next**.</span></span>
  
    ![已成功验证的连接](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-SettingsValidated.png)
7. <span data-ttu-id="5c5f2-268">打开**远程连接字符串**下的下拉列表**SchoolContext** ，然后选择你创建的数据库的连接字符串。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-268">Open the **Remote connection string** drop-down list under **SchoolContext** and select the connection string for the database you created.</span></span>
8. <span data-ttu-id="5c5f2-269">选择**更新数据库**。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-269">Select **Update database**.</span></span>

    ![设置选项卡](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-Settings.png)

    <span data-ttu-id="5c5f2-271">此设置会导致自动配置应用程序的部署过程*Web.config*文件在目标服务器上，以便代码优先使用`MigrateDatabaseToLatestVersion`初始值设定项类。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-271">This setting causes the deployment process to automatically configure the application *Web.config* file on the destination server so that Code First uses the `MigrateDatabaseToLatestVersion` initializer class.</span></span>
9. <span data-ttu-id="5c5f2-272">单击 **“下一步”**。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-272">Click **Next**.</span></span>
10. <span data-ttu-id="5c5f2-273">在**预览**选项卡上，单击**开始预览**。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-273">In the **Preview** tab, click **Start Preview**.</span></span>
  
    ![预览选项卡中的开始预览按钮](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-Preview.png)
  
    <span data-ttu-id="5c5f2-275">选项卡显示将复制到服务器的文件列表。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-275">The tab displays a list of the files that will be copied to the server.</span></span> <span data-ttu-id="5c5f2-276">显示预览不需要发布应用程序但有用的功能，需要注意。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-276">Displaying the preview isn't required to publish the application but is a useful function to be aware of.</span></span> <span data-ttu-id="5c5f2-277">在这种情况下，你不必使用显示的文件列表执行任何操作。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-277">In this case, you don't need to do anything with the list of files that is displayed.</span></span> <span data-ttu-id="5c5f2-278">下次部署此应用程序，仅将已更改的文件将在此列表中。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-278">The next time you deploy this application, only the files that have changed will be in this list.</span></span>
    <span data-ttu-id="5c5f2-279">![开始预览文件输出](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-PreviewLoaded.png)</span><span class="sxs-lookup"><span data-stu-id="5c5f2-279">![StartPreview file output](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-PreviewLoaded.png)</span></span>

11. <span data-ttu-id="5c5f2-280">单击“发布” 。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-280">Click **Publish**.</span></span>
    <span data-ttu-id="5c5f2-281">Visual Studio 开始将文件复制到 Azure 的服务器的过程。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-281">Visual Studio begins the process of copying the files to the Azure server.</span></span>
12. <span data-ttu-id="5c5f2-282">**输出**窗口将显示已执行的部署操作并报告已成功完成的部署。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-282">The **Output** window shows what deployment actions were taken and reports successful completion of the deployment.</span></span>
  
    ![输出窗口报告部署成功](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-BuildOutput.png)
13. <span data-ttu-id="5c5f2-284">成功部署后，默认浏览器自动打开指向已部署的 web 站点的 URL。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-284">Upon successful deployment, the default browser automatically opens to the URL of the deployed web site.</span></span>
    <span data-ttu-id="5c5f2-285">你创建的应用程序现在在云中运行。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-285">The application you created is now running in the cloud.</span></span> 
  
    ![Students_index_page_with_paging](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-Site.png)

<span data-ttu-id="5c5f2-287">此时你*SchoolContext*已在 Azure SQL 数据库中创建了数据库由于你选择了**执行 Code First 迁移 （在应用启动时运行）**。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-287">At this point your *SchoolContext* database has been created in the Azure SQL Database because you selected **Execute Code First Migrations (runs on app start)**.</span></span> <span data-ttu-id="5c5f2-288">*Web.config*已部署的 web 站点中的文件已更改，以便[MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx)初始值设定项运行你的代码读取或写入数据库 （这种情况中的数据的第一个时间如果选择**学生**选项卡上):</span><span class="sxs-lookup"><span data-stu-id="5c5f2-288">The *Web.config* file in the deployed web site has been changed so that the [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) initializer runs the first time your code reads or writes data in the database (which happened when you selected the **Students** tab):</span></span>

![](https://asp.net/media/4367421/mig.png)

<span data-ttu-id="5c5f2-289">在部署过程还创建新的连接字符串 *(SchoolContext\_DatabasePublish*) 的代码优先迁移来用于更新数据库架构和数据库进行种子设定。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-289">The deployment process also created a new connection string *(SchoolContext\_DatabasePublish*) for Code First Migrations to use for updating the database schema and seeding the database.</span></span>

![Database_Publish 连接字符串](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image26.png)

<span data-ttu-id="5c5f2-291">您可以找到在你自己的计算机上的 Web.config 文件的已部署的版本*ContosoUniversity\obj\Release\Package\PackageTmp\Web.config*。你可以访问部署*Web.config*文件本身通过使用 FTP。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-291">You can find the deployed version of the Web.config file on your own computer in *ContosoUniversity\obj\Release\Package\PackageTmp\Web.config*. You can access the deployed *Web.config* file itself by using FTP.</span></span> <span data-ttu-id="5c5f2-292">有关说明，请参阅[使用 Visual Studio 的 ASP.NET Web 部署： 部署某一代码更新](xref:web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-code-update)。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-292">For instructions, see [ASP.NET Web Deployment using Visual Studio: Deploying a Code Update](xref:web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-code-update).</span></span> <span data-ttu-id="5c5f2-293">按照以开头的说明"若要使用 FTP 工具，需要以下三项： 的 FTP URL、 用户名和密码。"</span><span class="sxs-lookup"><span data-stu-id="5c5f2-293">Follow the instructions that start with "To use an FTP tool, you need three things: the FTP URL, the user name, and the password."</span></span>

> [!NOTE]
> <span data-ttu-id="5c5f2-294">Web 应用未实现安全，因此任何找到的 URL 的人都可以更改的数据。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-294">The web app doesn't implement security, so anyone who finds the URL can change the data.</span></span> <span data-ttu-id="5c5f2-295">有关如何确保网站的安全的说明，请参阅[将包含成员资格、 OAuth 和 SQL 数据库的安全 ASP.NET MVC 应用程序部署到 Azure](https://docs.microsoft.com/aspnet/core/security/authorization/secure-data)。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-295">For instructions on how to secure the web site, see [Deploy a Secure ASP.NET MVC app with Membership, OAuth, and SQL Database to Azure](https://docs.microsoft.com/aspnet/core/security/authorization/secure-data).</span></span> <span data-ttu-id="5c5f2-296">可以使用 Azure 管理门户中使用该站点中阻止其他人或**服务器资源管理器**Visual Studio 停止该站点中。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-296">You can prevent other people from using the site by using the Azure Management Portal or **Server Explorer** in Visual Studio to stop the site.</span></span>


![](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Stop-Service.png)

## <a name="advanced-migrations-scenarios"></a><span data-ttu-id="5c5f2-297">高级的迁移方案</span><span class="sxs-lookup"><span data-stu-id="5c5f2-297">Advanced Migrations Scenarios</span></span>

<span data-ttu-id="5c5f2-298">如果将数据库部署通过自动本教程中所示运行迁移，并且您要部署到多个服务器运行的网站，你可以获得多个服务器尝试在同一时间运行迁移。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-298">If you deploy a database by running migrations automatically as shown in this tutorial, and you are deploying to a web site that runs on multiple servers, you could get multiple servers trying to run migrations at the same time.</span></span> <span data-ttu-id="5c5f2-299">迁移是原子性的，因此如果两个服务器尝试运行相同的迁移，一个将成功，并且另将失败 （假设不能两次执行的操作）。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-299">Migrations are atomic, so if two servers try to run the same migration, one will succeed and the other will fail (assuming the operations can't be done twice).</span></span> <span data-ttu-id="5c5f2-300">在这种情况下如果你想要避免这些问题，可以手动调用迁移并设置你自己的代码，以便它只发生一次。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-300">In that scenario if you want to avoid those issues, you can call migrations manually and set up your own code so that it only happens once.</span></span> <span data-ttu-id="5c5f2-301">有关详细信息，请参阅[运行和代码中的脚本迁移](http://romiller.com/2012/02/09/running-scripting-migrations-from-code/)Rowan Miller 博客上和[Migrate.exe](https://msdn.microsoft.com/data/jj618307) （用于从命令行执行迁移） MSDN 上。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-301">For more information, see [Running and Scripting Migrations from Code](http://romiller.com/2012/02/09/running-scripting-migrations-from-code/) on Rowan Miller's blog and [Migrate.exe](https://msdn.microsoft.com/data/jj618307) (for executing migrations from the command line) on MSDN.</span></span>

<span data-ttu-id="5c5f2-302">有关其他迁移方案的信息，请参阅[迁移段视频系列](https://blogs.msdn.com/b/adonet/archive/2014/03/12/migrations-screencast-series.aspx)。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-302">For information about other migrations scenarios, see [Migrations Screencast Series](https://blogs.msdn.com/b/adonet/archive/2014/03/12/migrations-screencast-series.aspx).</span></span>

## <a name="code-first-initializers"></a><span data-ttu-id="5c5f2-303">代码 First 初始值设定项</span><span class="sxs-lookup"><span data-stu-id="5c5f2-303">Code First Initializers</span></span>

<span data-ttu-id="5c5f2-304">在部署部分你已看到[MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx)正在使用的初始值设定项。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-304">In the deployment section you saw the [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) initializer being used.</span></span> <span data-ttu-id="5c5f2-305">代码首先还提供其他初始值设定项，包括[CreateDatabaseIfNotExists](https://msdn.microsoft.com/library/gg679221(v=vs.103).aspx) （默认值）、 [DropCreateDatabaseIfModelChanges](https://msdn.microsoft.com/library/gg679604(v=VS.103).aspx) （它使用更早版本） 和[DropCreateDatabaseAlways](https://msdn.microsoft.com/library/gg679506(v=VS.103).aspx)。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-305">Code First also provides other initializers, including [CreateDatabaseIfNotExists](https://msdn.microsoft.com/library/gg679221(v=vs.103).aspx) (the default), [DropCreateDatabaseIfModelChanges](https://msdn.microsoft.com/library/gg679604(v=VS.103).aspx) (which you used earlier) and [DropCreateDatabaseAlways](https://msdn.microsoft.com/library/gg679506(v=VS.103).aspx).</span></span> <span data-ttu-id="5c5f2-306">`DropCreateAlways`初始值设定项可用于设置单元测试的条件。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-306">The `DropCreateAlways` initializer can be useful for setting up conditions for unit tests.</span></span> <span data-ttu-id="5c5f2-307">你还可以编写你自己初始值设定项，并且如果不想等待，直到应用程序从读取或写入数据库，你可以显式调用初始值设定项。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-307">You can also write your own initializers, and you can call an initializer explicitly if you don't want to wait until the application reads from or writes to the database.</span></span> <span data-ttu-id="5c5f2-308">在本教程在 2013 年 11 月正在编写时你可以只使用创建和 DropCreate 初始值设定项之前启用迁移。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-308">At the time this tutorial is being written in November, 2013, you can only use the Create and DropCreate initializers before you enable migrations.</span></span> <span data-ttu-id="5c5f2-309">实体框架团队正致力于使这些初始值设定项可使用以及迁移。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-309">The Entity Framework team is working on making these initializers usable with migrations as well.</span></span>

<span data-ttu-id="5c5f2-310">有关初始值设定项的详细信息，请参阅[了解数据库初始值设定项中 Entity Framework Code First](http://www.codeguru.com/csharp/article.php/c19999/Understanding-Database-Initializers-in-Entity-Framework-Code-First.htm)和书籍的第 6 章[编程实体框架： Code First](http://shop.oreilly.com/product/0636920022220.do)通过 Julie Lerman和 Rowan Miller。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-310">For more information about initializers, see [Understanding Database Initializers in Entity Framework Code First](http://www.codeguru.com/csharp/article.php/c19999/Understanding-Database-Initializers-in-Entity-Framework-Code-First.htm) and chapter 6 of the book [Programming Entity Framework: Code First](http://shop.oreilly.com/product/0636920022220.do) by Julie Lerman and Rowan Miller.</span></span>

## <a name="summary"></a><span data-ttu-id="5c5f2-311">总结</span><span class="sxs-lookup"><span data-stu-id="5c5f2-311">Summary</span></span>

<span data-ttu-id="5c5f2-312">在本教程中，你已了解如何启用迁移和部署应用程序。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-312">In this tutorial you've seen how to enable migrations and deploy the application.</span></span> <span data-ttu-id="5c5f2-313">在下一教程将首先通过展开数据模型来查看更高级的主题。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-313">In the next tutorial you'll begin looking at more advanced topics by expanding the data model.</span></span>

<span data-ttu-id="5c5f2-314">请在如何喜欢本教程的方式，我们可以提高上，留下反馈。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-314">Please leave feedback on how you liked this tutorial and what we could improve.</span></span> <span data-ttu-id="5c5f2-315">你还可以请求新主题[教我编写代码](http://aspnet.uservoice.com/forums/228522-show-me-how-with-code)。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-315">You can also request new topics at [Show Me How With Code](http://aspnet.uservoice.com/forums/228522-show-me-how-with-code).</span></span>

<span data-ttu-id="5c5f2-316">在找不到其他实体框架资源的链接[ASP.NET 数据访问的推荐资源](xref:whitepapers/aspnet-data-access-content-map)。</span><span class="sxs-lookup"><span data-stu-id="5c5f2-316">Links to other Entity Framework resources can be found in [ASP.NET Data Access - Recommended Resources](xref:whitepapers/aspnet-data-access-content-map).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="5c5f2-317">[上一页](xref:mvc/overview/getting-started/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application)
> [下一页](xref:mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-a-more-complex-data-model-for-an-asp-net-mvc-application)</span><span class="sxs-lookup"><span data-stu-id="5c5f2-317">[Previous](xref:mvc/overview/getting-started/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application)
[Next](xref:mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-a-more-complex-data-model-for-an-asp-net-mvc-application)</span></span>
