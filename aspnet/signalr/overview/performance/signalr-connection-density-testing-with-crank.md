---
uid: signalr/overview/performance/signalr-connection-density-testing-with-crank
title: "使用曲柄测试 SignalR 连接密度 |Microsoft 文档"
author: tfitzmac
description: "使用曲柄测试 SignalR 连接密度"
ms.author: aspnetcontent
manager: wpickett
ms.date: 02/22/2015
ms.topic: article
ms.assetid: 148d9ca7-1af1-44b6-a9fb-91e261b9b463
ms.technology: dotnet-signalr
ms.prod: .net-framework
msc.legacyurl: /signalr/overview/performance/signalr-connection-density-testing-with-crank
msc.type: authoredcontent
ms.openlocfilehash: a3e8fdb47bd80d819358f9c48cd82fd51d6c0400
ms.sourcegitcommit: fe880bf4ed1c8116071c0e47c0babf3623b7f44a
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/21/2017
---
<a name="signalr-connection-density-testing-with-crank"></a><span data-ttu-id="79e56-103">使用曲柄测试 SignalR 连接密度</span><span class="sxs-lookup"><span data-stu-id="79e56-103">SignalR Connection Density Testing with Crank</span></span>
====================
<span data-ttu-id="79e56-104">通过[Tom FitzMacken](https://github.com/tfitzmac)</span><span class="sxs-lookup"><span data-stu-id="79e56-104">by [Tom FitzMacken](https://github.com/tfitzmac)</span></span>

> <span data-ttu-id="79e56-105">本文介绍如何使用曲柄工具来测试与多个模拟客户端应用程序。</span><span class="sxs-lookup"><span data-stu-id="79e56-105">This article describes how to use the Crank tool to test an application with multiple simulated clients.</span></span>


<span data-ttu-id="79e56-106">后在其宿主环境 （任一 Azure web 角色，IIS，或使用 Owin 自承载） 中运行你的应用程序，你可以测试应用程序的响应使用曲柄工具连接密度的高级别。</span><span class="sxs-lookup"><span data-stu-id="79e56-106">Once your application is running in its hosting environment (either an Azure web role, IIS, or self-hosted using Owin), you can test application's response to a high level of connection density using the Crank tool.</span></span> <span data-ttu-id="79e56-107">宿主环境可以是 Internet 信息服务 (IIS) 服务器、 Owin 主机或 Azure web 角色。</span><span class="sxs-lookup"><span data-stu-id="79e56-107">The hosting environment can be an Internet Information Services (IIS) server, an Owin host, or an Azure web role.</span></span> <span data-ttu-id="79e56-108">(注意： 性能计数器不可在 Azure App Service Web Apps，因此你将无法从连接密度测试获取性能数据。)</span><span class="sxs-lookup"><span data-stu-id="79e56-108">(Note: Performance counters are not available on Azure App Service Web Apps, so you will not be able to get performance data from a connection density test.)</span></span>

<span data-ttu-id="79e56-109">连接密度是指可以在服务器建立的并发 TCP 连接数。</span><span class="sxs-lookup"><span data-stu-id="79e56-109">Connection Density refers to the number of simultaneous TCP connections that can be established on a server.</span></span> <span data-ttu-id="79e56-110">每个 TCP 连接可能会产生其自己的开销，并打开大量的空闲连接将最终创建内存瓶颈。</span><span class="sxs-lookup"><span data-stu-id="79e56-110">Each TCP connection incurs its own overhead, and opening a large number of idle connections will eventually create a memory bottleneck.</span></span>

<span data-ttu-id="79e56-111">[SignalR 基本代码](https://github.com/signalr/signalr)包括一个名为负载测试工具**Crank**。</span><span class="sxs-lookup"><span data-stu-id="79e56-111">[The SignalR codebase](https://github.com/signalr/signalr) includes a load-testing tool called **Crank**.</span></span> <span data-ttu-id="79e56-112">在找不到最新版本的曲柄[Dev 分支](https://github.com/SignalR/signalr/tree/dev)GitHub 上。</span><span class="sxs-lookup"><span data-stu-id="79e56-112">The latest version of Crank can be found in [the Dev branch](https://github.com/SignalR/signalr/tree/dev) on GitHub.</span></span> <span data-ttu-id="79e56-113">你可以下载的 Zip 存档 SignalR 的 Dev 分支的基本代码[此处](https://github.com/SignalR/SignalR/archive/dev.zip)。</span><span class="sxs-lookup"><span data-stu-id="79e56-113">You can download a Zip archive of the Dev branch of the SignalR codebase [here](https://github.com/SignalR/SignalR/archive/dev.zip).</span></span>

<span data-ttu-id="79e56-114">曲柄可能用于完全 saturate 服务器的内存以便计算可能服务器硬件上的空闲连接的总数。</span><span class="sxs-lookup"><span data-stu-id="79e56-114">Crank may be used to fully saturate the server's memory in order to calculate the total number of idle connections possible on the server hardware.</span></span> <span data-ttu-id="79e56-115">或者，你可能还用于曲柄负载测试了一定数量的内存压力下的服务器通过掌握连接，直至达到特定计数或特定内存阈值。</span><span class="sxs-lookup"><span data-stu-id="79e56-115">Alternatively, you may also use Crank to load test the server under a certain amount of memory pressure, by ramping up connections until a specific count or a specific memory threshold is reached.</span></span>

<span data-ttu-id="79e56-116">在测试时，务必使用远程客户端以避免任何竞争的资源 （即 TCP 连接和内存）。</span><span class="sxs-lookup"><span data-stu-id="79e56-116">When testing, it is important to use remote client(s) to avoid any competition for resources (i.e., TCP connections and memory).</span></span> <span data-ttu-id="79e56-117">监视客户端以确保它们不会命中可能会阻止服务器达到其完整的容量 （内存或 CPU） 任何瓶颈。</span><span class="sxs-lookup"><span data-stu-id="79e56-117">Monitor the client(s) to ensure that they are not hitting any bottlenecks that may prevent the server from reaching its full capacity (memory or CPU).</span></span> <span data-ttu-id="79e56-118">你可能需要增加才能完全加载服务器的客户端的数量。</span><span class="sxs-lookup"><span data-stu-id="79e56-118">You may need to increase the number of clients in order to fully load the server.</span></span>

### <a name="running-a-connection-density-test"></a><span data-ttu-id="79e56-119">运行连接密度测试</span><span class="sxs-lookup"><span data-stu-id="79e56-119">Running a Connection Density Test</span></span>

<span data-ttu-id="79e56-120">本部分介绍 SignalR 应用程序上运行连接密度测试所需的步骤。</span><span class="sxs-lookup"><span data-stu-id="79e56-120">This section describes the steps needed to run a connection density test on a SignalR application.</span></span>

1. <span data-ttu-id="79e56-121">下载并构建[SignalR 的开发分支的基本代码](https://github.com/SignalR/SignalR/archive/dev.zip)。</span><span class="sxs-lookup"><span data-stu-id="79e56-121">Download and build the [Dev branch of the SignalR codebase](https://github.com/SignalR/SignalR/archive/dev.zip).</span></span> <span data-ttu-id="79e56-122">在命令提示符，导航到&lt;项目目录&gt;\src\Microsoft.AspNet.SignalR.Crank\bin\debug。</span><span class="sxs-lookup"><span data-stu-id="79e56-122">In a command prompt, navigate to &lt;project directory&gt;\src\Microsoft.AspNet.SignalR.Crank\bin\debug.</span></span>
2. <span data-ttu-id="79e56-123">应用程序部署到其预期的宿主环境。</span><span class="sxs-lookup"><span data-stu-id="79e56-123">Deploy your application to its intended hosting environment.</span></span> <span data-ttu-id="79e56-124">记下你的应用程序使用; 终结点例如，在中创建的应用程序[入门教程](../getting-started/tutorial-getting-started-with-signalr.md)，终结点是`http://<yourhost>:8080/signalr`。</span><span class="sxs-lookup"><span data-stu-id="79e56-124">Make a note of the endpoint that your application uses; for example, in the application created in the [Getting Started tutorial](../getting-started/tutorial-getting-started-with-signalr.md), the endpoint is `http://<yourhost>:8080/signalr`.</span></span>
3. <span data-ttu-id="79e56-125">安装[SignalR 性能计数器](signalr-performance.md#perfcounters)服务器上。</span><span class="sxs-lookup"><span data-stu-id="79e56-125">Install [SignalR performance counters](signalr-performance.md#perfcounters) on the server.</span></span> <span data-ttu-id="79e56-126">如果在 Azure 上运行你的应用程序，请参阅[Azure Web 角色中使用 SignalR 性能计数器](using-signalr-performance-counters-in-an-azure-web-role.md)。</span><span class="sxs-lookup"><span data-stu-id="79e56-126">If your application is running on Azure, see [Using SignalR Performance Counters in an Azure Web Role](using-signalr-performance-counters-in-an-azure-web-role.md).</span></span>

<span data-ttu-id="79e56-127">一旦你已下载和生成的基本代码，并在主机上安装性能计数器，可以在找到曲柄命令行工具`src\Microsoft.AspNet.SignalR.Crank\bin\Debug`文件夹。</span><span class="sxs-lookup"><span data-stu-id="79e56-127">Once you've downloaded and built the codebase, and installed performance counters on your host, the Crank command-line tool can be found in the `src\Microsoft.AspNet.SignalR.Crank\bin\Debug` folder.</span></span>

<span data-ttu-id="79e56-128">曲柄工具的可用选项包括：</span><span class="sxs-lookup"><span data-stu-id="79e56-128">Available options for the Crank tool include:</span></span>

- <span data-ttu-id="79e56-129">**/?**： 显示帮助屏幕。</span><span class="sxs-lookup"><span data-stu-id="79e56-129">**/?**: Shows the help screen.</span></span> <span data-ttu-id="79e56-130">如果也会显示可用选项**Url**省略参数。</span><span class="sxs-lookup"><span data-stu-id="79e56-130">The available options are also displayed if the **Url** parameter is omitted.</span></span>
- <span data-ttu-id="79e56-131">**/ Url**: SignalR 连接的 URL。</span><span class="sxs-lookup"><span data-stu-id="79e56-131">**/Url**: The URL for SignalR connections.</span></span> <span data-ttu-id="79e56-132">此参数是必需的。</span><span class="sxs-lookup"><span data-stu-id="79e56-132">This parameter is required.</span></span> <span data-ttu-id="79e56-133">使用默认映射 SignalR 的应用程序的情况下，路径将以结束"/ signalr"。</span><span class="sxs-lookup"><span data-stu-id="79e56-133">For a SignalR application using the default mapping, the path will end in "/signalr".</span></span>
- <span data-ttu-id="79e56-134">**/ 传输**： 所使用的传输的名称。</span><span class="sxs-lookup"><span data-stu-id="79e56-134">**/Transport**: The name of the transport used.</span></span> <span data-ttu-id="79e56-135">默认值是`auto`，这将选择最佳的可用的协议。</span><span class="sxs-lookup"><span data-stu-id="79e56-135">The default is `auto`, which will select the best available protocol.</span></span> <span data-ttu-id="79e56-136">选项包括`WebSockets`， `ServerSentEvents`，和`LongPolling`(`ForeverFrame`不是选项曲柄，因为.NET 客户端，而不使用 Internet Explorer)。</span><span class="sxs-lookup"><span data-stu-id="79e56-136">Options include `WebSockets`, `ServerSentEvents`, and `LongPolling` (`ForeverFrame` is not an option for Crank, since the .NET client rather than Internet Explorer is used).</span></span> <span data-ttu-id="79e56-137">有关 SignalR 如何选择传输的详细信息，请参阅[传输和回退](../getting-started/introduction-to-signalr.md#transports)。</span><span class="sxs-lookup"><span data-stu-id="79e56-137">For more information on how SignalR selects transports, see [Transports and Fallbacks](../getting-started/introduction-to-signalr.md#transports).</span></span>
- <span data-ttu-id="79e56-138">**/ BatchSize**： 添加每个批中的客户端的数量。</span><span class="sxs-lookup"><span data-stu-id="79e56-138">**/BatchSize**: The number of clients added in each batch.</span></span> <span data-ttu-id="79e56-139">默认值为 50。</span><span class="sxs-lookup"><span data-stu-id="79e56-139">The default is 50.</span></span>
- <span data-ttu-id="79e56-140">**/ ConnectInterval**: 间隔 （毫秒） 之间添加连接。</span><span class="sxs-lookup"><span data-stu-id="79e56-140">**/ConnectInterval**: The interval in milliseconds between adding connections.</span></span> <span data-ttu-id="79e56-141">默认值为 500。</span><span class="sxs-lookup"><span data-stu-id="79e56-141">The default is 500.</span></span>
- <span data-ttu-id="79e56-142">**/ 连接**： 用于负载测试应用程序的连接数。</span><span class="sxs-lookup"><span data-stu-id="79e56-142">**/Connections**: The number of connections used to load-test the application.</span></span> <span data-ttu-id="79e56-143">默认值为 100,000。</span><span class="sxs-lookup"><span data-stu-id="79e56-143">The default is 100,000.</span></span>
- <span data-ttu-id="79e56-144">**/ ConnectTimeout**： 秒，然后中止测试的超时。</span><span class="sxs-lookup"><span data-stu-id="79e56-144">**/ConnectTimeout**: The timeout in seconds before aborting the test.</span></span> <span data-ttu-id="79e56-145">默认值为 300。</span><span class="sxs-lookup"><span data-stu-id="79e56-145">The default is 300.</span></span>
- <span data-ttu-id="79e56-146">**MinServerMBytes**： 来访问的最小服务器兆字节。</span><span class="sxs-lookup"><span data-stu-id="79e56-146">**MinServerMBytes**: The minimum server megabytes to reach.</span></span> <span data-ttu-id="79e56-147">默认值为 500。</span><span class="sxs-lookup"><span data-stu-id="79e56-147">The default is 500.</span></span>
- <span data-ttu-id="79e56-148">**SendBytes**： 发送到服务器以字节为单位的负载的大小。</span><span class="sxs-lookup"><span data-stu-id="79e56-148">**SendBytes**: The size of the payload sent to the server in bytes.</span></span> <span data-ttu-id="79e56-149">默认值为 0。</span><span class="sxs-lookup"><span data-stu-id="79e56-149">The default is 0.</span></span>
- <span data-ttu-id="79e56-150">**SendInterval**： 延迟的消息与服务器之间的毫秒数。</span><span class="sxs-lookup"><span data-stu-id="79e56-150">**SendInterval**: The delay in milliseconds between messages to the server.</span></span> <span data-ttu-id="79e56-151">默认值为 500。</span><span class="sxs-lookup"><span data-stu-id="79e56-151">The default is 500.</span></span>
- <span data-ttu-id="79e56-152">**SendTimeout**： 超时以毫秒为单位的到服务器的消息。</span><span class="sxs-lookup"><span data-stu-id="79e56-152">**SendTimeout**: The timeout in milliseconds for messages to the server.</span></span> <span data-ttu-id="79e56-153">默认值为 300。</span><span class="sxs-lookup"><span data-stu-id="79e56-153">The default is 300.</span></span>
- <span data-ttu-id="79e56-154">**ControllerUrl**： 其中一台客户端将承载的控制器集线器的 Url。</span><span class="sxs-lookup"><span data-stu-id="79e56-154">**ControllerUrl**: The Url where one client will host a controller hub.</span></span> <span data-ttu-id="79e56-155">默认值为 null （无控制器中心）。</span><span class="sxs-lookup"><span data-stu-id="79e56-155">The default is null (no controller hub).</span></span> <span data-ttu-id="79e56-156">时曲柄会话启动; 启动控制器中心没有任何进一步进行控制器中心和曲柄之间的联系。</span><span class="sxs-lookup"><span data-stu-id="79e56-156">The controller hub is started when the Crank session starts; no further contact between the controller hub and Crank is made.</span></span>
- <span data-ttu-id="79e56-157">**NumClients**： 模拟客户端连接到应用程序的数量。</span><span class="sxs-lookup"><span data-stu-id="79e56-157">**NumClients**: The number of simulated clients to connect to the application.</span></span> <span data-ttu-id="79e56-158">默认值为一个。</span><span class="sxs-lookup"><span data-stu-id="79e56-158">The default is one.</span></span>
- <span data-ttu-id="79e56-159">**日志文件**： 为测试运行日志文件的文件名。</span><span class="sxs-lookup"><span data-stu-id="79e56-159">**Logfile**: The filename for the logfile for the test run.</span></span> <span data-ttu-id="79e56-160">默认值为 `crank.csv`。</span><span class="sxs-lookup"><span data-stu-id="79e56-160">The default is `crank.csv`.</span></span>
- <span data-ttu-id="79e56-161">**SampleInterval**： 的时间性能计数器样本之间的毫秒。</span><span class="sxs-lookup"><span data-stu-id="79e56-161">**SampleInterval**: The time in milliseconds between performance counter samples.</span></span> <span data-ttu-id="79e56-162">默认值为 1000。</span><span class="sxs-lookup"><span data-stu-id="79e56-162">The default is 1000.</span></span>
- <span data-ttu-id="79e56-163">**SignalRInstance**： 服务器上的性能计数器的实例名称。</span><span class="sxs-lookup"><span data-stu-id="79e56-163">**SignalRInstance**: The instance name for the performance counters on the server.</span></span> <span data-ttu-id="79e56-164">默认值是使用客户端连接状态。</span><span class="sxs-lookup"><span data-stu-id="79e56-164">The default is to use the client connection state.</span></span>

### <a name="example"></a><span data-ttu-id="79e56-165">示例</span><span class="sxs-lookup"><span data-stu-id="79e56-165">Example</span></span>

<span data-ttu-id="79e56-166">以下命令将测试名的网站`pfsignalr`在 Azure 上承载使用名为"ControllerHub"集线器端口 8080 上的应用程序，使用 100 个连接。</span><span class="sxs-lookup"><span data-stu-id="79e56-166">The following command will test a site called `pfsignalr` on Azure that hosts an application on port 8080 with a hub named "ControllerHub", using 100 connections.</span></span>

`crank /Connections:100 /Url:http://pfsignalr.cloudapp.net:8080/signalr`
